diff --git a/app/(tabs)/director.tsx b/app/(tabs)/director.tsx
index 13ee7af..68ecc1f 100644
--- a/app/(tabs)/director.tsx
+++ b/app/(tabs)/director.tsx
@@ -1,7 +1,9 @@
 // app/(tabs)/director.tsx тАФ ╨╡╨┤╨╕╨╜╤Л╨╣ ╨▒╨╗╨╛╨║ ┬л╨Ю╨╢╨╕╨┤╨░╨╡╤В ╤Г╤В╨▓╨╡╤А╨╢╨┤╨╡╨╜╨╕╤П (╨┐╤А╨╛╤А╨░╨▒)┬╗, ╨С╨Х╨Ч ╨╜╨╕╨╢╨╜╨╡╨│╨╛ ╨▒╨╗╨╛╨║╨░ ┬л╤И╨░╨┐╨╛╨║┬╗
 import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
-import { View, Text, FlatList, Pressable, Alert, ActivityIndicator,
-  RefreshControl, Platform, TextInput, Animated, Linking, InteractionManager } from 'react-native';
+import {
+  View, Text, FlatList, Pressable, Alert, ActivityIndicator,
+  RefreshControl, Platform, TextInput, Animated, Linking, InteractionManager
+} from 'react-native';
 
 import { openSignedUrlUniversal } from "../../src/lib/files";
 import { UI, s } from "../../src/screens/director/director.styles";
@@ -52,6 +54,8 @@ import { Ionicons } from '@expo/vector-icons';
 import SendPrimaryButton from "../../src/ui/SendPrimaryButton";
 import DeleteAllButton from "../../src/ui/DeleteAllButton";
 import RejectItemButton from "../../src/ui/RejectItemButton";
+import CloseIconButton from "../../src/ui/CloseIconButton";
+import { showToast } from "../../src/ui/toast";
 import DirectorFinanceCardModal from "../../src/screens/director/DirectorFinanceCardModal";
 import DirectorFinanceDebtModal from "../../src/screens/director/DirectorFinanceDebtModal";
 import DirectorFinanceSpendModal from "../../src/screens/director/DirectorFinanceSpendModal";
@@ -60,806 +64,910 @@ import DirectorFinanceSupplierModal from "../../src/screens/director/DirectorFin
 
 
 export default function DirectorScreen() {
-    const busy = useGlobalBusy();
-const insets = useSafeAreaInsets();
-const [tab, setTab] = useState<Tab>('foreman');
-
-const [dirTab, setDirTab] = useState<DirTopTab>("╨Ч╨░╤П╨▓╨║╨╕");
-
-type FinPage = "home" | "debt" | "spend" | "kind" | "supplier";
-
-const [finOpen, setFinOpen] = useState(false);
-const [finPage, setFinPage] = useState<FinPage>("home");
-
-// ╤Б╤В╨╡╨║ ╤Б╤В╤А╨░╨╜╨╕╤Ж ╨┤╨╗╤П "╨╜╨░╨╖╨░╨┤"
-const finStackRef = useRef<FinPage[]>(["home"]);
-const pushFin = useCallback((p: FinPage) => {
-  finStackRef.current = [...finStackRef.current, p];
-  setFinPage(p);
-}, []);
-const popFin = useCallback(() => {
-  const s = finStackRef.current.slice(0, -1);
-  finStackRef.current = s.length ? s : ["home"];
-  setFinPage(finStackRef.current[finStackRef.current.length - 1] || "home");
-}, []);
-
-const [finSupplier, setFinSupplier] = useState<FinSupplierDebt | null>(null);
-
-const [finLoading, setFinLoading] = useState(false);
-const [finRows, setFinRows] = useState<FinanceRow[]>([]);
-const [finSpendRows, setFinSpendRows] = useState<any[]>([]);
-const [finRep, setFinRep] = useState<FinRep>(() => computeFinanceRep([], { dueDaysDefault: 7, criticalDays: 14 }));
-const [finPeriodOpen, setFinPeriodOpen] = useState(false);
-const [finFrom, setFinFrom] = useState<string | null>(null);
-const [finTo, setFinTo] = useState<string | null>(null);
-
-type RepTab = "materials" | "discipline";
-
-type RepRow = {
-  rik_code: string;
-  uom: string;
-  qty_total: number;
-  docs_cnt: number;
-  qty_without_request: number;
-  docs_without_request: number;
-};
-
-type RepWho = { who: string; items_cnt: number };
-
-type RepKpi = {
-  issues_total: number;
-  issues_without_object: number;
-  items_total: number;
-  items_without_request: number;
-};
-
-type RepPayload = {
-  meta?: { from?: string; to?: string; object_name?: string | null };
-  kpi?: RepKpi;
-  rows?: RepRow[];
-  discipline_who?: RepWho[];
-};
-
-const [repOpen, setRepOpen] = useState(false);
-const [repTab, setRepTab] = useState<RepTab>("materials");
-const [repPeriodOpen, setRepPeriodOpen] = useState(false);
-const [repObjOpen, setRepObjOpen] = useState(false);
-const [repFrom, setRepFrom] = useState<string | null>(null);
-const [repTo, setRepTo] = useState<string | null>(null);
-const [repObjectName, setRepObjectName] = useState<string | null>(null); // ╨┐╨╛╨║╨░ null = ╨▓╤Б╨╡
-
-const [repLoading, setRepLoading] = useState(false);
-const [repData, setRepData] = useState<RepPayload | null>(null);
-const [repOptLoading, setRepOptLoading] = useState(false);
-const [repOptObjects, setRepOptObjects] = useState<string[]>([]);
-
-const isoDate = (d: Date) => {
-    const yyyy = d.getFullYear();
-  const mm = String(d.getMonth() + 1).padStart(2, "0");
-  const dd = String(d.getDate()).padStart(2, "0");
-  return `${yyyy}-${mm}-${dd}`;
-};
-
-const minusDays = (days: number) => {
-  const d = new Date();
-  d.setDate(d.getDate() - days);
-  return d;
-};
-
-useEffect(() => {
-  if (repFrom || repTo) return;
-  const to = isoDate(new Date());
-  const from = isoDate(minusDays(30));
-  setRepFrom(from);
-  setRepTo(to);
-}, [repFrom, repTo]);
-
-const repPeriodShort = useMemo(() => {
-  return repFrom || repTo
-    ? `${repFrom ? fmtDateOnly(repFrom) : "тАФ"} тЖТ ${repTo ? fmtDateOnly(repTo) : "тАФ"}`
-    : "╨Я╨╛╤Б╨╗╨╡╨┤╨╜╨╕╨╡ 30 ╨┤╨╜╨╡╨╣";
-}, [repFrom, repTo]);
-const applyObjectFilter = useCallback(async (obj: string | null) => {
-  setRepObjectName(obj);
-
-  const from = repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30));
-  const to = repTo ? String(repTo).slice(0, 10) : isoDate(new Date());
-
-  setRepLoading(true);
-  try {
-    const { data, error } = await supabase.rpc("rpc_wh_report_issued_by_req_context_v2", {
-      p_from: from,
-      p_to: to,
-      p_object_name: obj, 
-      p_level_code: null,
-      p_system_code: null,
-      p_zone_code: null,
-    });
-    if (error) throw error;
-
-    const payload = (data ?? null) as any;
-    setRepData(payload && typeof payload === "object" ? payload : null);
-  } catch (e: any) {
-    console.warn("[director] applyObjectFilter:", e?.message ?? e);
-    setRepData(null);
-    Alert.alert("╨Ю╤В╤З╤С╤В╤Л", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨┐╨╡╤А╨╡╤Б╤З╨╕╤В╨░╤В╤М ╨╛╤В╤З╤С╤В");
-  } finally {
-    setRepLoading(false);
-  }
-}, [repFrom, repTo, supabase]);
-
-const fetchReport = useCallback(async () => {
-  const from = repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30));
-  const to = repTo ? String(repTo).slice(0, 10) : isoDate(new Date());
-
-  setRepLoading(true);
-  try {
-    const { data, error } = await supabase.rpc("rpc_wh_report_issued_by_req_context_v2", {
-      p_from: from,
-      p_to: to,
-      p_object_name: repObjectName,   
-      p_level_code: null,
-      p_system_code: null,
-      p_zone_code: null,
-    });
+  const busy = useGlobalBusy();
+  const insets = useSafeAreaInsets();
+  const notifyInfo = useCallback((title: string, message?: string) => {
+    showToast.info(title, message);
+  }, []);
+  const notifyError = useCallback((title: string, message?: string) => {
+    showToast.error(title, message);
+  }, []);
+  const [tab, setTab] = useState<Tab>('foreman');
 
-    if (error) throw error;
+  const [dirTab, setDirTab] = useState<DirTopTab>("╨Ч╨░╤П╨▓╨║╨╕");
 
-    const payload = (data ?? null) as any;
-    setRepData(payload && typeof payload === "object" ? payload : null);
-  } catch (e: any) {
-    console.warn("[director] fetchReport:", e?.message ?? e);
-    setRepData(null);
-    Alert.alert("╨Ю╤В╤З╤С╤В╤Л", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨┐╨╛╨╗╤Г╤З╨╕╤В╤М ╨╛╤В╤З╤С╤В");
-  } finally {
-    setRepLoading(false);
-  }
-}, [repFrom, repTo, repObjectName]);
+  type FinPage = "home" | "debt" | "spend" | "kind" | "supplier";
 
-const fetchReportOptions = useCallback(async () => {
-  const from = repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30));
-  const to = repTo ? String(repTo).slice(0, 10) : isoDate(new Date());
+  const [finOpen, setFinOpen] = useState(false);
+  const [finPage, setFinPage] = useState<FinPage>("home");
 
-  setRepOptLoading(true);
-  try {
-    const { data, error } = await supabase.rpc("rpc_wh_report_req_context_options", {
-      p_from: from,
-      p_to: to,
-    });
-    if (error) throw error;
-
-    const objects = Array.isArray((data as any)?.objects) ? (data as any).objects : [];
-    setRepOptObjects(objects.map((x: any) => String(x ?? "").trim()).filter(Boolean));
-  } catch (e: any) {
-    console.warn("[director] fetchReportOptions:", e?.message ?? e);
-    setRepOptObjects([]);
-  } finally {
-    setRepOptLoading(false);
-  }
-}, [repFrom, repTo]);
-const applyReportPeriod = useCallback(async (nextFrom: string | null, nextTo: string | null) => {
-  setRepFrom(nextFrom);
-  setRepTo(nextTo);
-  setRepObjectName(null);
-  setRepPeriodOpen(false);
-
- const from = (nextFrom ? String(nextFrom).slice(0, 10) : isoDate(minusDays(30)));
-  const to = (nextTo ? String(nextTo).slice(0, 10) : isoDate(new Date()));
-
-  setRepOptLoading(true);
-  setRepLoading(true);
-  try {
-    
-    const opt = await supabase.rpc("rpc_wh_report_req_context_options", { p_from: from, p_to: to });
-if (opt.error) throw opt.error;
-const objects = Array.isArray((opt.data as any)?.objects) ? (opt.data as any).objects : [];
-
-console.log("OPTIONS RAW:", opt.data);
-console.log("OBJECTS ARRAY:", objects);
-
-setRepOptObjects(objects.map((x: any) => String(x ?? "").trim()).filter(Boolean));
-
-    const rep = await supabase.rpc("rpc_wh_report_issued_by_req_context_v2", {
-      p_from: from,
-      p_to: to,
-      p_object_name: null,
-      p_level_code: null,
-      p_system_code: null,
-      p_zone_code: null,
-    });
-    if (rep.error) throw rep.error;
-    const payload = (rep.data ?? null) as any;
-    setRepData(payload && typeof payload === "object" ? payload : null);
-  } catch (e: any) {
-    console.warn("[director] applyReportPeriod:", e?.message ?? e);
-    setRepData(null);
-    setRepOptObjects([]);
-    Alert.alert("╨Ю╤В╤З╤С╤В╤Л", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨┐╨╡╤А╨╡╤Б╤З╨╕╤В╨░╤В╤М ╨╛╤В╤З╤С╤В");
-  } finally {
-    setRepOptLoading(false);
-    setRepLoading(false);
-  }
-}, []);
-
-const openReports = useCallback(async () => {
-  setRepOpen(true);
-  setRepTab("materials");
-  try {
-    await fetchReportOptions();
-  } catch {}
-  try {
-    await fetchReport();
-  } catch {}
-}, [fetchReportOptions, fetchReport]);
-
-
-const closeReports = useCallback(() => {
-  setRepOpen(false);
-  setRepPeriodOpen(false);
-}, []);
-
-
-const FIN_DUE_DAYS_DEFAULT = 7;
-const FIN_CRITICAL_DAYS = 14;
-const [finKindName, setFinKindName] = useState<string>("");
-const [finKindList, setFinKindList] = useState<any[]>([]);
-const mountedRef = useRef(true);
-useEffect(() => {
-  return () => { mountedRef.current = false; };
-}, []);
-
-const openSupplier = useCallback((s: any) => {
-   const supplierName = (() => {
-  if (typeof s === "string") return s.trim() || "тАФ";
-    const v =
-    s?.supplier?.supplier ??   
-    s?.supplier ??             
-    s?.name ??                
-    "";
-  return String(v).trim() || "тАФ";
-})();
-
-const kindName = (() => {
-  if (typeof s === "string") return "";
-  const v = s?._kindName ?? s?.kindName ?? "";
-  return String(v).trim();
-})();
-
-  const inPeriod = (iso: any) => {
-    const d = String(iso ?? "").slice(0, 10);
-    if (!d) return true;
-    if (finFrom && d < String(finFrom).slice(0, 10)) return false;
-    if (finTo && d > String(finTo).slice(0, 10)) return false;
-    return true;
+  // ╤Б╤В╨╡╨║ ╤Б╤В╤А╨░╨╜╨╕╤Ж ╨┤╨╗╤П "╨╜╨░╨╖╨░╨┤"
+  const finStackRef = useRef<FinPage[]>(["home"]);
+  const pushFin = useCallback((p: FinPage) => {
+    finStackRef.current = [...finStackRef.current, p];
+    setFinPage(p);
+  }, []);
+  const popFin = useCallback(() => {
+    const s = finStackRef.current.slice(0, -1);
+    finStackRef.current = s.length ? s : ["home"];
+    setFinPage(finStackRef.current[finStackRef.current.length - 1] || "home");
+  }, []);
+
+  const [finSupplier, setFinSupplier] = useState<FinSupplierDebt | null>(null);
+
+  const [finLoading, setFinLoading] = useState(false);
+  const [finRows, setFinRows] = useState<FinanceRow[]>([]);
+  const [finSpendRows, setFinSpendRows] = useState<any[]>([]);
+  const [finRep, setFinRep] = useState<FinRep>(() => computeFinanceRep([], { dueDaysDefault: 7, criticalDays: 14 }));
+  const [finPeriodOpen, setFinPeriodOpen] = useState(false);
+  const [finFrom, setFinFrom] = useState<string | null>(null);
+  const [finTo, setFinTo] = useState<string | null>(null);
+
+  type RepTab = "materials" | "discipline";
+
+  type RepRow = {
+    rik_code: string;
+    uom: string;
+    qty_total: number;
+    docs_cnt: number;
+    qty_without_request: number;
+    docs_without_request: number;
   };
 
-  let allowedProposalIds: Set<string> | null = null;
-  const proposalNoById: Record<string, string> = {};
+  type RepWho = { who: string; items_cnt: number };
 
-  if (kindName) {
-    const spend = (Array.isArray(finSpendRows) ? finSpendRows : [])
-      .filter((r: any) => String(r?.supplier ?? "").trim() === supplierName)
-      .filter((r: any) => String(r?.kind_name ?? "").trim() === kindName)
-      .filter((r: any) => inPeriod(r?.director_approved_at ?? r?.approved_at ?? r?.approvedAtIso));
+  type RepKpi = {
+    issues_total: number;
+    issues_without_object: number;
+    items_total: number;
+    items_without_request: number;
+  };
 
-    allowedProposalIds = new Set(
-      spend.map((r: any) => String(r?.proposal_id ?? "").trim()).filter(Boolean)
-    );
+  type RepPayload = {
+    meta?: { from?: string; to?: string; object_name?: string | null };
+    kpi?: RepKpi;
+    rows?: RepRow[];
+    discipline_who?: RepWho[];
+  };
 
-    for (const r of spend) {
-      const pid = String(r?.proposal_id ?? "").trim();
-      const pno = String(r?.proposal_no ?? "").trim();
-      if (pid && pno) proposalNoById[pid] = pno;
-    }
-  }
+  const [repOpen, setRepOpen] = useState(false);
+  const [repTab, setRepTab] = useState<RepTab>("materials");
+  const [repPeriodOpen, setRepPeriodOpen] = useState(false);
+  const [repObjOpen, setRepObjOpen] = useState(false);
+  const [repFrom, setRepFrom] = useState<string | null>(null);
+  const [repTo, setRepTo] = useState<string | null>(null);
+  const [repObjectName, setRepObjectName] = useState<string | null>(null); // ╨┐╨╛╨║╨░ null = ╨▓╤Б╨╡
 
-  const fin = (Array.isArray(finRows) ? finRows : [])
-    .filter((r: any) => String(r?.supplier ?? "").trim() === supplierName)
-    .filter((r: any) => inPeriod(r?.approvedAtIso ?? r?.approved_at ?? r?.director_approved_at))
-    .filter((r: any) => {
-      if (!allowedProposalIds) return true;
-      const pid = String(r?.proposalId ?? r?.proposal_id ?? "").trim();
-      return pid && allowedProposalIds.has(pid);
-    });
+  const [repLoading, setRepLoading] = useState(false);
+  const [repData, setRepData] = useState<RepPayload | null>(null);
+  const [repOptLoading, setRepOptLoading] = useState(false);
+  const [repOptObjects, setRepOptObjects] = useState<string[]>([]);
+
+  const isoDate = (d: Date) => {
+    const yyyy = d.getFullYear();
+    const mm = String(d.getMonth() + 1).padStart(2, "0");
+    const dd = String(d.getDate()).padStart(2, "0");
+    return `${yyyy}-${mm}-${dd}`;
+  };
 
-  const t0 = mid(new Date());
-  const dueDays = FIN_DUE_DAYS_DEFAULT;
+  const minusDays = (days: number) => {
+    const d = new Date();
+    d.setDate(d.getDate() - days);
+    return d;
+  };
 
-const pickIso = (...vals: any[]) => {
-  for (const v of vals) {
-    const s = String(v ?? "").trim();
-    if (!s) continue;
-    return s.slice(0, 10);
-  }
-  return null;
-};
-
-const pickApprovedIso = (r: any) =>
-  pickIso(
-    r?.approvedAtIso,
-    r?.director_approved_at,
-    r?.approved_at,
-    r?.approvedAt,
-    r?.approved_at_iso
+  useEffect(() => {
+    if (repFrom || repTo) return;
+    const to = isoDate(new Date());
+    const from = isoDate(minusDays(30));
+    setRepFrom(from);
+    setRepTo(to);
+  }, [repFrom, repTo]);
+
+  const repPeriodShort = useMemo(() => {
+    return repFrom || repTo
+      ? `${repFrom ? fmtDateOnly(repFrom) : "тАФ"} тЖТ ${repTo ? fmtDateOnly(repTo) : "тАФ"}`
+      : "╨Я╨╛╤Б╨╗╨╡╨┤╨╜╨╕╨╡ 30 ╨┤╨╜╨╡╨╣";
+  }, [repFrom, repTo]);
+  const REPORT_ALL_FROM = "1970-01-01T00:00:00.000Z";
+  const REPORT_ALL_TO = "2100-01-01T23:59:59.999Z";
+
+  const reportRpcRange = useCallback((fromRaw?: string | null, toRaw?: string | null) => {
+    const from = String(fromRaw ?? "").trim();
+    const to = String(toRaw ?? "").trim();
+    if (!from && !to) return { fromIso: REPORT_ALL_FROM, toIso: REPORT_ALL_TO };
+    return {
+      fromIso: from ? `${from}T00:00:00.000Z` : REPORT_ALL_FROM,
+      toIso: to ? `${to}T23:59:59.999Z` : REPORT_ALL_TO,
+    };
+  }, []);
+
+  const loadDirectorWarehouseReport = useCallback(
+    async (fromRaw?: string | null, toRaw?: string | null, objectName?: string | null) => {
+      const { fromIso, toIso } = reportRpcRange(fromRaw, toRaw);
+
+      const byObjRes = await supabase.rpc("wh_report_issued_by_object_fast", {
+        p_from: fromIso,
+        p_to: toIso,
+        p_object_id: null,
+      } as any);
+      if (byObjRes.error) throw byObjRes.error;
+      const byObjRows = Array.isArray(byObjRes.data) ? (byObjRes.data as any[]) : [];
+
+      const issuedObjectNames = Array.from(
+        new Set(byObjRows.map((r: any) => String(r?.object_name ?? "").trim()).filter(Boolean))
+      );
+
+      // ╨Я╨╗╤О╤Б╤Г╨╡╨╝ ╨╛╨▒╤К╨╡╨║╤В╤Л ╨╕╨╖ ╨▒╨╗╨╛╨║╨░ "╨а╨░╤Б╤Е╨╛╨┤ ╨┐╨╛ ╨╖╨░╤П╨▓╨║╨░╨╝", ╤З╤В╨╛╨▒╤Л ╤Б╨┐╨╕╤Б╨╛╨║ ╨╛╨▒╤К╨╡╨║╤В╨╛╨▓ ╨▒╤Л╨╗ ╨┐╨╛╨╗╨╜╤Л╨╝.
+      // KPI ╨┐╤А╨╕ ╤Н╤В╨╛╨╝ ╨╛╤Б╤В╨░╤О╤В╤Б╤П ╤В╨╛╨╗╤М╨║╨╛ ╨┐╨╛ ╤Д╨░╨║╤В╤Г ╨▓╤Л╨┤╨░╤З╨╕.
+      const reqHeadsRes = await supabase
+        .from("v_wh_issue_req_heads_ui" as any)
+        .select("object_name, issue_status")
+        .limit(1000);
+      const reqObjectNames = Array.isArray((reqHeadsRes as any)?.data)
+        ? ((reqHeadsRes as any).data as any[])
+          .filter((x: any) => String(x?.issue_status ?? "").trim().toUpperCase() !== "DONE")
+          .map((x: any) => String(x?.object_name ?? "").trim())
+          .filter(Boolean)
+        : [];
+
+      const uniqueObjectNames = Array.from(new Set([...issuedObjectNames, ...reqObjectNames]));
+      setRepOptObjects(uniqueObjectNames);
+
+      // ╨Ч╨░╨┐╤А╨░╤И╨╕╨▓╨░╨╡╨╝ ID ╨╛╨▒╤К╨╡╨║╤В╨╛╨▓ ╨╕╨╖ ╨▒╨░╨╖╤Л ╨╜╨░╨┐╤А╤П╨╝╤Г╤О, ╤В.╨║. RPC wh_report_issued_by_object_fast 
+      // ╨╝╨╛╨╢╨╡╤В ╨▓╨╛╨╖╨▓╤А╨░╤Й╨░╤В╤М null ╨┤╨╗╤П object_id
+      const objectsRes = await supabase.from('objects').select('id, name');
+      const objectIdByName: Record<string, string> = {};
+      if (!objectsRes.error && Array.isArray(objectsRes.data)) {
+        objectsRes.data.forEach((o: any) => {
+          const name = String(o?.name ?? "").trim();
+          const id = String(o?.id ?? "").trim();
+          if (name && id) objectIdByName[name] = id;
+        });
+      }
+      const objectNameNorm = objectName ? String(objectName).trim() : "";
+      const objectId = objectNameNorm ? (objectIdByName[objectNameNorm] || null) : null;
+
+      // ╨Х╤Б╨╗╨╕ ╨▓╤Л╨▒╤А╨░╨╜ ╨╛╨▒╤К╨╡╨║╤В, ╨║╨╛╤В╨╛╤А╤Л╨╣ ╨╡╤Б╤В╤М ╤В╨╛╨╗╤М╨║╨╛ ╨▓ "╨а╨░╤Б╤Е╨╛╨┤/╨╖╨░╤П╨▓╨║╨╕", ╨╜╨╛ ╨▓╤Л╨┤╨░╤З ╨┐╨╛ ╨╜╨╡╨╝╤Г ╨╜╨╡╤В,
+      // ╨╛╤В╨┤╨░╤С╨╝ ╨╜╤Г╨╗╨╡╨▓╨╛╨╣ ╨╛╤В╤З╤С╤В (╨░ ╨╜╨╡ ╨╛╨▒╤Й╨╕╨╣).
+      if (objectNameNorm && !objectId) {
+        notifyInfo(
+          "╨д╨░╨║╤В ╨▓╤Л╨┤╨░╤З╨╕",
+          "╨Я╨╛ ╨▓╤Л╨▒╤А╨░╨╜╨╜╨╛╨╝╤Г ╨╛╨▒╤К╨╡╨║╤В╤Г ╨▓ ╤Н╤В╨╛╨╝ ╨┐╨╡╤А╨╕╨╛╨┤╨╡ ╨╜╨╡╤В ╤Д╨░╨║╤В╨╕╤З╨╡╤Б╨║╨╕╤Е ╨▓╤Л╨┤╨░╤З. ╨Ю╨▒╤К╨╡╨║╤В ╨╡╤Б╤В╤М ╨▓ ╤А╨░╤Б╤Е╨╛╨┤╨╡/╨╖╨░╤П╨▓╨║╨░╤Е."
+        );
+        setRepData({
+          kpi: { issues_total: 0, issues_without_object: 0, items_total: 0, items_without_request: 0 },
+          rows: [],
+          discipline_who: [],
+        });
+        return;
+      }
+
+      const [materialsRes, summaryRes] = await Promise.all([
+        supabase.rpc("wh_report_issued_materials_fast", {
+          p_from: fromIso,
+          p_to: toIso,
+          p_object_id: objectId,
+        } as any),
+        supabase.rpc("wh_report_issued_summary_fast", {
+          p_from: fromIso,
+          p_to: toIso,
+          p_object_id: objectId,
+        } as any),
+      ]);
+      if (materialsRes.error) throw materialsRes.error;
+      if (summaryRes.error) throw summaryRes.error;
+
+      const materialRows = Array.isArray(materialsRes.data) ? (materialsRes.data as any[]) : [];
+      const summaryRow = Array.isArray(summaryRes.data) && summaryRes.data.length > 0
+        ? (summaryRes.data[0] as any)
+        : ((summaryRes.data as any) || {});
+
+      const isWithoutObject = (v: any) => {
+        const s = String(v ?? "").trim().toLowerCase();
+        return s === "╨▒╨╡╨╖ ╨╛╨▒╤К╨╡╨║╤В╨░" || s === "╨▒╨╡╨╖ ╨╛╨▒╤М╨╡╨║╤В╨░" || !s;
+      };
+
+      const filteredByObjRows = objectName
+        ? byObjRows.filter((r: any) => String(r?.object_name ?? "").trim() === String(objectName).trim())
+        : byObjRows;
+
+      const issuesWithoutObject = objectName
+        ? 0
+        : filteredByObjRows.reduce((acc: number, r: any) => {
+          if (!isWithoutObject(r?.object_name)) return acc;
+          return acc + Number(r?.docs_cnt ?? 0);
+        }, 0);
+
+      const rows: RepRow[] = materialRows.map((r: any) => ({
+        rik_code: String(r?.material_name ?? r?.material_code ?? "").trim() || String(r?.material_code ?? "").trim(),
+        uom: String(r?.uom ?? "").trim(),
+        qty_total: Number(r?.sum_total ?? 0),
+        docs_cnt: Number(r?.docs_cnt ?? 0),
+        qty_without_request: Number(r?.sum_free ?? 0),
+        docs_without_request: 0,
+      }));
+
+      const disciplineMap = new Map<string, number>();
+      for (const r of filteredByObjRows) {
+        const key = String((r as any)?.work_name ?? "").trim() || "╨С╨╡╨╖ ╨▓╨╕╨┤╨░ ╤А╨░╨▒╨╛╤В";
+        const prev = disciplineMap.get(key) ?? 0;
+        disciplineMap.set(key, prev + Number((r as any)?.lines_cnt ?? 0));
+      }
+      const discipline_who: RepWho[] = Array.from(disciplineMap.entries())
+        .map(([who, items_cnt]) => ({ who, items_cnt }))
+        .sort((a, b) => b.items_cnt - a.items_cnt);
+
+      const kpi: RepKpi = {
+        issues_total: Number(summaryRow?.docs_total ?? 0),
+        issues_without_object: Number(issuesWithoutObject || 0),
+        items_total: Number(summaryRow?.lines_total ?? 0),
+        items_without_request: Number(summaryRow?.lines_free ?? 0),
+      };
+
+      setRepData({ kpi, rows, discipline_who });
+    },
+    [reportRpcRange]
   );
 
-const pickInvoiceIso = (r: any) =>
-  pickIso(r?.invoiceDate, r?.invoice_date, r?.invoiceIso, r?.invoice_at, r?.created_at, r?.raw?.created_at);
+  const applyObjectFilter = useCallback(async (obj: string | null) => {
+    setRepObjectName(obj);
+    setRepLoading(true);
+    try {
+      await loadDirectorWarehouseReport(
+        repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30)),
+        repTo ? String(repTo).slice(0, 10) : isoDate(new Date()),
+        obj
+      );
+    } catch (e: any) {
+      console.warn("[director] applyObjectFilter:", e?.message ?? e);
+      setRepData(null);
+      notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+    } finally {
+      setRepLoading(false);
+    }
+  }, [repFrom, repTo, loadDirectorWarehouseReport]);
+
+  const fetchReport = useCallback(async () => {
+    setRepLoading(true);
+    try {
+      await loadDirectorWarehouseReport(
+        repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30)),
+        repTo ? String(repTo).slice(0, 10) : isoDate(new Date()),
+        repObjectName
+      );
+    } catch (e: any) {
+      console.warn("[director] fetchReport:", e?.message ?? e);
+      setRepData(null);
+      notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+    } finally {
+      setRepLoading(false);
+    }
+  }, [repFrom, repTo, repObjectName, loadDirectorWarehouseReport]);
+
+  const fetchReportOptions = useCallback(async () => {
+    setRepOptLoading(true);
+    try {
+      await loadDirectorWarehouseReport(
+        repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30)),
+        repTo ? String(repTo).slice(0, 10) : isoDate(new Date()),
+        repObjectName
+      );
+    } catch (e: any) {
+      console.warn("[director] fetchReportOptions:", e?.message ?? e);
+      setRepOptObjects([]);
+    } finally {
+      setRepOptLoading(false);
+    }
+  }, [repFrom, repTo, repObjectName, loadDirectorWarehouseReport]);
+
+  const applyReportPeriod = useCallback(async (nextFrom: string | null, nextTo: string | null) => {
+    setRepFrom(nextFrom);
+    setRepTo(nextTo);
+    setRepObjectName(null);
+    setRepPeriodOpen(false);
+    setRepOptLoading(true);
+    setRepLoading(true);
+    try {
+      await loadDirectorWarehouseReport(
+        nextFrom ? String(nextFrom).slice(0, 10) : isoDate(minusDays(30)),
+        nextTo ? String(nextTo).slice(0, 10) : isoDate(new Date()),
+        null
+      );
+    } catch (e: any) {
+      console.warn("[director] applyReportPeriod:", e?.message ?? e);
+      setRepData(null);
+      setRepOptObjects([]);
+      notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+    } finally {
+      setRepOptLoading(false);
+      setRepLoading(false);
+    }
+  }, [loadDirectorWarehouseReport]);
 
+  const openReports = useCallback(async () => {
+    setRepOpen(true);
+    setRepTab("materials");
+    setRepLoading(true);
+    try {
+      await loadDirectorWarehouseReport(
+        repFrom ? String(repFrom).slice(0, 10) : isoDate(minusDays(30)),
+        repTo ? String(repTo).slice(0, 10) : isoDate(new Date()),
+        repObjectName
+      );
+    } catch (e: any) {
+      console.warn("[director] openReports:", (e as any)?.message ?? e);
+    } finally {
+      setRepLoading(false);
+    }
+  }, [repFrom, repTo, repObjectName, loadDirectorWarehouseReport]);
+  const closeReports = useCallback(() => {
+    setRepOpen(false);
+    setRepPeriodOpen(false);
+  }, []);
 
-const pickAmount = (r: any) =>
-  nnum(r?.amount ?? r?.invoice_amount ?? r?.invoiceAmount ?? r?.approved_amount ?? 0);
 
-const pickPaid = (r: any) =>
-  nnum(r?.paidAmount ?? r?.total_paid ?? r?.totalPaid ?? r?.paid_amount ?? 0);
+  const FIN_DUE_DAYS_DEFAULT = 7;
+  const FIN_CRITICAL_DAYS = 14;
+  const [finKindName, setFinKindName] = useState<string>("");
+  const [finKindList, setFinKindList] = useState<any[]>([]);
+  const mountedRef = useRef(true);
+  useEffect(() => {
+    return () => { mountedRef.current = false; };
+  }, []);
 
+  const openSupplier = useCallback((s: any) => {
+    const supplierName = (() => {
+      if (typeof s === "string") return s.trim() || "тАФ";
+      const v =
+        s?.supplier?.supplier ??
+        s?.supplier ??
+        s?.name ??
+        "";
+      return String(v).trim() || "тАФ";
+    })();
 
-  const invoices = fin
-    .map((r: any, idx: number) => {
-      const amount = pickAmount(r);
-const paid = pickPaid(r);
-      const rest = Math.max(amount - paid, 0);
+    const kindName = (() => {
+      if (typeof s === "string") return "";
+      const v = s?._kindName ?? s?.kindName ?? "";
+      return String(v).trim();
+    })();
 
-      const pid = String(r?.proposalId ?? r?.proposal_id ?? "").trim();
-      const invNo = String(r?.invoiceNumber ?? r?.invoice_number ?? "").trim();
+    const inPeriod = (iso: any) => {
+      const d = String(iso ?? "").slice(0, 10);
+      if (!d) return true;
+      if (finFrom && d < String(finFrom).slice(0, 10)) return false;
+      if (finTo && d > String(finTo).slice(0, 10)) return false;
+      return true;
+    };
 
-      const approvedIso =
-  pickApprovedIso(r) ??
-  pickIso(r?.raw?.director_approved_at, r?.raw?.approved_at, r?.raw?.approvedAtIso);
+    let allowedProposalIds: Set<string> | null = null;
+    const proposalNoById: Record<string, string> = {};
 
-const invoiceIso =
-  pickInvoiceIso(r) ??
-  pickIso(r?.raw?.invoice_date, r?.raw?.invoice_at, r?.raw?.created_at);
+    if (kindName) {
+      const spend = (Array.isArray(finSpendRows) ? finSpendRows : [])
+        .filter((r: any) => String(r?.supplier ?? "").trim() === supplierName)
+        .filter((r: any) => String(r?.kind_name ?? "").trim() === kindName)
+        .filter((r: any) => inPeriod(r?.director_approved_at ?? r?.approved_at ?? r?.approvedAtIso));
 
+      allowedProposalIds = new Set(
+        spend.map((r: any) => String(r?.proposal_id ?? "").trim()).filter(Boolean)
+      );
 
-      const pno = pid ? String(proposalNoById[pid] ?? r?.proposal_no ?? "").trim() : "";
-      const title =
-        invNo ? `╨б╤З╤С╤В тДЦ${invNo}` :
-        pno ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ ${pno}` :
-        pid ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ #${pid.slice(0, 8)}` :
-        "╨б╤З╤С╤В";
+      for (const r of spend) {
+        const pid = String(r?.proposal_id ?? "").trim();
+        const pno = String(r?.proposal_no ?? "").trim();
+        if (pid && pno) proposalNoById[pid] = pno;
+      }
+    }
 
-      const dueIso =
-        r?.dueDate ??
-        r?.due_date ??
-        (invoiceIso ? addDaysIso(String(invoiceIso).slice(0, 10), dueDays) : null) ??
-        (approvedIso ? addDaysIso(String(approvedIso).slice(0, 10), dueDays) : null);
+    const fin = (Array.isArray(finRows) ? finRows : [])
+      .filter((r: any) => String(r?.supplier ?? "").trim() === supplierName)
+      .filter((r: any) => inPeriod(r?.approvedAtIso ?? r?.approved_at ?? r?.director_approved_at))
+      .filter((r: any) => {
+        if (!allowedProposalIds) return true;
+        const pid = String(r?.proposalId ?? r?.proposal_id ?? "").trim();
+        return pid && allowedProposalIds.has(pid);
+      });
 
-      const dueMid = parseMid(dueIso) ?? 0;
-      const isOverdue = rest > 0 && !!dueMid && dueMid < t0;
+    const t0 = mid(new Date());
+    const dueDays = FIN_DUE_DAYS_DEFAULT;
 
-      let isCritical = false;
-      if (isOverdue && dueMid) {
-        const days = Math.floor((t0 - dueMid) / (24 * 3600 * 1000));
-        isCritical = days >= FIN_CRITICAL_DAYS;
+    const pickIso = (...vals: any[]) => {
+      for (const v of vals) {
+        const s = String(v ?? "").trim();
+        if (!s) continue;
+        return s.slice(0, 10);
       }
+      return null;
+    };
 
-      const key = [
-        pid || "",
-        invNo || "",
-        String(invoiceIso ?? ""),
-        String(approvedIso ?? ""),
-        String(idx),
-      ].join("|");
+    const pickApprovedIso = (r: any) =>
+      pickIso(
+        r?.approvedAtIso,
+        r?.director_approved_at,
+        r?.approved_at,
+        r?.approvedAt,
+        r?.approved_at_iso
+      );
 
-      return {
-        id: key,
-        title,
-        amount,
-        paid,
-        rest,
-        isOverdue,
-        isCritical,
-        approvedIso: approvedIso ? String(approvedIso) : null,
-        invoiceIso: invoiceIso ? String(invoiceIso) : null,
-        dueIso: dueIso ? String(dueIso) : null,
-      };
-    })
-    .filter((x: any) => x.amount > 0 || x.rest > 0);
-
-  const debtAmount = invoices.reduce((s2: number, x: any) => s2 + Math.max(nnum(x.rest), 0), 0);
-  const debtCount = invoices.filter((x: any) => Math.max(nnum(x.rest), 0) > 0).length;
-  const overdueCount = invoices.filter((x: any) => x.isOverdue && Math.max(nnum(x.rest), 0) > 0).length;
-  const criticalCount = invoices.filter((x: any) => x.isCritical && Math.max(nnum(x.rest), 0) > 0).length;
-
-  const payload: any = {
-    supplier: supplierName,
-    _kindName: kindName || "",
-    amount: debtAmount,
-    count: debtCount,
-    overdueCount,
-    criticalCount,
-    invoices,
-  };
+    const pickInvoiceIso = (r: any) =>
+      pickIso(r?.invoiceDate, r?.invoice_date, r?.invoiceIso, r?.invoice_at, r?.created_at, r?.raw?.created_at);
 
-setFinSupplier(payload);
-pushFin("supplier");
 
+    const pickAmount = (r: any) =>
+      nnum(r?.amount ?? r?.invoice_amount ?? r?.invoiceAmount ?? r?.approved_amount ?? 0);
 
-}, [finRows, finSpendRows, finFrom, finTo]);
+    const pickPaid = (r: any) =>
+      nnum(r?.paidAmount ?? r?.total_paid ?? r?.totalPaid ?? r?.paid_amount ?? 0);
 
-const closeSupplier = useCallback(() => {
-  setFinSupplier(null);
-  popFin();
-}, [popFin]);
 
+    const invoices = fin
+      .map((r: any, idx: number) => {
+        const amount = pickAmount(r);
+        const paid = pickPaid(r);
+        const rest = Math.max(amount - paid, 0);
 
+        const pid = String(r?.proposalId ?? r?.proposal_id ?? "").trim();
+        const invNo = String(r?.invoiceNumber ?? r?.invoice_number ?? "").trim();
 
-const openFinKind = useCallback((kindName: string, list: any[]) => {
-  setFinKindName(String(kindName || ""));
-  setFinKindList(Array.isArray(list) ? list : []);
-  pushFin("kind");
-}, [pushFin]);
+        const approvedIso =
+          pickApprovedIso(r) ??
+          pickIso(r?.raw?.director_approved_at, r?.raw?.approved_at, r?.raw?.approvedAtIso);
 
-const closeFinKind = useCallback(() => {
-  setFinKindName("");
-  setFinKindList([]);
-  popFin();
-}, [popFin]);
+        const invoiceIso =
+          pickInvoiceIso(r) ??
+          pickIso(r?.raw?.invoice_date, r?.raw?.invoice_at, r?.raw?.created_at);
 
-const openFinPeriod = useCallback(() => setFinPeriodOpen(true), []);
-const closeFinPeriod = useCallback(() => setFinPeriodOpen(false), []);
 
-const openFinancePage = useCallback((page: FinPage) => {
-  finStackRef.current = ["home"];
-  setFinOpen(true);
-  setFinPage("home");
+        const pno = pid ? String(proposalNoById[pid] ?? r?.proposal_no ?? "").trim() : "";
+        const title =
+          invNo ? `╨б╤З╤С╤В тДЦ${invNo}` :
+            pno ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ ${pno}` :
+              pid ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ #${pid.slice(0, 8)}` :
+                "╨б╤З╤С╤В";
 
-  if (page !== "home") {
-    finStackRef.current = ["home", page];
-    setFinPage(page);
-  }
-}, []);
-
-const closeFinance = useCallback(() => {
-  setFinOpen(false);
-  setFinPage("home");
-  finStackRef.current = ["home"];
-  setFinSupplier(null);
-  setFinKindName("");
-  setFinKindList([]);
-}, []);
-
-const onFinancePdf = useCallback(async () => {
-  await runPdfTop({
-    busy,
-    supabase,
-    key: "pdf:director:finance",
-    label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Г╨┐╤А╨░╨▓╨╗╨╡╨╜╤З╨╡╤Б╨║╨╕╨╣ ╨╛╤В╤З╤С╤ВтАж",
-    mode: Platform.OS === "web" ? "preview" : "share",
-    fileName: "Director_Management_Report",
-    getRemoteUrl: async () => {
-    
-      const { exportDirectorManagementReportPdf } = await import("../../src/lib/api/pdf_director");
-      return await exportDirectorManagementReportPdf({
-        periodFrom: finFrom,
-        periodTo: finTo,
-        financeRows: finRows,
-        spendRows: finSpendRows,
-        topN: 15,
-        dueDaysDefault: FIN_DUE_DAYS_DEFAULT,
-        criticalDays: FIN_CRITICAL_DAYS,
-      });
-    },
-  });
-}, [
-  busy,
-  supabase,
-  finFrom,
-  finTo,
-  finRows,
-  finSpendRows,
-  FIN_DUE_DAYS_DEFAULT,
-  FIN_CRITICAL_DAYS,
-]);
-
-
-const onSupplierPdf = useCallback(async () => {
-  const supName = String((finSupplier as any)?.supplier ?? "").trim();
-  if (!supName) {
-    Alert.alert("PDF", "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║ ╨╜╨╡ ╨▓╤Л╨▒╤А╨░╨╜");
-    return;
-  }
+        const dueIso =
+          r?.dueDate ??
+          r?.due_date ??
+          (invoiceIso ? addDaysIso(String(invoiceIso).slice(0, 10), dueDays) : null) ??
+          (approvedIso ? addDaysIso(String(approvedIso).slice(0, 10), dueDays) : null);
+
+        const dueMid = parseMid(dueIso) ?? 0;
+        const isOverdue = rest > 0 && !!dueMid && dueMid < t0;
+
+        let isCritical = false;
+        if (isOverdue && dueMid) {
+          const days = Math.floor((t0 - dueMid) / (24 * 3600 * 1000));
+          isCritical = days >= FIN_CRITICAL_DAYS;
+        }
+
+        const key = [
+          pid || "",
+          invNo || "",
+          String(invoiceIso ?? ""),
+          String(approvedIso ?? ""),
+          String(idx),
+        ].join("|");
+
+        return {
+          id: key,
+          title,
+          amount,
+          paid,
+          rest,
+          isOverdue,
+          isCritical,
+          approvedIso: approvedIso ? String(approvedIso) : null,
+          invoiceIso: invoiceIso ? String(invoiceIso) : null,
+          dueIso: dueIso ? String(dueIso) : null,
+        };
+      })
+      .filter((x: any) => x.amount > 0 || x.rest > 0);
+
+    const debtAmount = invoices.reduce((s2: number, x: any) => s2 + Math.max(nnum(x.rest), 0), 0);
+    const debtCount = invoices.filter((x: any) => Math.max(nnum(x.rest), 0) > 0).length;
+    const overdueCount = invoices.filter((x: any) => x.isOverdue && Math.max(nnum(x.rest), 0) > 0).length;
+    const criticalCount = invoices.filter((x: any) => x.isCritical && Math.max(nnum(x.rest), 0) > 0).length;
+
+    const payload: any = {
+      supplier: supplierName,
+      _kindName: kindName || "",
+      amount: debtAmount,
+      count: debtCount,
+      overdueCount,
+      criticalCount,
+      invoices,
+    };
+
+    setFinSupplier(payload);
+    pushFin("supplier");
 
-  await runPdfTop({
+
+  }, [finRows, finSpendRows, finFrom, finTo]);
+
+  const closeSupplier = useCallback(() => {
+    setFinSupplier(null);
+    popFin();
+  }, [popFin]);
+
+
+
+  const openFinKind = useCallback((kindName: string, list: any[]) => {
+    setFinKindName(String(kindName || ""));
+    setFinKindList(Array.isArray(list) ? list : []);
+    pushFin("kind");
+  }, [pushFin]);
+
+  const closeFinKind = useCallback(() => {
+    setFinKindName("");
+    setFinKindList([]);
+    popFin();
+  }, [popFin]);
+
+  const openFinPeriod = useCallback(() => setFinPeriodOpen(true), []);
+  const closeFinPeriod = useCallback(() => setFinPeriodOpen(false), []);
+
+  const openFinancePage = useCallback((page: FinPage) => {
+    finStackRef.current = ["home"];
+    setFinOpen(true);
+    setFinPage("home");
+
+    if (page !== "home") {
+      finStackRef.current = ["home", page];
+      setFinPage(page);
+    }
+  }, []);
+
+  const closeFinance = useCallback(() => {
+    setFinOpen(false);
+    setFinPage("home");
+    finStackRef.current = ["home"];
+    setFinSupplier(null);
+    setFinKindName("");
+    setFinKindList([]);
+  }, []);
+
+  const onFinancePdf = useCallback(async () => {
+    await runPdfTop({
+      busy,
+      supabase,
+      key: "pdf:director:finance",
+      label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Г╨┐╤А╨░╨▓╨╗╨╡╨╜╤З╨╡╤Б╨║╨╕╨╣ ╨╛╤В╤З╤С╤ВтАж",
+      mode: Platform.OS === "web" ? "preview" : "share",
+      fileName: "Director_Management_Report",
+      getRemoteUrl: async () => {
+
+        const { exportDirectorManagementReportPdf } = await import("../../src/lib/api/pdf_director");
+        return await exportDirectorManagementReportPdf({
+          periodFrom: finFrom,
+          periodTo: finTo,
+          financeRows: finRows,
+          spendRows: finSpendRows,
+          topN: 15,
+          dueDaysDefault: FIN_DUE_DAYS_DEFAULT,
+          criticalDays: FIN_CRITICAL_DAYS,
+        });
+      },
+    });
+  }, [
     busy,
     supabase,
-    key: `pdf:director:supplier:${supName}`,
-    label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Б╨▓╨╛╨┤╨║╤ГтАж",
-     mode: Platform.OS === "web" ? "preview" : "share",
-    fileName: `Supplier_${supName}`,
-    getRemoteUrl: async () => {
-      const kindName = String((finSupplier as any)?._kindName ?? "").trim();
-
-      const inPeriod = (iso: any) => {
-        const d = String(iso ?? "").slice(0, 10);
-        if (!d) return true;
-        if (finFrom && d < String(finFrom).slice(0, 10)) return false;
-        if (finTo && d > String(finTo).slice(0, 10)) return false;
-        return true;
-      };
+    finFrom,
+    finTo,
+    finRows,
+    finSpendRows,
+    FIN_DUE_DAYS_DEFAULT,
+    FIN_CRITICAL_DAYS,
+  ]);
+
+
+  const onSupplierPdf = useCallback(async () => {
+    const supName = String((finSupplier as any)?.supplier ?? "").trim();
+    if (!supName) {
+      notifyInfo("PDF", "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║ ╨╜╨╡ ╨▓╤Л╨▒╤А╨░╨╜");
+      return;
+    }
 
-      let financeFiltered = (Array.isArray(finRows) ? finRows : [])
-        .filter((r: any) => String(r?.supplier ?? "").trim() === supName)
-        .filter((r: any) => inPeriod(r?.approvedAtIso ?? r?.approved_at ?? r?.director_approved_at));
+    await runPdfTop({
+      busy,
+      supabase,
+      key: `pdf:director:supplier:${supName}`,
+      label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Б╨▓╨╛╨┤╨║╤ГтАж",
+      mode: Platform.OS === "web" ? "preview" : "share",
+      fileName: `Supplier_${supName}`,
+      getRemoteUrl: async () => {
+        const kindName = String((finSupplier as any)?._kindName ?? "").trim();
+
+        const inPeriod = (iso: any) => {
+          const d = String(iso ?? "").slice(0, 10);
+          if (!d) return true;
+          if (finFrom && d < String(finFrom).slice(0, 10)) return false;
+          if (finTo && d > String(finTo).slice(0, 10)) return false;
+          return true;
+        };
 
-      let spendFiltered = (Array.isArray(finSpendRows) ? finSpendRows : [])
-        .filter((r: any) => String(r?.supplier ?? "").trim() === supName)
-        .filter((r: any) => inPeriod(r?.director_approved_at ?? r?.approved_at ?? r?.approvedAtIso));
+        let financeFiltered = (Array.isArray(finRows) ? finRows : [])
+          .filter((r: any) => String(r?.supplier ?? "").trim() === supName)
+          .filter((r: any) => inPeriod(r?.approvedAtIso ?? r?.approved_at ?? r?.director_approved_at));
 
-      if (kindName) {
-        spendFiltered = spendFiltered.filter((r: any) => String(r?.kind_name ?? "").trim() === kindName);
-      }
+        let spendFiltered = (Array.isArray(finSpendRows) ? finSpendRows : [])
+          .filter((r: any) => String(r?.supplier ?? "").trim() === supName)
+          .filter((r: any) => inPeriod(r?.director_approved_at ?? r?.approved_at ?? r?.approvedAtIso));
 
-      spendFiltered = (spendFiltered as any[]).filter((r) => String(r?.proposal_id ?? "").trim());
+        if (kindName) {
+          spendFiltered = spendFiltered.filter((r: any) => String(r?.kind_name ?? "").trim() === kindName);
+        }
 
-      const { exportDirectorSupplierSummaryPdf } = await import("../../src/lib/api/pdf_director");
-      return await exportDirectorSupplierSummaryPdf({
-        supplier: supName,
-        periodFrom: finFrom,
-        periodTo: finTo,
-        financeRows: financeFiltered,
-        spendRows: spendFiltered,
-      });
-    },
-  });
-}, [busy, supabase, finSupplier, finFrom, finTo, finRows, finSpendRows]);
+        spendFiltered = (spendFiltered as any[]).filter((r) => String(r?.proposal_id ?? "").trim());
 
+        const { exportDirectorSupplierSummaryPdf } = await import("../../src/lib/api/pdf_director");
+        return await exportDirectorSupplierSummaryPdf({
+          supplier: supName,
+          periodFrom: finFrom,
+          periodTo: finTo,
+          financeRows: financeFiltered,
+          spendRows: spendFiltered,
+        });
+      },
+    });
+  }, [busy, supabase, finSupplier, finFrom, finTo, finRows, finSpendRows]);
 
-const isMobile = Platform.OS !== "web";
 
-const HEADER_MIN = isMobile
-  ? (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 148 : 108)
-  : 76;
+  const isMobile = Platform.OS !== "web";
 
-const HEADER_MAX = isMobile
-  ? (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 198 : 150)
-  : (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 210 : 170);
+  const HEADER_MIN = isMobile
+    ? (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 148 : 108)
+    : 76;
 
-const HEADER_SCROLL = Math.max(1, HEADER_MAX - HEADER_MIN);
+  const HEADER_MAX = isMobile
+    ? (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 198 : 150)
+    : (dirTab === "╨Ч╨░╤П╨▓╨║╨╕" ? 210 : 170);
 
-const isRequestsTab = dirTab === "╨Ч╨░╤П╨▓╨║╨╕";
+  const HEADER_SCROLL = Math.max(1, HEADER_MAX - HEADER_MIN);
 
-// 1) scroll value
-const scrollY = useRef(new Animated.Value(0)).current;
+  const isRequestsTab = dirTab === "╨Ч╨░╤П╨▓╨║╨╕";
 
-// 2) safe clamp range (never 0)
-const _HEADER_SCROLL = Math.max(1, Number(HEADER_SCROLL || 0));
+  // 1) scroll value
+  const scrollY = useRef(new Animated.Value(0)).current;
 
-// 3) clampedY MUST be declared before any interpolate usage
-const clampedY = useMemo(() => {
-  return Animated.diffClamp(scrollY, 0, _HEADER_SCROLL);
-}, [scrollY, _HEADER_SCROLL]);
+  // 2) safe clamp range (never 0)
+  const _HEADER_SCROLL = Math.max(1, Number(HEADER_SCROLL || 0));
 
-// 4) interpolations
-const headerHeight = useMemo(() => {
-  return clampedY.interpolate({
-    inputRange: [0, HEADER_SCROLL],
-    outputRange: [HEADER_MAX, HEADER_MIN],
-    extrapolate: "clamp",
-  });
-}, [clampedY, HEADER_SCROLL, HEADER_MAX, HEADER_MIN]);
+  // 3) clampedY MUST be declared before any interpolate usage
+  const clampedY = useMemo(() => {
+    return Animated.diffClamp(scrollY, 0, _HEADER_SCROLL);
+  }, [scrollY, _HEADER_SCROLL]);
 
-const titleSize = useMemo(() => {
-  return clampedY.interpolate({
-    inputRange: [0, HEADER_SCROLL],
-    outputRange: [24, 16],
-    extrapolate: "clamp",
-  });
-}, [clampedY, HEADER_SCROLL]);
+  // 4) interpolations
+  const headerHeight = useMemo(() => {
+    return clampedY.interpolate({
+      inputRange: [0, HEADER_SCROLL],
+      outputRange: [HEADER_MAX, HEADER_MIN],
+      extrapolate: "clamp",
+    });
+  }, [clampedY, HEADER_SCROLL, HEADER_MAX, HEADER_MIN]);
 
-const subOpacity = useMemo(() => {
-  return clampedY.interpolate({
-    inputRange: [0, HEADER_SCROLL],
-    outputRange: [1, 0],
-    extrapolate: "clamp",
-  });
-}, [clampedY, HEADER_SCROLL]);
+  const titleSize = useMemo(() => {
+    return clampedY.interpolate({
+      inputRange: [0, HEADER_SCROLL],
+      outputRange: [24, 16],
+      extrapolate: "clamp",
+    });
+  }, [clampedY, HEADER_SCROLL]);
+
+  const subOpacity = useMemo(() => {
+    return clampedY.interpolate({
+      inputRange: [0, HEADER_SCROLL],
+      outputRange: [1, 0],
+      extrapolate: "clamp",
+    });
+  }, [clampedY, HEADER_SCROLL]);
 
-const headerShadow = useMemo(() => {
-  return isRequestsTab
-    ? clampedY.interpolate({
+  const headerShadow = useMemo(() => {
+    return isRequestsTab
+      ? clampedY.interpolate({
         inputRange: [0, 10],
         outputRange: [0, 0.12],
         extrapolate: "clamp",
       })
-    : 0.12;
-}, [isRequestsTab, clampedY]);
+      : 0.12;
+  }, [isRequestsTab, clampedY]);
 
   const [rows, setRows] = useState<PendingRow[]>([]);
-const [loadingRows, setLoadingRows] = useState(false);
-const [actingId, setActingId] = useState<string | null>(null);
+  const [loadingRows, setLoadingRows] = useState(false);
+  const [actingId, setActingId] = useState<string | null>(null);
 
 
-const [reqDeleteId, setReqDeleteId] = useState<number | string | null>(null);
-const [reqSendId, setReqSendId] = useState<number | string | null>(null);
+  const [reqDeleteId, setReqDeleteId] = useState<number | string | null>(null);
+  const [reqSendId, setReqSendId] = useState<number | string | null>(null);
 
 
-const [propApproveId, setPropApproveId] = useState<string | null>(null);
-const [propReturnId, setPropReturnId] = useState<string | null>(null);
+  const [propApproveId, setPropApproveId] = useState<string | null>(null);
+  const [propReturnId, setPropReturnId] = useState<string | null>(null);
 
-const [propAttByProp, setPropAttByProp] = useState<Record<string, ProposalAttachmentRow[]>>({});
+  const [propAttByProp, setPropAttByProp] = useState<Record<string, ProposalAttachmentRow[]>>({});
   const [propAttBusyByProp, setPropAttBusyByProp] = useState<Record<string, boolean>>({});
 
-const [sheetKind, setSheetKind] = useState<SheetKind>('none');
-const [sheetRequest, setSheetRequest] = useState<Group | null>(null);
-const [sheetProposalId, setSheetProposalId] = useState<string | null>(null);
+  const [sheetKind, setSheetKind] = useState<SheetKind>('none');
+  const [sheetRequest, setSheetRequest] = useState<Group | null>(null);
+  const [sheetProposalId, setSheetProposalId] = useState<string | null>(null);
 
-const loadingPropRef = useRef<Record<string, boolean>>({});
-const lastTapRef = useRef<number>(0);
-const pdfTapLockRef = useRef<Record<string, boolean>>({});
-const isSheetOpen = sheetKind !== 'none';
+  const loadingPropRef = useRef<Record<string, boolean>>({});
+  const lastTapRef = useRef<number>(0);
+  const pdfTapLockRef = useRef<Record<string, boolean>>({});
+  const isSheetOpen = sheetKind !== 'none';
 
-const closeSheet = useCallback(() => {
-  setSheetKind('none');
-  setSheetRequest(null);
-  setSheetProposalId(null);
-}, []);
+  const closeSheet = useCallback(() => {
+    setSheetKind('none');
+    setSheetRequest(null);
+    setSheetProposalId(null);
+  }, []);
 
-const openRequestSheet = useCallback((g: Group) => {
-  setSheetRequest(g);
-  setSheetProposalId(null);
-  setSheetKind('request');
-}, []);
+  const openRequestSheet = useCallback((g: Group) => {
+    setSheetRequest(g);
+    setSheetProposalId(null);
+    setSheetKind('request');
+  }, []);
 
-const openProposalSheet = useCallback((pid: string) => {
-  setSheetProposalId(pid);
-  setSheetRequest(null);
-  setSheetKind('proposal');
-}, []);
+  const openProposalSheet = useCallback((pid: string) => {
+    setSheetProposalId(pid);
+    setSheetRequest(null);
+    setSheetKind('proposal');
+  }, []);
 
 
   const didInit = useRef(false);
   const fetchTicket = useRef(0);
   const lastNonEmptyRows = useRef<PendingRow[]>([]);
-  
+
 
   const [propsHeads, setPropsHeads] = useState<ProposalHead[]>([]);
-const [buyerPropsCount, setBuyerPropsCount] = useState<number>(0);
-const [buyerPositionsCount, setBuyerPositionsCount] = useState<number>(0);
-const [propItemsCount, setPropItemsCount] = useState<Record<string, number>>({});
+  const [buyerPropsCount, setBuyerPropsCount] = useState<number>(0);
+  const [buyerPositionsCount, setBuyerPositionsCount] = useState<number>(0);
+  const [propItemsCount, setPropItemsCount] = useState<Record<string, number>>({});
   const [loadingProps, setLoadingProps] = useState(false);
 
-const [itemsByProp, setItemsByProp] = useState<Record<string, ProposalItem[]>>({});
-const [loadedByProp, setLoadedByProp] = useState<Record<string, boolean>>({});
+  const [itemsByProp, setItemsByProp] = useState<Record<string, ProposalItem[]>>({});
+  const [loadedByProp, setLoadedByProp] = useState<Record<string, boolean>>({});
 
 
-const [loadingPropId, setLoadingPropId] = useState<string | null>(null);
+  const [loadingPropId, setLoadingPropId] = useState<string | null>(null);
 
   const [decidingId, setDecidingId] = useState<string | null>(null);
 
 
-const [actingPropItemId, setActingPropItemId] = useState<number | null>(null);
+  const [actingPropItemId, setActingPropItemId] = useState<number | null>(null);
 
-const screenLock =
-  !!actingId ||
-  reqDeleteId != null ||
-  reqSendId != null ||
-  propApproveId != null ||
-  propReturnId != null ||
-  actingPropItemId != null;
+  const screenLock =
+    !!actingId ||
+    reqDeleteId != null ||
+    reqSendId != null ||
+    propApproveId != null ||
+    propReturnId != null ||
+    actingPropItemId != null;
 
   const [pdfHtmlByProp, setPdfHtmlByProp] = useState<Record<string, string>>({});
-const [rtToast, setRtToast] = useState<RtToast>({
-  visible: false,
-  title: '',
-  body: '',
-  count: 0,
-});
-
-const rtToastTimerRef = useRef<any>(null);
-
-const showRtToast = useCallback((title?: string, body?: string) => {
-  const t = String(title || '╨г╨▓╨╡╨┤╨╛╨╝╨╗╨╡╨╜╨╕╨╡').trim();
-  const b = String(body || '').trim();
-
-  if (rtToastTimerRef.current) {
-    clearTimeout(rtToastTimerRef.current);
-    rtToastTimerRef.current = null;
-  }
-
-  setRtToast(prev => {
-    const same = prev.visible && prev.title === t && prev.body === b;
-    return {
-      visible: true,
-      title: t,
-      body: b,
-      count: same ? prev.count + 1 : 1,
-    };
+  const [rtToast, setRtToast] = useState<RtToast>({
+    visible: false,
+    title: '',
+    body: '',
+    count: 0,
   });
 
-  rtToastTimerRef.current = setTimeout(() => {
-    setRtToast(prev => ({ ...prev, visible: false }));
-  }, 2600);
-}, []);
+  const rtToastTimerRef = useRef<any>(null);
 
-const showSuccess = useCallback((msg: string) => {
-  showRtToast('╨У╨╛╤В╨╛╨▓╨╛', msg);
-}, [showRtToast]);
-  // ===== ╨Ъ╨н╨и ╨Э╨Ю╨Ь╨Х╨а╨Ю╨Т ╨Ч╨Р╨п╨Т╨Ю╨Ъ =====
-const [displayNoByReq, setDisplayNoByReq] = useState<Record<string, string>>({});
-const [submittedAtByReq, setSubmittedAtByReq] = useState<Record<string, string>>({});
-
-
-const [reqMetaById, setReqMetaById] = useState<Record<string, RequestMeta>>({});
-const reqMetaByIdRef = useRef<Record<string, RequestMeta>>({});
-useEffect(() => { reqMetaByIdRef.current = reqMetaById; }, [reqMetaById]);
-// тЬЕ request_item_id -> note (╤З╤В╨╛╨▒╤Л ╨▓ proposal-sheet ╨▒╤Л╨╗╨╛ ╨║╨░╨║ ╤Г ╨┐╤А╨╛╤А╨░╨▒╨░)
-const [reqItemNoteById, setReqItemNoteById] = useState<Record<string, string>>({});
-const reqItemNoteByIdRef = useRef<Record<string, string>>({});
-useEffect(() => { reqItemNoteByIdRef.current = reqItemNoteById; }, [reqItemNoteById]);
-
-// proposal_id -> [request_id...]
-const [propReqIdsByProp, setPropReqIdsByProp] = useState<Record<string, string[]>>({});
-const propReqIdsByPropRef = useRef<Record<string, string[]>>({});
-useEffect(() => { propReqIdsByPropRef.current = propReqIdsByProp; }, [propReqIdsByProp]);
-
-const preloadRequestMeta = useCallback(async (reqIds: string[]) => {
-  const uniq = Array.from(new Set((reqIds || []).map(String).filter(Boolean)));
-  const existing = reqMetaByIdRef.current || {};
-  const need = uniq.filter(id => !existing[id]);
-  if (!need.length) return;
-
-  try {
-    const q = await supabase
-      .from("requests")
-      .select("id, object_name, object, level_code, system_code, zone_code, site_address_snapshot, note, comment")
-      .in("id", need);
-
-    if (q.error) throw q.error;
-
-    const next: Record<string, RequestMeta> = {};
-    (q.data || []).forEach((r: any) => {
-      const id = String(r?.id || "").trim();
-      if (!id) return;
-      next[id] = {
-        // note_preview ╨▒╨╛╨╗╤М╤И╨╡ ╨Э╨Х ╨╕╤Б╨┐╨╛╨╗╤М╨╖╤Г╨╡╨╝ (╨╕ ╨╜╨╡ ╤З╨╕╤В╨░╨╡╨╝ ╨╕╨╖ view)
-        object_name: r?.object_name ?? null,
-        object: r?.object ?? null,
-        level_code: r?.level_code ?? null,
-        system_code: r?.system_code ?? null,
-        zone_code: r?.zone_code ?? null,
-        site_address_snapshot: r?.site_address_snapshot ?? null,
-        note: r?.note ?? null,
-        comment: r?.comment ?? null,
+  const showRtToast = useCallback((title?: string, body?: string) => {
+    const t = String(title || '╨г╨▓╨╡╨┤╨╛╨╝╨╗╨╡╨╜╨╕╨╡').trim();
+    const b = String(body || '').trim();
+
+    if (rtToastTimerRef.current) {
+      clearTimeout(rtToastTimerRef.current);
+      rtToastTimerRef.current = null;
+    }
+
+    setRtToast(prev => {
+      const same = prev.visible && prev.title === t && prev.body === b;
+      return {
+        visible: true,
+        title: t,
+        body: b,
+        count: same ? prev.count + 1 : 1,
       };
     });
 
-    if (Object.keys(next).length) {
-      setReqMetaById(prev => ({ ...prev, ...next }));
+    rtToastTimerRef.current = setTimeout(() => {
+      setRtToast(prev => ({ ...prev, visible: false }));
+    }, 2600);
+  }, []);
+
+  const showSuccess = useCallback((msg: string) => {
+    showRtToast('╨У╨╛╤В╨╛╨▓╨╛', msg);
+  }, [showRtToast]);
+  // ===== ╨Ъ╨н╨и ╨Э╨Ю╨Ь╨Х╨а╨Ю╨Т ╨Ч╨Р╨п╨Т╨Ю╨Ъ =====
+  const [displayNoByReq, setDisplayNoByReq] = useState<Record<string, string>>({});
+  const [submittedAtByReq, setSubmittedAtByReq] = useState<Record<string, string>>({});
+
+
+  const [reqMetaById, setReqMetaById] = useState<Record<string, RequestMeta>>({});
+  const reqMetaByIdRef = useRef<Record<string, RequestMeta>>({});
+  useEffect(() => { reqMetaByIdRef.current = reqMetaById; }, [reqMetaById]);
+  // тЬЕ request_item_id -> note (╤З╤В╨╛╨▒╤Л ╨▓ proposal-sheet ╨▒╤Л╨╗╨╛ ╨║╨░╨║ ╤Г ╨┐╤А╨╛╤А╨░╨▒╨░)
+  const [reqItemNoteById, setReqItemNoteById] = useState<Record<string, string>>({});
+  const reqItemNoteByIdRef = useRef<Record<string, string>>({});
+  useEffect(() => { reqItemNoteByIdRef.current = reqItemNoteById; }, [reqItemNoteById]);
+
+  // proposal_id -> [request_id...]
+  const [propReqIdsByProp, setPropReqIdsByProp] = useState<Record<string, string[]>>({});
+  const propReqIdsByPropRef = useRef<Record<string, string[]>>({});
+  useEffect(() => { propReqIdsByPropRef.current = propReqIdsByProp; }, [propReqIdsByProp]);
+
+  const preloadRequestMeta = useCallback(async (reqIds: string[]) => {
+    const uniq = Array.from(new Set((reqIds || []).map(String).filter(Boolean)));
+    const existing = reqMetaByIdRef.current || {};
+    const need = uniq.filter(id => !existing[id]);
+    if (!need.length) return;
+
+    try {
+      const q = await supabase
+        .from("requests")
+        .select("id, object_name, object, level_code, system_code, zone_code, site_address_snapshot, note, comment")
+        .in("id", need);
+
+      if (q.error) throw q.error;
+
+      const next: Record<string, RequestMeta> = {};
+      (q.data || []).forEach((r: any) => {
+        const id = String(r?.id || "").trim();
+        if (!id) return;
+        next[id] = {
+          // note_preview ╨▒╨╛╨╗╤М╤И╨╡ ╨Э╨Х ╨╕╤Б╨┐╨╛╨╗╤М╨╖╤Г╨╡╨╝ (╨╕ ╨╜╨╡ ╤З╨╕╤В╨░╨╡╨╝ ╨╕╨╖ view)
+          object_name: r?.object_name ?? null,
+          object: r?.object ?? null,
+          level_code: r?.level_code ?? null,
+          system_code: r?.system_code ?? null,
+          zone_code: r?.zone_code ?? null,
+          site_address_snapshot: r?.site_address_snapshot ?? null,
+          note: r?.note ?? null,
+          comment: r?.comment ?? null,
+        };
+      });
+
+      if (Object.keys(next).length) {
+        setReqMetaById(prev => ({ ...prev, ...next }));
+      }
+    } catch (e: any) {
+      console.warn("[director] preloadRequestMeta:", e?.message ?? e);
     }
-  } catch (e: any) {
-    console.warn("[director] preloadRequestMeta:", e?.message ?? e);
-  }
-}, [supabase]);
-const preloadProposalRequestIds = useCallback(async (proposalId: string, requestItemIds: (string | null)[]) => {
-  const pid = String(proposalId || "").trim();
-  if (!pid) return;
+  }, [supabase]);
+  const preloadProposalRequestIds = useCallback(async (proposalId: string, requestItemIds: (string | null)[]) => {
+    const pid = String(proposalId || "").trim();
+    if (!pid) return;
 
-  // ╨╡╤Б╨╗╨╕ ╤Г╨╢╨╡ ╨╡╤Б╤В╤М тАФ ╨╜╨╡ ╨┤╤С╤А╨│╨░╨╡╨╝
-  if (propReqIdsByPropRef.current?.[pid]?.length) return;
+    // ╨╡╤Б╨╗╨╕ ╤Г╨╢╨╡ ╨╡╤Б╤В╤М тАФ ╨╜╨╡ ╨┤╤С╤А╨│╨░╨╡╨╝
+    if (propReqIdsByPropRef.current?.[pid]?.length) return;
 
-  const ids = Array.from(new Set((requestItemIds || []).map(x => String(x || "").trim()).filter(Boolean)));
-  if (!ids.length) return;
+    const ids = Array.from(new Set((requestItemIds || []).map(x => String(x || "").trim()).filter(Boolean)));
+    if (!ids.length) return;
 
-  try {
-    // request_items: id -> request_id
-    const q = await supabase
-      .from("request_items")
-      .select("id, request_id")
-      .in("id", ids);
+    try {
+      // request_items: id -> request_id
+      const q = await supabase
+        .from("request_items")
+        .select("id, request_id")
+        .in("id", ids);
 
-    if (q.error) throw q.error;
+      if (q.error) throw q.error;
 
-    const reqIds = Array.from(new Set((q.data || []).map((r: any) => String(r?.request_id || "").trim()).filter(Boolean)));
-    if (!reqIds.length) return;
+      const reqIds = Array.from(new Set((q.data || []).map((r: any) => String(r?.request_id || "").trim()).filter(Boolean)));
+      if (!reqIds.length) return;
 
-    setPropReqIdsByProp(prev => ({ ...prev, [pid]: reqIds }));
-    await preloadRequestMeta(reqIds);
-  } catch (e: any) {
-    console.warn("[director] preloadProposalRequestIds:", e?.message ?? e);
-  }
-}, [supabase, preloadRequestMeta]);
+      setPropReqIdsByProp(prev => ({ ...prev, [pid]: reqIds }));
+      await preloadRequestMeta(reqIds);
+    } catch (e: any) {
+      console.warn("[director] preloadProposalRequestIds:", e?.message ?? e);
+    }
+  }, [supabase, preloadRequestMeta]);
 
   const labelForRequest = useCallback((rid: number | string | null | undefined, fallbackDocNo?: string | null) => {
     const key = String(rid ?? '');
@@ -869,151 +977,151 @@ const preloadProposalRequestIds = useCallback(async (proposalId: string, request
     return `#${shortId(rid)}`;
   }, [displayNoByReq]);
 
-const fetchFinSpendRows = useCallback(async () => {
-  try {
-    let q = supabase
-  .from("v_director_finance_spend_kinds_v3")
-  .select("proposal_id,proposal_no,supplier,kind_code,kind_name,approved_alloc,paid_alloc,paid_alloc_cap,overpay_alloc,director_approved_at");
+  const fetchFinSpendRows = useCallback(async () => {
+    try {
+      let q = supabase
+        .from("v_director_finance_spend_kinds_v3")
+        .select("proposal_id,proposal_no,supplier,kind_code,kind_name,approved_alloc,paid_alloc,paid_alloc_cap,overpay_alloc,director_approved_at");
+
+      if (finFrom) q = q.gte("director_approved_at", finFrom);
+      if (finTo) q = q.lte("director_approved_at", finTo);
 
-    if (finFrom) q = q.gte("director_approved_at", finFrom);
-    if (finTo) q = q.lte("director_approved_at", finTo);
+      const { data, error } = await q;
+      if (error) throw error;
 
-    const { data, error } = await q;
-    if (error) throw error;
+      setFinSpendRows(Array.isArray(data) ? data : []);
+    } catch (e: any) {
+      console.warn("[director] fetchFinSpendRows:", e?.message ?? e);
 
-    setFinSpendRows(Array.isArray(data) ? data : []);
-  } catch (e: any) {
-    console.warn("[director] fetchFinSpendRows:", e?.message ?? e);
-   
-  }
-}, [supabase, finFrom, finTo]);
+    }
+  }, [supabase, finFrom, finTo]);
 
 
-const fetchFinance = useCallback(async () => {
-  setFinLoading(true);
+  const fetchFinance = useCallback(async () => {
+    setFinLoading(true);
 
 
-  let nextRows: FinanceRow[] | null = null;
+    let nextRows: FinanceRow[] | null = null;
 
-  try {
-    const list = await listAccountantInbox();
+    try {
+      const list = await listAccountantInbox();
 
-    const mapped = (Array.isArray(list) ? list : [])
-      .map(mapToFinanceRow)
-      .filter(x => !!x && !!x.id)
-      .filter(x => Number.isFinite(Number(x.amount)));
+      const mapped = (Array.isArray(list) ? list : [])
+        .map(mapToFinanceRow)
+        .filter(x => !!x && !!x.id)
+        .filter(x => Number.isFinite(Number(x.amount)));
 
 
-    const t0 = mid(new Date());
-    mapped.sort((a, b) => {
-      const aPaid = nnum(a.amount) > 0 && Math.max(nnum(a.amount) - nnum(a.paidAmount), 0) <= 0;
-      const bPaid = nnum(b.amount) > 0 && Math.max(nnum(b.amount) - nnum(b.paidAmount), 0) <= 0;
+      const t0 = mid(new Date());
+      mapped.sort((a, b) => {
+        const aPaid = nnum(a.amount) > 0 && Math.max(nnum(a.amount) - nnum(a.paidAmount), 0) <= 0;
+        const bPaid = nnum(b.amount) > 0 && Math.max(nnum(b.amount) - nnum(b.paidAmount), 0) <= 0;
 
-      const aDueIso =
-  a.dueDate ??
-  (a.invoiceDate ? addDaysIso(a.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
-  (a.approvedAtIso ? addDaysIso(a.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
+        const aDueIso =
+          a.dueDate ??
+          (a.invoiceDate ? addDaysIso(a.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
+          (a.approvedAtIso ? addDaysIso(a.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
 
-const bDueIso =
-  b.dueDate ??
-  (b.invoiceDate ? addDaysIso(b.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
-  (b.approvedAtIso ? addDaysIso(b.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
-      const aDue = parseMid(aDueIso) ?? 0;
-      const bDue = parseMid(bDueIso) ?? 0;
+        const bDueIso =
+          b.dueDate ??
+          (b.invoiceDate ? addDaysIso(b.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
+          (b.approvedAtIso ? addDaysIso(b.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
+        const aDue = parseMid(aDueIso) ?? 0;
+        const bDue = parseMid(bDueIso) ?? 0;
 
-      const aRest = Math.max(nnum(a.amount) - nnum(a.paidAmount), 0);
-      const bRest = Math.max(nnum(b.amount) - nnum(b.paidAmount), 0);
+        const aRest = Math.max(nnum(a.amount) - nnum(a.paidAmount), 0);
+        const bRest = Math.max(nnum(b.amount) - nnum(b.paidAmount), 0);
 
-      const aOver = (!aPaid && aRest > 0 && aDue && aDue < t0) ? 1 : 0;
-      const bOver = (!bPaid && bRest > 0 && bDue && bDue < t0) ? 1 : 0;
+        const aOver = (!aPaid && aRest > 0 && aDue && aDue < t0) ? 1 : 0;
+        const bOver = (!bPaid && bRest > 0 && bDue && bDue < t0) ? 1 : 0;
 
-      if (aOver !== bOver) return bOver - aOver;
+        if (aOver !== bOver) return bOver - aOver;
 
-      // ╨┤╨░╨╗╤М╤И╨╡ ╤Б╨╛╤А╤В ╨┐╨╛ ╤Б╤А╨╛╨║╤Г
-      return (aDue || 0) - (bDue || 0);
-    });
+        // ╨┤╨░╨╗╤М╤И╨╡ ╤Б╨╛╤А╤В ╨┐╨╛ ╤Б╤А╨╛╨║╤Г
+        return (aDue || 0) - (bDue || 0);
+      });
+
+      nextRows = mapped;
+
+      const rep = computeFinanceRep(mapped, {
+        dueDaysDefault: FIN_DUE_DAYS_DEFAULT,
+        criticalDays: FIN_CRITICAL_DAYS,
+        periodFromIso: finFrom,
+        periodToIso: finTo,
+      });
+      setFinRows(mapped);
+      setFinRep(rep);
+      await fetchFinSpendRows();
 
-    nextRows = mapped;
-
-    const rep = computeFinanceRep(mapped, {
-  dueDaysDefault: FIN_DUE_DAYS_DEFAULT,
-  criticalDays: FIN_CRITICAL_DAYS,
-  periodFromIso: finFrom,
-  periodToIso: finTo,
-});
-    setFinRows(mapped);
-setFinRep(rep);
-await fetchFinSpendRows();
-
-  } catch (e: any) {
-    console.warn("[director] fetchFinance:", e?.message ?? e);
-    if (nextRows) {
-      setFinRows(nextRows);
-      setFinRep(computeFinanceRep(nextRows, { dueDaysDefault: FIN_DUE_DAYS_DEFAULT, criticalDays: FIN_CRITICAL_DAYS }));
+    } catch (e: any) {
+      console.warn("[director] fetchFinance:", e?.message ?? e);
+      if (nextRows) {
+        setFinRows(nextRows);
+        setFinRep(computeFinanceRep(nextRows, { dueDaysDefault: FIN_DUE_DAYS_DEFAULT, criticalDays: FIN_CRITICAL_DAYS }));
+      }
+      try { await fetchFinSpendRows(); } catch { }
+    } finally {
+      setFinLoading(false);
     }
-try { await fetchFinSpendRows(); } catch {}
-  } finally {
-    setFinLoading(false);
-  }
-}, [finFrom, finTo, fetchFinSpendRows]);
+  }, [finFrom, finTo, fetchFinSpendRows]);
 
 
-const isPaidRow = (r: FinanceRow) => {
-  const amt = nnum(r.amount);
-  const paidAmt = nnum(r.paidAmount);
-  const rest = Math.max(amt - paidAmt, 0);
+  const isPaidRow = (r: FinanceRow) => {
+    const amt = nnum(r.amount);
+    const paidAmt = nnum(r.paidAmount);
+    const rest = Math.max(amt - paidAmt, 0);
 
-  // ╨╡╤Б╨╗╨╕ ╨╛╤Б╤В╨░╤В╨╛╨║ = 0 -> ╤В╨╛╤З╨╜╨╛ ╨╛╨┐╨╗╨░╤З╨╡╨╜╨╛
-  if (amt > 0 && rest <= 0) return true;
+    // ╨╡╤Б╨╗╨╕ ╨╛╤Б╤В╨░╤В╨╛╨║ = 0 -> ╤В╨╛╤З╨╜╨╛ ╨╛╨┐╨╗╨░╤З╨╡╨╜╨╛
+    if (amt > 0 && rest <= 0) return true;
 
-  // ╤Б╤В╨░╤В╤Г╤Б╨╛╨╝ ╨Э╨Х ╤А╨╡╤И╨░╨╡╨╝ (╨╕╨╜╨░╤З╨╡ "╨╛╨┐╨╗╨░╤З╨╡╨╜╨╛ ╤З╨░╤Б╤В╨╕╤З╨╜╨╛" ╨▓╤Л╨║╨╕╨╜╨╡╤В ╤З╨░╤Б╤В╨╕╤З╨╜╤Л╨╡)
-  return false;
-};
+    // ╤Б╤В╨░╤В╤Г╤Б╨╛╨╝ ╨Э╨Х ╤А╨╡╤И╨░╨╡╨╝ (╨╕╨╜╨░╤З╨╡ "╨╛╨┐╨╗╨░╤З╨╡╨╜╨╛ ╤З╨░╤Б╤В╨╕╤З╨╜╨╛" ╨▓╤Л╨║╨╕╨╜╨╡╤В ╤З╨░╤Б╤В╨╕╤З╨╜╤Л╨╡)
+    return false;
+  };
 
-const getDueIso = (r: FinanceRow) =>
-  r.dueDate ??
-  (r.invoiceDate ? addDaysIso(r.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
-  (r.approvedAtIso ? addDaysIso(r.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
+  const getDueIso = (r: FinanceRow) =>
+    r.dueDate ??
+    (r.invoiceDate ? addDaysIso(r.invoiceDate, FIN_DUE_DAYS_DEFAULT) : null) ??
+    (r.approvedAtIso ? addDaysIso(r.approvedAtIso, FIN_DUE_DAYS_DEFAULT) : null);
 
   const preloadDisplayNos = useCallback(async (reqIds: Array<number | string>) => {
-  const needed = Array.from(
-    new Set(
-      reqIds
-        .map(x => String(x ?? '').trim())
-        .filter(Boolean)
-        .filter(id => displayNoByReq[id] == null || submittedAtByReq[id] == null)
-    )
-  );
-  if (!needed.length) return;
+    const needed = Array.from(
+      new Set(
+        reqIds
+          .map(x => String(x ?? '').trim())
+          .filter(Boolean)
+          .filter(id => displayNoByReq[id] == null || submittedAtByReq[id] == null)
+      )
+    );
+    if (!needed.length) return;
 
-  try {
-    const { data, error } = await supabase
-      .from('requests')
-      .select('id, display_no, submitted_at')
-      .in('id', needed);
+    try {
+      const { data, error } = await supabase
+        .from('requests')
+        .select('id, display_no, submitted_at')
+        .in('id', needed);
 
-    if (error) throw error;
+      if (error) throw error;
 
-    const mapDn: Record<string, string> = {};
-    const mapSub: Record<string, string> = {};
+      const mapDn: Record<string, string> = {};
+      const mapSub: Record<string, string> = {};
 
-    for (const r of (data ?? []) as any[]) {
-      const id = String(r?.id ?? '').trim();
-      if (!id) continue;
+      for (const r of (data ?? []) as any[]) {
+        const id = String(r?.id ?? '').trim();
+        if (!id) continue;
 
-      const dn = String(r?.display_no ?? '').trim();
-      const sa = r?.submitted_at ?? null;
+        const dn = String(r?.display_no ?? '').trim();
+        const sa = r?.submitted_at ?? null;
 
-      if (dn) mapDn[id] = dn;
-      if (sa) mapSub[id] = String(sa);
-    }
+        if (dn) mapDn[id] = dn;
+        if (sa) mapSub[id] = String(sa);
+      }
 
-    if (Object.keys(mapDn).length) setDisplayNoByReq(prev => ({ ...prev, ...mapDn }));
-    if (Object.keys(mapSub).length) setSubmittedAtByReq(prev => ({ ...prev, ...mapSub }));
-  } catch (e) {
-    console.warn('[director] preloadDisplayNos]:', (e as any)?.message ?? e);
-  }
-}, [displayNoByReq, submittedAtByReq]);
+      if (Object.keys(mapDn).length) setDisplayNoByReq(prev => ({ ...prev, ...mapDn }));
+      if (Object.keys(mapSub).length) setSubmittedAtByReq(prev => ({ ...prev, ...mapSub }));
+    } catch (e) {
+      console.warn('[director] preloadDisplayNos]:', (e as any)?.message ?? e);
+    }
+  }, [displayNoByReq, submittedAtByReq]);
 
 
   const fetchRows = useCallback(async () => {
@@ -1032,7 +1140,7 @@ const getDueIso = (r: FinanceRow) =>
         uom: r.uom ?? null,
         rik_code: r.rik_code ?? null,
         app_code: r.app_code ?? null,
-       item_kind: r.item_kind ?? null,
+        item_kind: r.item_kind ?? null,
         note: r.note ?? null,
       }));
 
@@ -1073,72 +1181,72 @@ const getDueIso = (r: FinanceRow) =>
       );
 
       const prettyMap: Record<string, string> = {};
-for (const r of data) {
-  const id = String((r as any).id);
-  const pn = String((r as any).proposal_no ?? '').trim();   // тЬЕ PR-0024/2026
-  const short = (r as any).id_short;                       
-  const pretty = pn || (short != null ? `PR-${String(short)}` : '');
-  if (id && pretty) prettyMap[id] = pretty;
-}
+      for (const r of data) {
+        const id = String((r as any).id);
+        const pn = String((r as any).proposal_no ?? '').trim();   // тЬЕ PR-0024/2026
+        const short = (r as any).id_short;
+        const pretty = pn || (short != null ? `PR-${String(short)}` : '');
+        if (id && pretty) prettyMap[id] = pretty;
+      }
 
       let filtered = heads
-  .filter(h => okIds.has(h.id))
-  .map(h => ({ ...h, pretty: prettyMap[h.id] ?? h.pretty ?? null }));
-
+        .filter(h => okIds.has(h.id))
+        .map(h => ({ ...h, pretty: prettyMap[h.id] ?? h.pretty ?? null }));
 
-try {
-  const propIds = filtered.map(h => h.id);
-  if (propIds.length) {
-    const q = await supabase
-      .from('proposal_items')
-      .select('proposal_id')
-      .in('proposal_id', propIds);
 
-    const nonEmpty = new Set((q.data || []).map((r: any) => String(r.proposal_id)));
-    filtered = filtered.filter(h => nonEmpty.has(String(h.id)));
-  }
-} catch {}
-
-setPropsHeads(filtered);
-try {
-  const propIds = filtered.map(h => h.id);
-  if (propIds.length) {
-    const qCnt = await supabase
-      .from('proposal_items')
-      .select('proposal_id')
-      .in('proposal_id', propIds);
-
-    const map: Record<string, number> = {};
-    for (const r of (qCnt.data || []) as any[]) {
-      const pid = String(r?.proposal_id ?? '');
-      if (!pid) continue;
-      map[pid] = (map[pid] || 0) + 1;
-    }
-    setPropItemsCount(map);
-  } else {
-    setPropItemsCount({});
-  }
-} catch {
-  setPropItemsCount({});
-}
+      try {
+        const propIds = filtered.map(h => h.id);
+        if (propIds.length) {
+          const q = await supabase
+            .from('proposal_items')
+            .select('proposal_id')
+            .in('proposal_id', propIds);
+
+          const nonEmpty = new Set((q.data || []).map((r: any) => String(r.proposal_id)));
+          filtered = filtered.filter(h => nonEmpty.has(String(h.id)));
+        }
+      } catch { }
 
-setBuyerPropsCount(filtered.length);
+      setPropsHeads(filtered);
+      try {
+        const propIds = filtered.map(h => h.id);
+        if (propIds.length) {
+          const qCnt = await supabase
+            .from('proposal_items')
+            .select('proposal_id')
+            .in('proposal_id', propIds);
+
+          const map: Record<string, number> = {};
+          for (const r of (qCnt.data || []) as any[]) {
+            const pid = String(r?.proposal_id ?? '');
+            if (!pid) continue;
+            map[pid] = (map[pid] || 0) + 1;
+          }
+          setPropItemsCount(map);
+        } else {
+          setPropItemsCount({});
+        }
+      } catch {
+        setPropItemsCount({});
+      }
 
-try {
-  const propIds = filtered.map(h => h.id);
-  if (propIds.length) {
-    const q = await supabase
-      .from('proposal_items_view')
-      .select('proposal_id')
-      .in('proposal_id', propIds);
+      setBuyerPropsCount(filtered.length);
 
-    setBuyerPositionsCount(!q.error && Array.isArray(q.data) ? q.data.length : 0);
-  } else {
-    setBuyerPositionsCount(0);
-  }
-} catch {
-  setBuyerPositionsCount(0);
-}
+      try {
+        const propIds = filtered.map(h => h.id);
+        if (propIds.length) {
+          const q = await supabase
+            .from('proposal_items_view')
+            .select('proposal_id')
+            .in('proposal_id', propIds);
+
+          setBuyerPositionsCount(!q.error && Array.isArray(q.data) ? q.data.length : 0);
+        } else {
+          setBuyerPositionsCount(0);
+        }
+      } catch {
+        setBuyerPositionsCount(0);
+      }
 
     } catch (e) {
       console.error('[director] proposals list]:', (e as any)?.message ?? e);
@@ -1163,1727 +1271,1746 @@ try {
     })();
   }, [fetchRows, fetchProps]);
 
-useEffect(() => {
-  return () => {
-    try {
-      if (rtToastTimerRef.current) clearTimeout(rtToastTimerRef.current);
-    } catch {}
-  };
-}, []);
+  useEffect(() => {
+    return () => {
+      try {
+        if (rtToastTimerRef.current) clearTimeout(rtToastTimerRef.current);
+      } catch { }
+    };
+  }, []);
 
-useEffect(() => {
-  if (dirTab !== "╨д╨╕╨╜╨░╨╜╤Б╤Л") return;
-  void fetchFinance();
-}, [dirTab, fetchFinance]);
+  useEffect(() => {
+    if (dirTab !== "╨д╨╕╨╜╨░╨╜╤Б╤Л") return;
+    void fetchFinance();
+  }, [dirTab, fetchFinance]);
 
 
   useEffect(() => {
-  const ch = supabase.channel('notif-director-rt')
-    .on('postgres_changes', {
-      event: 'INSERT',
-      schema: 'public',
-      table: 'notifications',
-      filter: "role=eq.director"
-    }, (payload: any) => {
-      const n = payload?.new || {};
-      showRtToast(n.title, n.body);
-      void fetchRows();
-      void fetchProps();
-    })
-    .subscribe();
-
-  return () => {
-  try { ch.unsubscribe(); } catch {}
-  try { supabase.removeChannel(ch); } catch {}
-};
-
-}, [fetchRows, fetchProps, showRtToast]);
-
-
-    // ╨н╨║╤Б╨┐╨╛╤А╤В ╨╖╨░╤П╨▓╨║╨╕ ╨▓ ╨╜╨░╤Б╤В╨╛╤П╤Й╨╕╨╣ XLSX (╨▒╨╡╨╖ ╨┐╤А╨╡╨┤╤Г╨┐╤А╨╡╨╢╨┤╨╡╨╜╨╕╤П Excel)
-const exportRequestExcel = useCallback((g: Group) => {
-  const rows = g.items;
-  if (!rows.length) {
-    Alert.alert('╨н╨║╤Б╨┐╨╛╤А╤В', '╨Э╨╡╤В ╨┐╨╛╨╖╨╕╤Ж╨╕╨╣ ╨┤╨╗╤П ╨▓╤Л╨│╤А╤Г╨╖╨║╨╕.');
-    return;
-  }
+    const ch = supabase.channel('notif-director-rt')
+      .on('postgres_changes', {
+        event: 'INSERT',
+        schema: 'public',
+        table: 'notifications',
+        filter: "role=eq.director"
+      }, (payload: any) => {
+        const n = payload?.new || {};
+        showRtToast(n.title, n.body);
+        void fetchRows();
+        void fetchProps();
+      })
+      .subscribe();
 
-  const safe = (v: any) =>
-    v === null || v === undefined ? '' : String(v).replace(/[\r\n]+/g, ' ').trim();
-
-  const title = labelForRequest(g.request_id);
-  const sheetName =
-    title.replace(/[^\w╨Р-╨п╨░-╤П0-9]/g, '_').slice(0, 31) || '╨Ч╨░╤П╨▓╨║╨░';
-
-  // ╨Ф╨░╨╜╨╜╤Л╨╡ ╨┤╨╗╤П Excel: ╨┐╨╡╤А╨▓╨░╤П ╤Б╤В╤А╨╛╨║╨░ тАФ ╨╖╨░╨│╨╛╨╗╨╛╨▓╨║╨╕
-  const data: any[][] = [];
-  data.push(['тДЦ', '╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡', '╨Ъ╨╛╨╗-╨▓╨╛', '╨Х╨┤. ╨╕╨╖╨╝.', '╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡', '╨Я╤А╨╕╨╝╨╡╤З╨░╨╜╨╕╨╡']);
-
-  rows.forEach((it, idx) => {
-    data.push([
-      idx + 1,
-      safe(it.name_human),
-      safe(it.qty),
-      safe(it.uom),
-      safe(it.app_code),
-      safe(it.note),
-    ]);
-  });
+    return () => {
+      try { ch.unsubscribe(); } catch { }
+      try { supabase.removeChannel(ch); } catch { }
+    };
 
-  try {
-    // 1) ╤Б╨╛╨╖╨┤╨░╤С╨╝ ╨║╨╜╨╕╨│╤Г ╨╕ ╨╗╨╕╤Б╤В
-    const wb = XLSX.utils.book_new();
-    const ws = XLSX.utils.aoa_to_sheet(data);
-
-    // ╤З╤Г╤В╤М-╤З╤Г╤В╤М ╨║╤А╨░╤Б╨╛╤В╤Л: ╤И╨╕╤А╨╕╨╜╨░ ╨║╨╛╨╗╨╛╨╜╨╛╨║
-    ws['!cols'] = [
-      { wch: 4 },   // тДЦ
-      { wch: 40 },  // ╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡
-      { wch: 10 },  // ╨Ъ╨╛╨╗-╨▓╨╛
-      { wch: 10 },  // ╨Х╨┤. ╨╕╨╖╨╝.
-      { wch: 18 },  // ╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡
-      { wch: 60 },  // ╨Я╤А╨╕╨╝╨╡╤З╨░╨╜╨╕╨╡
-    ];
-
-    XLSX.utils.book_append_sheet(wb, ws, sheetName);
-
-    // 2) ╨┐╤А╨╡╨▓╤А╨░╤Й╨░╨╡╨╝ ╨▓ ╨▒╨╕╨╜╨░╤А╨╜╤Л╨╣ ╨╝╨░╤Б╤Б╨╕╨▓
-    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
-
-    if (Platform.OS === 'web') {
-      const blob = new Blob([wbout], {
-        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
-      });
-      const url = URL.createObjectURL(blob);
-      const a = document.createElement('a');
-      a.href = url;
-      a.download = `request-${title}.xlsx`;
-      document.body.appendChild(a);
-      a.click();
-      document.body.removeChild(a);
-      URL.revokeObjectURL(url);
-    } else {
-      Alert.alert(
-        '╨н╨║╤Б╨┐╨╛╤А╤В',
-        'XLSX ╤Н╨║╤Б╨┐╨╛╤А╤В ╤Б╨╡╨╣╤З╨░╤Б ╤А╨╡╨░╨╗╨╕╨╖╨╛╨▓╨░╨╜ ╤В╨╛╨╗╤М╨║╨╛ ╨┤╨╗╤П Web-╨▓╨╡╤А╤Б╨╕╨╕.',
-      );
-    }
-  } catch (e: any) {
-    console.error('[exportRequestExcel]', e?.message ?? e);
-    Alert.alert('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╤Б╤Д╨╛╤А╨╝╨╕╤А╨╛╨▓╨░╤В╤М Excel-╤Д╨░╨╣╨╗');
-  }
-}, [labelForRequest]);
+  }, [fetchRows, fetchProps, showRtToast]);
 
-  const openRequestPdf = useCallback(async (g: any) => {
-  const rid = String(g?.request_id ?? "").trim();
-  if (!rid) return;
 
-  await runPdfTop({
-    busy,
-    supabase,
-    key: `pdf:req:${rid}`,
-    label: "╨Ю╤В╨║╤А╤Л╨▓╨░╤О PDFтАж",
-    mode: "preview",
-    fileName: `╨Ч╨░╤П╨▓╨║╨░_${rid}`,
-    getRemoteUrl: () => exportRequestPdf(rid, "preview"),
-  });
-}, [busy, supabase]);
- 
- 
-    const groups: Group[] = useMemo(() => {
-    const map = new Map<number | string, PendingRow[]>();
-    for (const r of rows) {
-      const k = String(r.request_id ?? '');
-      if (!map.has(k)) map.set(k, []);
-      map.get(k)!.push(r);
+  // ╨н╨║╤Б╨┐╨╛╤А╤В ╨╖╨░╤П╨▓╨║╨╕ ╨▓ ╨╜╨░╤Б╤В╨╛╤П╤Й╨╕╨╣ XLSX (╨▒╨╡╨╖ ╨┐╤А╨╡╨┤╤Г╨┐╤А╨╡╨╢╨┤╨╡╨╜╨╕╤П Excel)
+  const exportRequestExcel = useCallback((g: Group) => {
+    const rows = g.items;
+    if (!rows.length) {
+      notifyInfo('╨н╨║╤Б╨┐╨╛╤А╤В', '╨Э╨╡╤В ╨┐╨╛╨╖╨╕╤Ж╨╕╨╣ ╨┤╨╗╤П ╨▓╤Л╨│╤А╤Г╨╖╨║╨╕.');
+      return;
     }
-    let list = Array.from(map.entries()).map(([request_id, items]) => ({ request_id, items }));
 
-    
-    return list;
-  }, [rows, labelForRequest]);
+    const safe = (v: any) =>
+      v === null || v === undefined ? '' : String(v).replace(/[\r\n]+/g, ' ').trim();
+
+    const title = labelForRequest(g.request_id);
+    const sheetName =
+      title.replace(/[^\w╨Р-╨п╨░-╤П0-9]/g, '_').slice(0, 31) || '╨Ч╨░╤П╨▓╨║╨░';
+
+    // ╨Ф╨░╨╜╨╜╤Л╨╡ ╨┤╨╗╤П Excel: ╨┐╨╡╤А╨▓╨░╤П ╤Б╤В╤А╨╛╨║╨░ тАФ ╨╖╨░╨│╨╛╨╗╨╛╨▓╨║╨╕
+    const data: any[][] = [];
+    data.push(['тДЦ', '╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡', '╨Ъ╨╛╨╗-╨▓╨╛', '╨Х╨┤. ╨╕╨╖╨╝.', '╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡', '╨Я╤А╨╕╨╝╨╡╤З╨░╨╜╨╕╨╡']);
+
+    rows.forEach((it, idx) => {
+      data.push([
+        idx + 1,
+        safe(it.name_human),
+        safe(it.qty),
+        safe(it.uom),
+        safe(it.app_code),
+        safe(it.note),
+      ]);
+    });
 
+    try {
+      // 1) ╤Б╨╛╨╖╨┤╨░╤С╨╝ ╨║╨╜╨╕╨│╤Г ╨╕ ╨╗╨╕╤Б╤В
+      const wb = XLSX.utils.book_new();
+      const ws = XLSX.utils.aoa_to_sheet(data);
+
+      // ╤З╤Г╤В╤М-╤З╤Г╤В╤М ╨║╤А╨░╤Б╨╛╤В╤Л: ╤И╨╕╤А╨╕╨╜╨░ ╨║╨╛╨╗╨╛╨╜╨╛╨║
+      ws['!cols'] = [
+        { wch: 4 },   // тДЦ
+        { wch: 40 },  // ╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡
+        { wch: 10 },  // ╨Ъ╨╛╨╗-╨▓╨╛
+        { wch: 10 },  // ╨Х╨┤. ╨╕╨╖╨╝.
+        { wch: 18 },  // ╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡
+        { wch: 60 },  // ╨Я╤А╨╕╨╝╨╡╤З╨░╨╜╨╕╨╡
+      ];
+
+      XLSX.utils.book_append_sheet(wb, ws, sheetName);
+
+      // 2) ╨┐╤А╨╡╨▓╤А╨░╤Й╨░╨╡╨╝ ╨▓ ╨▒╨╕╨╜╨░╤А╨╜╤Л╨╣ ╨╝╨░╤Б╤Б╨╕╨▓
+      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
+
+      if (Platform.OS === 'web') {
+        const blob = new Blob([wbout], {
+          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
+        });
+        const url = URL.createObjectURL(blob);
+        const a = document.createElement('a');
+        a.href = url;
+        a.download = `request-${title}.xlsx`;
+        document.body.appendChild(a);
+        a.click();
+        document.body.removeChild(a);
+        URL.revokeObjectURL(url);
+      } else {
+        notifyInfo(
+          '╨н╨║╤Б╨┐╨╛╤А╤В',
+          'XLSX ╤Н╨║╤Б╨┐╨╛╤А╤В ╤Б╨╡╨╣╤З╨░╤Б ╤А╨╡╨░╨╗╨╕╨╖╨╛╨▓╨░╨╜ ╤В╨╛╨╗╤М╨║╨╛ ╨┤╨╗╤П Web-╨▓╨╡╤А╤Б╨╕╨╕.',
+        );
+      }
+    } catch (e: any) {
+      console.error('[exportRequestExcel]', e?.message ?? e);
+      notifyError('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╤Б╤Д╨╛╤А╨╝╨╕╤А╨╛╨▓╨░╤В╤М Excel-╤Д╨░╨╣╨╗');
+    }
+  }, [labelForRequest]);
 
-  const foremanRequestsCount = groups.length; // ╨║╨╛╨╗-╨▓╨╛ ╨╖╨░╤П╨▓╨╛╨║
-  const foremanPositionsCount = rows.length;  // ╨║╨╛╨╗-╨▓╨╛ ╨┐╨╛╨╖╨╕╤Ж╨╕╨╣
-
-  
-/* ===== ╨Ъ╨░╤А╤В╨╛╤З╨║╨░ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П (╨б╨Э╨Р╨С╨Ц╨Х╨Э╨Х╨ж) тАФ ╨║╨░╨║ ╤Г ╨╖╨░╤П╨▓╨╛╨║ ===== */
-const ProposalRow = React.memo(({ p, screenLock }: { p: ProposalHead; screenLock: boolean }) => {
-  const pidStr = String(p.id);
-  const pretty = String(p.pretty ?? '').trim();
-  const itemsCount = propItemsCount[pidStr] ?? 0;
+  const openRequestPdf = useCallback(async (g: any) => {
+    const rid = String(g?.request_id ?? "").trim();
+    if (!rid) return;
+
+    await runPdfTop({
+      busy,
+      supabase,
+      key: `pdf:req:${rid}`,
+      label: "╨Ю╤В╨║╤А╤Л╨▓╨░╤О PDFтАж",
+      mode: "preview",
+      fileName: `╨Ч╨░╤П╨▓╨║╨░_${rid}`,
+      getRemoteUrl: () => exportRequestPdf(rid, "preview"),
+    });
+  }, [busy, supabase]);
 
-  // тЬЕ ╨╛╨▒╤К╤П╨▓╨╗╤П╨╡╨╝ ╨Ф╨Ю return (╨░ ╨╜╨╡ ╨▓╨╜╤Г╤В╤А╨╕ JSX)
-  const title = pretty || `#${pidStr.slice(0, 8)}`;
 
-  return (
-    <View style={{ marginBottom: 12 }}>
-      <View style={s.groupHeader}>
-        {/* LEFT */}
-        <View style={{ flex: 1, minWidth: 0 }}>
-          <Text style={s.groupTitle} numberOfLines={1}>
-            {title}
-          </Text>
-
-          <Text style={s.cardMeta} numberOfLines={1}>
-            {fmtDateOnly(p.submitted_at)}
-          </Text>
-        </View>
-
-        {/* RIGHT */}
-        <View style={s.rightStack}>
-  <View style={s.metaPill}>
-    <Text style={s.metaPillText}>{`╨Я╨╛╨╖╨╕╤Ж╨╕╨╣ ${itemsCount}`}</Text>
-  </View>
+  const groups: Group[] = useMemo(() => {
+    const map = new Map<number | string, PendingRow[]>();
+    for (const r of rows) {
+      const k = String(r.request_id ?? '');
+      if (!map.has(k)) map.set(k, []);
+      map.get(k)!.push(r);
+    }
+    let list = Array.from(map.entries()).map(([request_id, items]) => ({ request_id, items }));
 
-  <View style={s.rightStackSpacer} />
 
-  <Pressable
-    disabled={screenLock}
-    onPress={() => {
-  if (screenLock) return;
-  openProposalSheet(pidStr);
+    return list;
+  }, [rows, labelForRequest]);
 
-  // тЬЕ ╨Т╨Р╨Ц╨Э╨Ю: ╨│╤А╤Г╨╖╨╕╨╝ ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╤П ╨Т╨б╨Х╨У╨Ф╨Р, ╨┤╨░╨╢╨╡ ╨╡╤Б╨╗╨╕ loadedByProp ╤Г╨╢╨╡ true
-  void loadProposalAttachments(pidStr);
 
-  // ╤Б╨╛╤Б╤В╨░╨▓ (╨║╨░╨║ ╨▒╤Л╨╗╨╛)
-  void toggleExpand(pidStr);
-}}
+  const foremanRequestsCount = groups.length; // ╨║╨╛╨╗-╨▓╨╛ ╨╖╨░╤П╨▓╨╛╨║
+  const foremanPositionsCount = rows.length;  // ╨║╨╛╨╗-╨▓╨╛ ╨┐╨╛╨╖╨╕╤Ж╨╕╨╣
 
-    style={[s.openBtn, screenLock && { opacity: 0.6 }]}
-  >
-    <Text style={s.openBtnText}>{loadingPropId === pidStr ? 'тАж' : '╨Ю╤В╨║╤А╤Л╤В╤М'}</Text>
-  </Pressable>
-</View>
 
-      </View>
-    </View>
-  );
-});
-const loadProposalAttachments = useCallback(async (pidStr: string) => {
-  const pid = String(pidStr || "").trim();
-  if (!pid) return;
+  /* ===== ╨Ъ╨░╤А╤В╨╛╤З╨║╨░ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П (╨б╨Э╨Р╨С╨Ц╨Х╨Э╨Х╨ж) тАФ ╨║╨░╨║ ╤Г ╨╖╨░╤П╨▓╨╛╨║ ===== */
+  const ProposalRow = React.memo(({ p, screenLock }: { p: ProposalHead; screenLock: boolean }) => {
+    const pidStr = String(p.id);
+    const pretty = String(p.pretty ?? '').trim();
+    const itemsCount = propItemsCount[pidStr] ?? 0;
 
-  // ╤З╤В╨╛╨▒╤Л ╨╜╨╡ ╨┤╨╡╤А╨│╨░╤В╤М 10 ╤А╨░╨╖
-  if (propAttBusyByProp[pid]) return;
-  setPropAttBusyByProp(prev => ({ ...prev, [pid]: true }));
+    // тЬЕ ╨╛╨▒╤К╤П╨▓╨╗╤П╨╡╨╝ ╨Ф╨Ю return (╨░ ╨╜╨╡ ╨▓╨╜╤Г╤В╤А╨╕ JSX)
+    const title = pretty || `#${pidStr.slice(0, 8)}`;
 
-  try {
-    const q = await supabase
-      .from("proposal_attachments")
-      .select("id, file_name, url, group_key, created_at, bucket_id, storage_path")
-      .eq("proposal_id", pid)
-      .order("created_at", { ascending: false });
+    return (
+      <View style={{ marginBottom: 12 }}>
+        <View style={s.groupHeader}>
+          {/* LEFT */}
+          <View style={{ flex: 1, minWidth: 0 }}>
+            <Text style={s.groupTitle} numberOfLines={1}>
+              {title}
+            </Text>
 
-    if (q.error) throw q.error;
+            <Text style={s.cardMeta} numberOfLines={1}>
+              {fmtDateOnly(p.submitted_at)}
+            </Text>
+          </View>
 
-    const raw = (q.data || []) as any[];
+          {/* RIGHT */}
+          <View style={s.rightStack}>
+            <View style={s.metaPill}>
+              <Text style={s.metaPillText}>{`╨Я╨╛╨╖╨╕╤Ж╨╕╨╣ ${itemsCount}`}</Text>
+            </View>
 
-const rows: ProposalAttachmentRow[] = [];
-const seen = new Set<string>();
+            <View style={s.rightStackSpacer} />
 
-for (const r of raw) {
-  const id = String(r?.id ?? "").trim();
-  if (!id) continue;
+            <Pressable
+              disabled={screenLock}
+              onPress={() => {
+                if (screenLock) return;
+                openProposalSheet(pidStr);
 
-  if (seen.has(id)) continue;
-  seen.add(id);
+                // тЬЕ ╨Т╨Р╨Ц╨Э╨Ю: ╨│╤А╤Г╨╖╨╕╨╝ ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╤П ╨Т╨б╨Х╨У╨Ф╨Р, ╨┤╨░╨╢╨╡ ╨╡╤Б╨╗╨╕ loadedByProp ╤Г╨╢╨╡ true
+                void loadProposalAttachments(pidStr);
 
-  let url = (r.url ?? null) as string | null;
+                // ╤Б╨╛╤Б╤В╨░╨▓ (╨║╨░╨║ ╨▒╤Л╨╗╨╛)
+                void toggleExpand(pidStr);
+              }}
 
-  if (!url) {
-    const bucket = String(r.bucket_id ?? "").trim();
-    const path = String(r.storage_path ?? "").trim();
-    if (bucket && path) {
-      try {
-        const s = await supabase.storage.from(bucket).createSignedUrl(path, 60 * 60);
-        if (!s.error && s.data?.signedUrl) url = s.data.signedUrl;
-      } catch {}
-    }
-  }
+              style={[s.openBtn, screenLock && { opacity: 0.6 }]}
+            >
+              <Text style={s.openBtnText}>{loadingPropId === pidStr ? 'тАж' : '╨Ю╤В╨║╤А╤Л╤В╤М'}</Text>
+            </Pressable>
+          </View>
 
-  rows.push({
-    id,
-    file_name: String(r.file_name ?? "file"),
-    url,
-    group_key: r.group_key ?? null,
-    created_at: r.created_at ?? null,
-    bucket_id: r.bucket_id ?? null,
-    storage_path: r.storage_path ?? null,
+        </View>
+      </View>
+    );
   });
-}
+  const loadProposalAttachments = useCallback(async (pidStr: string) => {
+    const pid = String(pidStr || "").trim();
+    if (!pid) return;
 
-setPropAttByProp(prev => ({ ...prev, [pid]: rows }));
+    // ╤З╤В╨╛╨▒╤Л ╨╜╨╡ ╨┤╨╡╤А╨│╨░╤В╤М 10 ╤А╨░╨╖
+    if (propAttBusyByProp[pid]) return;
+    setPropAttBusyByProp(prev => ({ ...prev, [pid]: true }));
 
-  } catch (e: any) {
-    console.warn("[director] loadProposalAttachments:", e?.message ?? e);
-    setPropAttByProp(prev => ({ ...prev, [pid]: [] }));
-  } finally {
-    setPropAttBusyByProp(prev => ({ ...prev, [pid]: false }));
-  }
-}, [supabase, propAttBusyByProp]);
- /* ---------- toggleExpand: ╨│╤А╤Г╨╖╨╕╨╝ ╤Б╨╛╤Б╤В╨░╨▓ ╨╕ HTML (web) ---------- */
-const toggleExpand = useCallback(async (pid: string) => {
-  const pidStr = String(pid);
+    try {
+      const q = await supabase
+        .from("proposal_attachments")
+        .select("id, file_name, url, group_key, created_at, bucket_id, storage_path")
+        .eq("proposal_id", pid)
+        .order("created_at", { ascending: false });
 
-  // тЬЕ ╨░╨╜╤В╨╕-╤Б╨┐╨░╨╝ ╨┐╨╛ ╨▓╤А╨╡╨╝╨╡╨╜╨╕ (╨╛╤З╨╡╨╜╤М ╨▓╨░╨╢╨╜╨╛ ╨╜╨░ ╤В╨╡╨╗╨╡╤Д╨╛╨╜╨╡)
-  const now = Date.now();
-  if (now - lastTapRef.current < 350) return;
-  lastTapRef.current = now;
+      if (q.error) throw q.error;
 
-  // тЬЕ ╨╡╤Б╨╗╨╕ ╤Б╨╡╨╣╤З╨░╤Б ╤Г╨╢╨╡ ╨╕╨┤╨╡╤В ╨╖╨░╨│╤А╤Г╨╖╨║╨░ ╨║╨░╨║╨╛╨│╨╛-╤В╨╛ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П тАФ ╨╜╨╡ ╤Б╤В╨░╤А╤В╤Г╨╡╨╝ ╨▓╤В╨╛╤А╤Г╤О
-  const anyLoading = Object.values(loadingPropRef.current).some(Boolean);
-  if (anyLoading) return;
+      const raw = (q.data || []) as any[];
 
-  // тЬЕ ╤Г╨╢╨╡ ╨╖╨░╨│╤А╤Г╨╢╨╡╨╜╨╛ тАФ ╨▓╤Л╤Е╨╛╨┤╨╕╨╝
-  if (loadedByProp[pidStr]) return;
+      const rows: ProposalAttachmentRow[] = [];
+      const seen = new Set<string>();
 
-  // тЬЕ ╨╡╤Б╨╗╨╕ ╤Г╨╢╨╡ ╨│╤А╤Г╨╖╨╕╨╝ ╨╕╨╝╨╡╨╜╨╜╨╛ ╤Н╤В╨╛ тАФ ╨╕╨│╨╜╨╛╤А
-  if (loadingPropRef.current[pidStr]) return;
+      for (const r of raw) {
+        const id = String(r?.id ?? "").trim();
+        if (!id) continue;
 
-  // тЬЕ UI: ╨┐╨╛╨║╨░╨╖╤Л╨▓╨░╨╡╨╝ "..." ╨╜╨░ ╨║╨╜╨╛╨┐╨║╨╡
-  setLoadingPropId(pidStr);
+        if (seen.has(id)) continue;
+        seen.add(id);
 
-  loadingPropRef.current[pidStr] = true;
+        let url = (r.url ?? null) as string | null;
 
-  try {
-    await busy.run(async () => {
-      try {
-        let base: any[] | null = null;
-let plain: any[] | null = null;
-
-// 1) SNAPSHOT (╤Б╨░╨╝╤Л╨╣ тАЬ╨╕╤Б╤В╨╕╨╜╨╜╤Л╨╣тАЭ, ╨╡╤Б╨╗╨╕ ╨╡╤Б╤В╤М)
-const qSnap = await supabase
-  .from("proposal_snapshot_items")
-  .select("id, request_item_id, rik_code, name_human, uom, app_code, total_qty")
-  .eq("proposal_id", pidStr)
-  .order("id", { ascending: true });
-
-if (!qSnap.error && Array.isArray(qSnap.data) && qSnap.data.length > 0) {
-  base = qSnap.data;
-}
-
-// 2) VIEW (fallback, ╨╡╤Б╨╗╨╕ snapshot ╨┐╤Г╤Б╤В)
-if (!base) {
-  const qView = await supabase
-    .from("proposal_items_view")
-    .select("id, request_item_id, rik_code, name_human, uom, app_code, total_qty")
-    .eq("proposal_id", pidStr)
-    .order("id", { ascending: true });
-
-  if (!qView.error && Array.isArray(qView.data) && qView.data.length > 0) {
-    base = qView.data;
-  }
-}
+        if (!url) {
+          const bucket = String(r.bucket_id ?? "").trim();
+          const path = String(r.storage_path ?? "").trim();
+          if (bucket && path) {
+            try {
+              const s = await supabase.storage.from(bucket).createSignedUrl(path, 60 * 60);
+              if (!s.error && s.data?.signedUrl) url = s.data.signedUrl;
+            } catch { }
+          }
+        }
 
-// 3) PLAIN (fallback + ╨╕╤Б╤В╨╛╤З╨╜╨╕╨║ ╤Ж╨╡╨╜╤Л)
-const qPlain = await supabase
-  .from("proposal_items")
-  .select("id, request_item_id, rik_code, name_human, uom, app_code, qty, price")
-  .eq("proposal_id", pidStr)
-  .order("id", { ascending: true });
+        rows.push({
+          id,
+          file_name: String(r.file_name ?? "file"),
+          url,
+          group_key: r.group_key ?? null,
+          created_at: r.created_at ?? null,
+          bucket_id: r.bucket_id ?? null,
+          storage_path: r.storage_path ?? null,
+        });
+      }
 
-if (!qPlain.error && Array.isArray(qPlain.data) && qPlain.data.length > 0) {
-  plain = qPlain.data;
-}
+      setPropAttByProp(prev => ({ ...prev, [pid]: rows }));
 
-// ---- ╤Д╨╛╤А╨╝╨╕╤А╤Г╨╡╨╝ ╨╕╤В╨╛╨│ ╨▒╨╡╨╖ ╨┐╨╡╤А╨╡╤В╨╕╤А╨░╨╜╨╕╤П ----
-const priceByReqItemId: Record<string, number> = {};
-if (plain) {
-  for (const r of plain as any[]) {
-    const rid = String(r?.request_item_id ?? "").trim();
-    const pr = r?.price;
-    if (rid && pr != null && !Number.isNaN(Number(pr))) {
-      priceByReqItemId[rid] = Number(pr);
+    } catch (e: any) {
+      console.warn("[director] loadProposalAttachments:", e?.message ?? e);
+      setPropAttByProp(prev => ({ ...prev, [pid]: [] }));
+    } finally {
+      setPropAttBusyByProp(prev => ({ ...prev, [pid]: false }));
     }
-  }
-}
+  }, [supabase, propAttBusyByProp]);
+  /* ---------- toggleExpand: ╨│╤А╤Г╨╖╨╕╨╝ ╤Б╨╛╤Б╤В╨░╨▓ ╨╕ HTML (web) ---------- */
+  const toggleExpand = useCallback(async (pid: string) => {
+    const pidStr = String(pid);
 
-const effective = base ?? (plain ? plain.map((r: any) => ({ ...r, total_qty: r.qty })) : []);
-
-let norm = (effective ?? []).map((r: any, i: number) => {
-  const reqItemId = r.request_item_id != null ? String(r.request_item_id) : null;
-  const price =
-    r.price != null
-      ? Number(r.price)
-      : (reqItemId ? (priceByReqItemId[reqItemId] ?? null) : null);
-
-  return {
-    id: Number(r.id ?? i),
-    request_item_id: reqItemId,
-    rik_code: r.rik_code ?? null,
-    name_human: r.name_human ?? "",
-    uom: r.uom ?? null,
-    app_code: r.app_code ?? null,
-    total_qty: Number(r.total_qty ?? r.qty ?? 0),
-    price: price,
-    item_kind: null as any,
-  };
-});
+    // тЬЕ ╨░╨╜╤В╨╕-╤Б╨┐╨░╨╝ ╨┐╨╛ ╨▓╤А╨╡╨╝╨╡╨╜╨╕ (╨╛╤З╨╡╨╜╤М ╨▓╨░╨╢╨╜╨╛ ╨╜╨░ ╤В╨╡╨╗╨╡╤Д╨╛╨╜╨╡)
+    const now = Date.now();
+    if (now - lastTapRef.current < 350) return;
+    lastTapRef.current = now;
 
-        // item_kind ╨╕╨╖ request_items
-        try {
-          const ids = Array.from(
-            new Set(norm.map((x) => String(x.request_item_id ?? "")).filter(Boolean))
-          );
-          if (ids.length) {
-            const qKinds = await supabase
-  .from("request_items")
-  .select("id, item_kind, note")
-  .in("id", ids);
-
-
-            if (!qKinds.error && Array.isArray(qKinds.data)) {
-  const mapKind: Record<string, string> = {};
-  const mapNote: Record<string, string> = {};
-
-  for (const rr of qKinds.data as any[]) {
-    const id = String(rr.id ?? "").trim();
-    const k = String(rr.item_kind ?? "").trim();
-    const n = String(rr.note ?? "").trim();
-
-    if (id && k) mapKind[id] = k;
-    if (id && n) mapNote[id] = n;
-  }
+    // тЬЕ ╨╡╤Б╨╗╨╕ ╤Б╨╡╨╣╤З╨░╤Б ╤Г╨╢╨╡ ╨╕╨┤╨╡╤В ╨╖╨░╨│╤А╤Г╨╖╨║╨░ ╨║╨░╨║╨╛╨│╨╛-╤В╨╛ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П тАФ ╨╜╨╡ ╤Б╤В╨░╤А╤В╤Г╨╡╨╝ ╨▓╤В╨╛╤А╤Г╤О
+    const anyLoading = Object.values(loadingPropRef.current).some(Boolean);
+    if (anyLoading) return;
 
-  // item_kind тАФ ╨║╨░╨║ ╨▒╤Л╨╗╨╛
-  norm = norm.map((x) => ({
-    ...x,
-    item_kind: x.request_item_id ? mapKind[String(x.request_item_id)] ?? null : null,
-  }));
+    // тЬЕ ╤Г╨╢╨╡ ╨╖╨░╨│╤А╤Г╨╢╨╡╨╜╨╛ тАФ ╨▓╤Л╤Е╨╛╨┤╨╕╨╝
+    if (loadedByProp[pidStr]) return;
 
-  // тЬЕ ╨Ф╨Ю╨С╨Р╨Т╨Ш╨Ы╨Ш: ╨║╤Н╤И note ╨┤╨╗╤П proposal-sheet (╤З╤В╨╛╨▒╤Л ╨▒╤Л╨╗ ╤А╤Г╤Б╤Б╨║╨╕╨╣ ╨║╨╛╨╜╤В╨╡╨║╤Б╤В)
-  if (Object.keys(mapNote).length) {
-    setReqItemNoteById(prev => ({ ...prev, ...mapNote }));
-  }
-}
+    // тЬЕ ╨╡╤Б╨╗╨╕ ╤Г╨╢╨╡ ╨│╤А╤Г╨╖╨╕╨╝ ╨╕╨╝╨╡╨╜╨╜╨╛ ╤Н╤В╨╛ тАФ ╨╕╨│╨╜╨╛╤А
+    if (loadingPropRef.current[pidStr]) return;
 
-          }
-        } catch {}
+    // тЬЕ UI: ╨┐╨╛╨║╨░╨╖╤Л╨▓╨░╨╡╨╝ "..." ╨╜╨░ ╨║╨╜╨╛╨┐╨║╨╡
+    setLoadingPropId(pidStr);
 
-        setItemsByProp((prev) => ({ ...prev, [pidStr]: norm }));
+    loadingPropRef.current[pidStr] = true;
 
-// тЬЕ ╨┐╨╛╨┤╤В╤П╨│╨╕╨▓╨░╨╡╨╝ request_id(╤Л) ╨╕ ╨╕╤Е ╨║╨╛╨╜╤В╨╡╨║╤Б╤В ╨┤╨╗╤П ╨╕╨╜╤Д╨╛-╨▒╨╗╨╛╨║╨░ ╨▓ proposal-sheet
-try {
-  const reqItemIds = norm.map(x => x.request_item_id);
-  await preloadProposalRequestIds(pidStr, reqItemIds);
-} catch {}
+    try {
+      await busy.run(async () => {
+        try {
+          let base: any[] | null = null;
+          let plain: any[] | null = null;
+
+          // 1) SNAPSHOT (╤Б╨░╨╝╤Л╨╣ тАЬ╨╕╤Б╤В╨╕╨╜╨╜╤Л╨╣тАЭ, ╨╡╤Б╨╗╨╕ ╨╡╤Б╤В╤М)
+          const qSnap = await supabase
+            .from("proposal_snapshot_items")
+            .select("id, request_item_id, rik_code, name_human, uom, app_code, total_qty")
+            .eq("proposal_id", pidStr)
+            .order("id", { ascending: true });
+
+          if (!qSnap.error && Array.isArray(qSnap.data) && qSnap.data.length > 0) {
+            base = qSnap.data;
+          }
 
-// тЬЕ ╨Т╨Ю╨в ╨Ш╨Ь╨Х╨Э╨Э╨Ю ╨б╨о╨Ф╨Р. ╨Э╨Х ╨Т╨л╨и╨Х. ╨Э╨Х ╨Э╨Ш╨Ц╨Х.
-try {
-  await loadProposalAttachments(pidStr);
-} catch {}
+          // 2) VIEW (fallback, ╨╡╤Б╨╗╨╕ snapshot ╨┐╤Г╤Б╤В)
+          if (!base) {
+            const qView = await supabase
+              .from("proposal_items_view")
+              .select("id, request_item_id, rik_code, name_human, uom, app_code, total_qty")
+              .eq("proposal_id", pidStr)
+              .order("id", { ascending: true });
 
-} finally {
-  setLoadedByProp((prev) => ({ ...prev, [pidStr]: true }));
-}
-}, { key: `dir:loadProp:${pidStr}`, label: "╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╤Б╨╛╤Б╤В╨░╨▓тАж", minMs: 900 });
+            if (!qView.error && Array.isArray(qView.data) && qView.data.length > 0) {
+              base = qView.data;
+            }
+          }
 
-    // web html (╨╛╨┐╤Ж╨╕╨╛╨╜╨░╨╗╤М╨╜╨╛)
-    if (Platform.OS === "web") {
-      setTimeout(async () => {
-        try {
-          if (pdfHtmlByProp[pidStr]) return;
-          const { buildProposalPdfHtml } = await import("../../src/lib/rik_api");
-          const html = await buildProposalPdfHtml(pidStr as any);
-          setPdfHtmlByProp((prev) => ({ ...prev, [pidStr]: html }));
-        } catch {}
-      }, 0);
-    }
-  } catch (e: any) {
-    Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╤Б╤В╤А╨╛╨║╨╕ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П");
-    setItemsByProp((prev) => ({ ...prev, [pidStr]: [] }));
-    setLoadedByProp((prev) => ({ ...prev, [pidStr]: true }));
-  } finally {
-    loadingPropRef.current[pidStr] = false;
-
-    // тЬЕ ╤Б╨╜╨╕╨╝╨░╨╡╨╝ "..." ╤В╨╛╨╗╤М╨║╨╛ ╨╡╤Б╨╗╨╕ ╤Н╤В╨╛ ╨▒╤Л╨╗╨╛ ╤В╨╡╨║╤Г╤Й╨╡╨╡
-    setLoadingPropId((cur) => (cur === pidStr ? null : cur));
-  }
-}, [busy, loadedByProp, pdfHtmlByProp, supabase, preloadProposalRequestIds, loadProposalAttachments]);
+          // 3) PLAIN (fallback + ╨╕╤Б╤В╨╛╤З╨╜╨╕╨║ ╤Ж╨╡╨╜╤Л)
+          const qPlain = await supabase
+            .from("proposal_items")
+            .select("id, request_item_id, rik_code, name_human, uom, app_code, qty, price")
+            .eq("proposal_id", pidStr)
+            .order("id", { ascending: true });
 
-async function onDirectorReturn(proposalId: string | number, note?: string) {
-  const pidStr = String(proposalId);
+          if (!qPlain.error && Array.isArray(qPlain.data) && qPlain.data.length > 0) {
+            plain = qPlain.data;
+          }
 
-  try {
-    const chk = await supabase
-      .from('proposals')
-      .select('sent_to_accountant_at')
-      .eq('id', pidStr)
-      .maybeSingle();
+          // ---- ╤Д╨╛╤А╨╝╨╕╤А╤Г╨╡╨╝ ╨╕╤В╨╛╨│ ╨▒╨╡╨╖ ╨┐╨╡╤А╨╡╤В╨╕╤А╨░╨╜╨╕╤П ----
+          const priceByReqItemId: Record<string, number> = {};
+          if (plain) {
+            for (const r of plain as any[]) {
+              const rid = String(r?.request_item_id ?? "").trim();
+              const pr = r?.price;
+              if (rid && pr != null && !Number.isNaN(Number(pr))) {
+                priceByReqItemId[rid] = Number(pr);
+              }
+            }
+          }
 
-    if (!chk.error && chk.data?.sent_to_accountant_at) {
-      Alert.alert('╨Э╨╡╨╗╤М╨╖╤П ╨▓╨╡╤А╨╜╤Г╤В╤М', '╨Ф╨╛╨║╤Г╨╝╨╡╨╜╤В ╤Г╨╢╨╡ ╤Г ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А╨╕╨╕. ╨Т╨╡╤А╨╜╤Г╤В╤М ╨╝╨╛╨╢╨╡╤В ╤В╨╛╨╗╤М╨║╨╛ ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А.');
-      return;
-    }
+          const effective = base ?? (plain ? plain.map((r: any) => ({ ...r, total_qty: r.qty })) : []);
+
+          let norm = (effective ?? []).map((r: any, i: number) => {
+            const reqItemId = r.request_item_id != null ? String(r.request_item_id) : null;
+            const price =
+              r.price != null
+                ? Number(r.price)
+                : (reqItemId ? (priceByReqItemId[reqItemId] ?? null) : null);
+
+            return {
+              id: Number(r.id ?? i),
+              request_item_id: reqItemId,
+              rik_code: r.rik_code ?? null,
+              name_human: r.name_human ?? "",
+              uom: r.uom ?? null,
+              app_code: r.app_code ?? null,
+              total_qty: Number(r.total_qty ?? r.qty ?? 0),
+              price: price,
+              item_kind: null as any,
+            };
+          });
 
-    // тЬЕ ╨Т╨Р╨Ц╨Э╨Ю: ╤Н╤В╨╛ ╨Ы╨Ю╨Р╨Ф╨Х╨а ╨Ф╨Ы╨п ╨Ъ╨а╨Р╨б╨Э╨Ю╨Щ ╨Ъ╨Э╨Ю╨Я╨Ъ╨Ш "╨Т╨╡╤А╨╜╤Г╤В╤М/╨г╨┤╨░╨╗╨╕╤В╤М"
-    setPropReturnId(pidStr);
+          // item_kind ╨╕╨╖ request_items
+          try {
+            const ids = Array.from(
+              new Set(norm.map((x) => String(x.request_item_id ?? "")).filter(Boolean))
+            );
+            if (ids.length) {
+              const qKinds = await supabase
+                .from("request_items")
+                .select("id, item_kind, note")
+                .in("id", ids);
 
-    // тЬЕ ╨С╨╡╤А╤С╨╝ ╨Т╨б╨Х request_item_id ╨╕╨╖ ╨С╨Ф
-    const q = await supabase
-      .from('proposal_items')
-      .select('request_item_id')
-      .eq('proposal_id', pidStr);
 
-    if (q.error) throw q.error;
+              if (!qKinds.error && Array.isArray(qKinds.data)) {
+                const mapKind: Record<string, string> = {};
+                const mapNote: Record<string, string> = {};
 
-    const ids = Array.from(new Set(
-      (q.data || []).map((r: any) => String(r?.request_item_id || '').trim()).filter(Boolean)
-    ));
+                for (const rr of qKinds.data as any[]) {
+                  const id = String(rr.id ?? "").trim();
+                  const k = String(rr.item_kind ?? "").trim();
+                  const n = String(rr.note ?? "").trim();
 
-    if (!ids.length) {
-      Alert.alert('╨Я╤Г╤Б╤В╨╛', '╨Т ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╕ ╨╜╨╡╤В ╤Б╤В╤А╨╛╨║ ╨┤╨╗╤П ╨▓╨╛╨╖╨▓╤А╨░╤В╨░.');
-      return;
-    }
+                  if (id && k) mapKind[id] = k;
+                  if (id && n) mapNote[id] = n;
+                }
 
-    const comment = (note || '').trim() || '╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛ ╨┤╨╕╤А╨╡╨║╤В╨╛╤А╨╛╨╝';
+                // item_kind тАФ ╨║╨░╨║ ╨▒╤Л╨╗╨╛
+                norm = norm.map((x) => ({
+                  ...x,
+                  item_kind: x.request_item_id ? mapKind[String(x.request_item_id)] ?? null : null,
+                }));
 
-    const payload = ids.map((rid) => ({
-      request_item_id: rid,
-      decision: 'rejected',
-      comment,
-    }));
+                // тЬЕ ╨Ф╨Ю╨С╨Р╨Т╨Ш╨Ы╨Ш: ╨║╤Н╤И note ╨┤╨╗╤П proposal-sheet (╤З╤В╨╛╨▒╤Л ╨▒╤Л╨╗ ╤А╤Г╤Б╤Б╨║╨╕╨╣ ╨║╨╛╨╜╤В╨╡╨║╤Б╤В)
+                if (Object.keys(mapNote).length) {
+                  setReqItemNoteById(prev => ({ ...prev, ...mapNote }));
+                }
+              }
 
-    const res = await supabase.rpc('director_decide_proposal_items', {
-      p_proposal_id: pidStr,
-      p_decisions: payload,
-      p_finalize: true,
-    });
+            }
+          } catch { }
 
-    if (res.error) throw res.error;
+          setItemsByProp((prev) => ({ ...prev, [pidStr]: norm }));
 
-    setItemsByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
-    setLoadedByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
-    setPdfHtmlByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
+          // тЬЕ ╨┐╨╛╨┤╤В╤П╨│╨╕╨▓╨░╨╡╨╝ request_id(╤Л) ╨╕ ╨╕╤Е ╨║╨╛╨╜╤В╨╡╨║╤Б╤В ╨┤╨╗╤П ╨╕╨╜╤Д╨╛-╨▒╨╗╨╛╨║╨░ ╨▓ proposal-sheet
+          try {
+            const reqItemIds = norm.map(x => x.request_item_id);
+            await preloadProposalRequestIds(pidStr, reqItemIds);
+          } catch { }
 
-    await fetchProps();
-    closeSheet();
-  } catch (e: any) {
-    Alert.alert('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨▓╨╡╤А╨╜╤Г╤В╤М ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡');
-  } finally {
-    setPropReturnId(null);
-  }
-}
+          // тЬЕ ╨Т╨Ю╨в ╨Ш╨Ь╨Х╨Э╨Э╨Ю ╨б╨о╨Ф╨Р. ╨Э╨Х ╨Т╨л╨и╨Х. ╨Э╨Х ╨Э╨Ш╨Ц╨Х.
+          try {
+            await loadProposalAttachments(pidStr);
+          } catch { }
 
-return (
-  <View style={[s.container, { backgroundColor: UI.bg }]}>
-    <DirectorDashboard
-  HEADER_MAX={HEADER_MAX}
-  HEADER_MIN={HEADER_MIN}
-  onScroll={Animated.event([{ nativeEvent: { contentOffset: { y: scrollY } } }], { useNativeDriver: false })}
-  headerHeight={headerHeight}
-  headerShadow={headerShadow}
-  titleSize={titleSize}
-  subOpacity={subOpacity}
-
-  dirTab={dirTab}
-  setDirTab={setDirTab}
-  tab={tab}
-  setTab={setTab}
-  closeSheet={closeSheet}
-
-  groups={groups as any}
-  propsHeads={propsHeads as any}
-  loadingRows={loadingRows}
-  loadingProps={loadingProps}
-
-  foremanRequestsCount={foremanRequestsCount}
-  foremanPositionsCount={foremanPositionsCount}
-  buyerPropsCount={buyerPropsCount}
-  buyerPositionsCount={buyerPositionsCount}
-
-  labelForRequest={(rid: any) => labelForRequest(rid)}
-  fmtDateOnly={fmtDateOnly}
-  submittedAtByReq={submittedAtByReq}
-
-  openRequestSheet={openRequestSheet as any}
-  ProposalRow={ProposalRow as any}
-  screenLock={screenLock}
-
-  ensureSignedIn={ensureSignedIn}
-  fetchRows={fetchRows as any}
-  fetchProps={fetchProps as any}
-  rtToast={rtToast}
-
-  finLoading={finLoading}
-  finRows={finRows as any}
-  finRep={finRep as any}
-  finSpendRows={finSpendRows as any}
-  money={money}
-  FIN_DUE_DAYS_DEFAULT={FIN_DUE_DAYS_DEFAULT}
-  FIN_CRITICAL_DAYS={FIN_CRITICAL_DAYS}
-  fetchFinance={fetchFinance as any}
-  finFrom={finFrom}
-  finTo={finTo}
-
-  openFinancePage={(page: any) => openFinancePage(page)}
-  openReports={() => void openReports()}
-  reportsPeriodShort={repPeriodShort}
-/>
-
-{(() => {
-  const periodShort =
-    finFrom || finTo
-      ? `${finFrom ? fmtDateOnly(finFrom) : "тАФ"} тЖТ ${finTo ? fmtDateOnly(finTo) : "тАФ"}`
-      : "╨Т╨╡╤Б╤М ╨┐╨╡╤А╨╕╨╛╨┤";
-
-  const title =
-    finPage === "debt" ? "╨Ф╨╛╨╗╨│╨╕ ╨╕ ╤А╨╕╤Б╨║╨╕"
-    : finPage === "spend" ? "╨а╨░╤Б╤Е╨╛╨┤╤Л (╨┐╨╡╤А╨╕╨╛╨┤)"
-    : finPage === "kind" ? (finKindName ? `${finKindName}: ╨┐╨╛╤Б╤В╨░╨▓╤Й╨╕╨║╨╕` : "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║╨╕")
-    : finPage === "supplier" ? String((finSupplier as any)?.supplier ?? "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║")
-    : "╨д╨╕╨╜╨░╨╜╤Б╤Л";
-
-  const supNameForKey = String((finSupplier as any)?.supplier ?? "").trim();
-  const topPdfKey =
-    finPage === "supplier" ? `pdf:director:supplier:${supNameForKey}` : "pdf:director:finance";
-  const supplierPdfBusy = !!supNameForKey && busy.isBusy(`pdf:director:supplier:${supNameForKey}`);
-
- 
-  const onCloseTop = () => {
-    if (finPage !== "home") {
-      popFin();
-      return;
-    }
-    closeFinance();
-  };
+        } finally {
+          setLoadedByProp((prev) => ({ ...prev, [pidStr]: true }));
+        }
+      }, { key: `dir:loadProp:${pidStr}`, label: "╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╤Б╨╛╤Б╤В╨░╨▓тАж", minMs: 900 });
 
-  return (
-    <DirectorFinanceCardModal
-      visible={finOpen}
-      onClose={onCloseTop}
-      title={title}
-      periodShort={periodShort}
-      loading={finLoading || busy.isBusy(topPdfKey)}
-      onOpenPeriod={() => setFinPeriodOpen(true)}
-      onRefresh={() => void fetchFinance()}
-      onPdf={finPage === "supplier" ? onSupplierPdf : onFinancePdf}
-      overlay={
-        finPeriodOpen ? (
-          <PeriodPickerSheet
-            visible={finPeriodOpen}
-            onClose={() => setFinPeriodOpen(false)}
-            initialFrom={finFrom || ""}
-            initialTo={finTo || ""}
-            onApply={(from: string, to: string) => {
-              setFinFrom(from || null);
-              setFinTo(to || null);
-              setFinPeriodOpen(false);
-              void fetchFinance();
-            }}
-            onClear={() => {
-              setFinFrom(null);
-              setFinTo(null);
-              setFinPeriodOpen(false);
-              void fetchFinance();
-            }}
-            ui={{
-              cardBg: UI.cardBg,
-              text: UI.text,
-              sub: UI.sub,
-              border: "rgba(255,255,255,0.14)",
-              accentBlue: "#3B82F6",
-              approve: "#22C55E",
-            }}
-          />
-        ) : null
+      // web html (╨╛╨┐╤Ж╨╕╨╛╨╜╨░╨╗╤М╨╜╨╛)
+      if (Platform.OS === "web") {
+        setTimeout(async () => {
+          try {
+            if (pdfHtmlByProp[pidStr]) return;
+            const { buildProposalPdfHtml } = await import("../../src/lib/rik_api");
+            const html = await buildProposalPdfHtml(pidStr as any);
+            setPdfHtmlByProp((prev) => ({ ...prev, [pidStr]: html }));
+          } catch { }
+        }, 0);
       }
-    >
-      {finPage === "home" ? (
-        <View>
-          <Pressable onPress={() => pushFin("debt")} style={[s.mobCard, { marginBottom: 10 }]}>
-            <Text style={{ color: UI.text, fontWeight: "900" }}>╨Ю╨▒╤П╨╖╨░╤В╨╡╨╗╤М╤Б╤В╨▓╨░</Text>
-          </Pressable>
-
-          <Pressable onPress={() => pushFin("spend")} style={[s.mobCard, { marginBottom: 10 }]}>
-            <Text style={{ color: UI.text, fontWeight: "900" }}>╨а╨░╤Б╤Е╨╛╨┤╤Л</Text>
-          </Pressable>
-        </View>
-      ) : finPage === "debt" ? (
-        <DirectorFinanceDebtModal
-          loading={finLoading}
-          rep={finRep?.report}
-          money={money}
-          FIN_CRITICAL_DAYS={FIN_CRITICAL_DAYS}
-          openSupplier={(srow: any) => openSupplier(srow)}
-        />
-      ) : finPage === "spend" ? (
-        <DirectorFinanceSpendModal
-          visible={true as any} 
-          loading={finLoading}
-          sum={finRep?.summary}
-          spendRows={finSpendRows}
-          money={money}
-          onOpenKind={(kindName, list) => openFinKind(kindName, list)}
-          onOpenSupplier={(supplierName: string) => openSupplier({ supplier: supplierName } as any)}
-        />
-      ) : finPage === "kind" ? (
-        <DirectorFinanceKindSuppliersModal
-          loading={finLoading}
-          kindName={finKindName}
-          list={finKindList}
-          money={money}
-          onOpenSupplier={(payload: any) => openSupplier(payload)}
-        />
-      ) : finPage === "supplier" ? (
-        <DirectorFinanceSupplierModal
-          loading={finLoading || supplierPdfBusy}
-          onPdf={onSupplierPdf}
-          supplier={finSupplier}
-          money={money}
-          fmtDateOnly={fmtDateOnly}
-        />
-      ) : null}
-    </DirectorFinanceCardModal>
-  );
-})()}
-{(() => {
-  const kpi: RepKpi | null = (repData as any)?.kpi ?? null;
-  const rows: RepRow[] = Array.isArray((repData as any)?.rows) ? (repData as any).rows : [];
-  const who: RepWho[] = Array.isArray((repData as any)?.discipline_who) ? (repData as any).discipline_who : [];
-
-  const pct = (a: number, b: number) => {
-    const aa = Number(a || 0);
-    const bb = Number(b || 0);
-    if (!bb) return "0%";
-    return `${Math.round((aa / bb) * 100)}%`;
-  };
-
-  const issuesTotal = Number(kpi?.issues_total ?? 0);
-  const issuesNoObj = Number(kpi?.issues_without_object ?? 0);
-  const itemsTotal = Number(kpi?.items_total ?? 0);
-  const itemsNoReq = Number(kpi?.items_without_request ?? 0);
+    } catch (e: any) {
+      notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+      setItemsByProp((prev) => ({ ...prev, [pidStr]: [] }));
+      setLoadedByProp((prev) => ({ ...prev, [pidStr]: true }));
+    } finally {
+      loadingPropRef.current[pidStr] = false;
 
-  return (
-    <DirectorFinanceCardModal
-      visible={repOpen}
-      onClose={closeReports}
-      title="╨д╨░╨║╤В ╨▓╤Л╨┤╨░╤З╨╕ (╤Б╨║╨╗╨░╨┤)"
-      periodShort={repPeriodShort}
-      loading={repLoading}
-      onOpenPeriod={() => setRepPeriodOpen(true)}
-      onRefresh={async () => {
-  await fetchReportOptions();         
-  await applyObjectFilter(repObjectName); 
-}}
-      onPdf={() => Alert.alert("PDF", "╨Я╨╛╨┤╨║╨╗╤О╤З╨╕╨╝ ╨┐╨╛╤Б╨╗╨╡ UI (╨┤╨░╨╜╨╜╤Л╨╡ ╤Г╨╢╨╡ ╨│╨╛╤В╨╛╨▓╤Л).")}
-     overlay={
-  repPeriodOpen ? (
-    <PeriodPickerSheet
-      visible={repPeriodOpen}
-      onClose={() => setRepPeriodOpen(false)}
-      initialFrom={repFrom || ""}
-      initialTo={repTo || ""}
-      onApply={(from: string, to: string) => void applyReportPeriod(from || null, to || null)}
-      onClear={() => {
-        const to = isoDate(new Date());
-        const from = isoDate(minusDays(30));
-        void applyReportPeriod(from, to);
-      }}
-      ui={{
-        cardBg: UI.cardBg,
-        text: UI.text,
-        sub: UI.sub,
-        border: "rgba(255,255,255,0.14)",
-        accentBlue: "#3B82F6",
-        approve: "#22C55E",
-      }}
-    />
-  ) : repObjOpen ? (
-    <RNModal
-      isVisible={repObjOpen}
-      onBackdropPress={() => setRepObjOpen(false)}
-      onBackButtonPress={() => setRepObjOpen(false)}
-      backdropOpacity={0.55}
-      useNativeDriver
-      useNativeDriverForBackdrop
-      hideModalContentWhileAnimating
-      style={{ margin: 0, justifyContent: "flex-end" }}
-    >
-      <View style={s.sheet}>
-        <View style={s.sheetHandle} />
-
-        <View style={{ flexDirection: "row", justifyContent: "space-between", paddingHorizontal: 14, paddingBottom: 10 }}>
-          <Text style={{ color: UI.text, fontWeight: "900", fontSize: 16 }}>
-            {`╨Ю╨▒╤К╨╡╨║╤В╤Л (${repOptObjects?.length ?? 0})`}
-          </Text>
-
-          <Pressable onPress={() => setRepObjOpen(false)}>
-            <Text style={{ color: UI.sub, fontWeight: "900" }}>╨Ч╨░╨║╤А╤Л╤В╤М</Text>
-          </Pressable>
-        </View>
+      // тЬЕ ╤Б╨╜╨╕╨╝╨░╨╡╨╝ "..." ╤В╨╛╨╗╤М╨║╨╛ ╨╡╤Б╨╗╨╕ ╤Н╤В╨╛ ╨▒╤Л╨╗╨╛ ╤В╨╡╨║╤Г╤Й╨╡╨╡
+      setLoadingPropId((cur) => (cur === pidStr ? null : cur));
+    }
+  }, [busy, loadedByProp, pdfHtmlByProp, supabase, preloadProposalRequestIds, loadProposalAttachments]);
 
-        <FlatList
-          data={repOptObjects || []}
-          keyExtractor={(x, i) => `${x}:${i}`}
-          keyboardShouldPersistTaps="handled"
-          style={{ maxHeight: 420 }}
-          renderItem={({ item }) => (
-            <Pressable
-              onPress={async () => {
-                setRepObjOpen(false);
-                await applyObjectFilter(item);
-              }}
-              style={[s.mobCard, { marginHorizontal: 12, marginBottom: 10 }]}
-            >
-              <Text style={{ color: UI.text, fontWeight: "900" }} numberOfLines={2}>
-                {item}
-              </Text>
-            </Pressable>
-          )}
-        />
-      </View>
-    </RNModal>
-  ) : null
-}
->
-      <View style={{ marginBottom: 10 }}>
-        <Text style={{ color: UI.sub, fontWeight: "900", marginBottom: 6 }}>
-          ╨Ю╨▒╤К╨╡╨║╤В
-        </Text>
-
-        <View style={{ flexDirection: "row", flexWrap: "wrap" }}>
- 
-  <Pressable
-    onPress={() => void applyObjectFilter(null)}
-    style={[s.tab, !repObjectName && s.tabActive, { marginRight: 8, marginBottom: 8 }]}
-  >
-    <Text style={{ color: !repObjectName ? UI.text : UI.sub, fontWeight: "900" }}>
-      ╨Т╤Б╨╡
-    </Text>
-  </Pressable>
-
-  <Pressable
-    onPress={() => setRepObjOpen(true)}
-    style={[s.tab, repObjectName && s.tabActive, { marginRight: 8, marginBottom: 8 }]}
-  >
-    <Text style={{ color: repObjectName ? UI.text : UI.sub, fontWeight: "900" }}>
-      {`╨Ю╨▒╤К╨╡╨║╤В╤Л ┬╖ ${(repOptObjects?.length ?? 0)}`}
-    </Text>
-  </Pressable>
- 
-  {repObjectName ? (
-    <Pressable
-      onPress={() => setRepObjOpen(true)}
-      style={[s.tab, s.tabActive, { marginRight: 8, marginBottom: 8 }]}
-    >
-      <Text numberOfLines={1} style={{ color: UI.text, fontWeight: "900", maxWidth: 220 }}>
-        {repObjectName}
-      </Text>
-    </Pressable>
-  ) : null}
-
-  {repOptLoading ? (
-    <Text style={{ color: UI.sub, fontWeight: "800", marginLeft: 4, marginTop: 8 }}>тАж</Text>
-  ) : null}
-</View>
+  async function onDirectorReturn(proposalId: string | number, note?: string) {
+    const pidStr = String(proposalId);
 
-      </View>
+    try {
+      const chk = await supabase
+        .from('proposals')
+        .select('sent_to_accountant_at')
+        .eq('id', pidStr)
+        .maybeSingle();
 
-      {/* KPI */}
-      <View style={{ marginBottom: 10 }}>
-        <View style={{ flexDirection: "row", gap: 8 }}>
-          <View style={[s.kpiPillHalf, { flex: 1 }]}>
-            <Text style={s.kpiLabel}>╨Ф╨╛╨║╤Г╨╝╨╡╨╜╤В╨╛╨▓</Text>
-            <Text style={s.kpiValue}>{repLoading ? "тАж" : String(issuesTotal)}</Text>
-          </View>
+      if (!chk.error && chk.data?.sent_to_accountant_at) {
+        notifyInfo('╨Э╨╡╨╗╤М╨╖╤П ╨▓╨╡╤А╨╜╤Г╤В╤М', '╨Ф╨╛╨║╤Г╨╝╨╡╨╜╤В ╤Г╨╢╨╡ ╤Г ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А╨╕╨╕. ╨Т╨╡╤А╨╜╤Г╤В╤М ╨╝╨╛╨╢╨╡╤В ╤В╨╛╨╗╤М╨║╨╛ ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А.');
+        return;
+      }
 
-          <View style={[s.kpiPillHalf, { flex: 1 }]}>
-            <Text style={s.kpiLabel}>╨Я╨╛╨╖╨╕╤Ж╨╕╨╣</Text>
-            <Text style={s.kpiValue}>{repLoading ? "тАж" : String(itemsTotal)}</Text>
-          </View>
-        </View>
+      // тЬЕ ╨Т╨Р╨Ц╨Э╨Ю: ╤Н╤В╨╛ ╨Ы╨Ю╨Р╨Ф╨Х╨а ╨Ф╨Ы╨п ╨Ъ╨а╨Р╨б╨Э╨Ю╨Щ ╨Ъ╨Э╨Ю╨Я╨Ъ╨Ш "╨Т╨╡╤А╨╜╤Г╤В╤М/╨г╨┤╨░╨╗╨╕╤В╤М"
+      setPropReturnId(pidStr);
 
-        <View style={{ height: 8 }} />
+      // тЬЕ ╨С╨╡╤А╤С╨╝ ╨Т╨б╨Х request_item_id ╨╕╨╖ ╨С╨Ф
+      const q = await supabase
+        .from('proposal_items')
+        .select('request_item_id')
+        .eq('proposal_id', pidStr);
 
-        <View style={{ flexDirection: "row", gap: 8 }}>
-          <View style={[s.kpiPillHalf, { flex: 1 }]}>
-            <Text style={s.kpiLabel}>╨С╨╡╨╖ ╨╛╨▒╤К╨╡╨║╤В╨░</Text>
-            <Text style={s.kpiValue}>
-              {repLoading ? "тАж" : `${issuesNoObj} ┬╖ ${pct(issuesNoObj, issuesTotal)}`}
-            </Text>
-          </View>
+      if (q.error) throw q.error;
 
-          <View style={[s.kpiPillHalf, { flex: 1 }]}>
-            <Text style={s.kpiLabel}>╨С╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕</Text>
-            <Text style={s.kpiValue}>
-              {repLoading ? "тАж" : `${itemsNoReq} ┬╖ ${pct(itemsNoReq, itemsTotal)}`}
-            </Text>
-          </View>
-        </View>
-      </View>
+      const ids = Array.from(new Set(
+        (q.data || []).map((r: any) => String(r?.request_item_id || '').trim()).filter(Boolean)
+      ));
 
-      {/* Tabs */}
-      <View style={{ flexDirection: "row", marginBottom: 10 }}>
-        {(["materials", "discipline"] as RepTab[]).map((t) => {
-          const active = repTab === t;
-          return (
-            <Pressable
-              key={t}
-              onPress={() => setRepTab(t)}
-              style={[s.tab, active && s.tabActive, { marginRight: 8 }]}
-            >
-              <Text style={{ color: active ? UI.text : UI.sub, fontWeight: "900" }}>
-                {t === "materials" ? "╨Ь╨░╤В╨╡╤А╨╕╨░╨╗╤Л" : "╨Ф╨╕╤Б╤Ж╨╕╨┐╨╗╨╕╨╜╨░"}
-              </Text>
-            </Pressable>
-          );
-        })}
-      </View>
+      if (!ids.length) {
+        notifyInfo('╨Я╤Г╤Б╤В╨╛', '╨Т ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╕ ╨╜╨╡╤В ╤Б╤В╤А╨╛╨║ ╨┤╨╗╤П ╨▓╨╛╨╖╨▓╤А╨░╤В╨░.');
+        return;
+      }
 
-      {/* Content */}
-      {repTab === "materials" ? (
-        <FlatList
-          data={rows}
-          keyExtractor={(x, idx) => `${x.rik_code}:${x.uom}:${idx}`}
-          removeClippedSubviews={false}
-          keyboardShouldPersistTaps="handled"
-          showsVerticalScrollIndicator={false}
-          renderItem={({ item }) => {
-            const qAll = Number(item.qty_total || 0);
-            const qNoReq = Number(item.qty_without_request || 0);
-            const docs = Number(item.docs_cnt || 0);
-            const docsNoReq = Number(item.docs_without_request || 0);
-
-            return (
-              <View style={[s.mobCard, { marginBottom: 10 }]}>
-                <View style={s.mobMain}>
-                  <Text style={s.mobTitle} numberOfLines={2}>
-                    {item.rik_code}
-                  </Text>
-                  <Text style={s.mobMeta} numberOfLines={2}>
-                    {`╨Т╤Л╨┤╨░╨╜╨╛: ${qAll} ${item.uom} ┬╖ ╨┤╨╛╨║ ${docs}`}
-                    {qNoReq > 0 ? ` ┬╖ ╨▒╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕: ${qNoReq} (${docsNoReq} ╨┤╨╛╨║)` : ""}
-                  </Text>
-                </View>
-              </View>
-            );
-          }}
-          ListEmptyComponent={
-            !repLoading ? (
-              <Text style={{ opacity: 0.7, color: UI.sub, paddingVertical: 8 }}>
-                ╨Э╨╡╤В ╨▓╤Л╨┤╨░╤З ╨╖╨░ ╨▓╤Л╨▒╤А╨░╨╜╨╜╤Л╨╣ ╨┐╨╡╤А╨╕╨╛╨┤.
-              </Text>
-            ) : null
-          }
-        />
-      ) : (
-        <FlatList
-          data={who}
-          keyExtractor={(x, idx) => `${x.who}:${idx}`}
-          removeClippedSubviews={false}
-          keyboardShouldPersistTaps="handled"
-          showsVerticalScrollIndicator={false}
-          renderItem={({ item }) => (
-            <View style={[s.mobCard, { marginBottom: 10 }]}>
-              <View style={s.mobMain}>
-                <Text style={s.mobTitle} numberOfLines={1}>{item.who}</Text>
-                <Text style={s.mobMeta} numberOfLines={1}>
-                  {`╨Я╨╛╨╖╨╕╤Ж╨╕╨╣ ╨▒╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕: ${String(item.items_cnt ?? 0)}`}
-                </Text>
-              </View>
-            </View>
-          )}
-          ListEmptyComponent={
-            !repLoading ? (
-              <Text style={{ opacity: 0.7, color: UI.sub, paddingVertical: 8 }}>
-                ╨Э╨╡╤В ╨┤╨░╨╜╨╜╤Л╤Е ╨┐╨╛ ╨┤╨╕╤Б╤Ж╨╕╨┐╨╗╨╕╨╜╨╡ ╨╖╨░ ╨┐╨╡╤А╨╕╨╛╨┤.
-              </Text>
-            ) : null
-          }
-        />
-      )}
-
-      {/* Bottom actions (Excel placeholder) */}
-      <View style={{ marginTop: 10, flexDirection: "row", gap: 8 }}>
-        <Pressable
-          onPress={() => Alert.alert("Excel", "╨Я╨╛╨┤╨║╨╗╤О╤З╨╕╨╝ ╨┐╨╛╤Б╨╗╨╡ UI (╨┤╨░╨╜╨╜╤Л╨╡ ╤Г╨╢╨╡ ╨│╨╛╤В╨╛╨▓╤Л).")}
-          style={[s.openBtn, { paddingVertical: 10, paddingHorizontal: 14, backgroundColor: UI.btnNeutral }]}
-        >
-          <Text style={[s.openBtnText, { fontSize: 12 }]}>Excel</Text>
-        </Pressable>
-
-        <Pressable
-  onPress={() => void applyObjectFilter(null)}
-          style={[s.openBtn, { paddingVertical: 10, paddingHorizontal: 14, backgroundColor: "rgba(255,255,255,0.06)" }]}
-        >
-          <Text style={[s.openBtnText, { fontSize: 12 }]}>╨Т╤Б╨╡ ╨╛╨▒╤К╨╡╨║╤В╤Л</Text>
-        </Pressable>
-      </View>
-    </DirectorFinanceCardModal>
-  );
-})()}
-
-     <RNModal
-  isVisible={isSheetOpen}
-  onBackdropPress={closeSheet}
-  onBackButtonPress={closeSheet}
-  backdropOpacity={0.55}
-  useNativeDriver
-  useNativeDriverForBackdrop
-  hideModalContentWhileAnimating
-  style={{ margin: 0, justifyContent: 'flex-end' }}
->
-
-                 <View style={s.sheet}>
-    <View style={s.sheetHandle} />
-
-    {/* TOP BAR */}
-    <View style={s.sheetTopBar}>
-      <Text style={s.sheetTitle} numberOfLines={1}>
-        {sheetKind === 'request' && sheetRequest
-          ? `╨Ч╨░╤П╨▓╨║╨░ ${labelForRequest(sheetRequest.request_id)}`
-          : sheetKind === 'proposal' && sheetProposalId
-            ? (() => {
-                const p = propsHeads.find(x => String(x.id) === String(sheetProposalId));
-                const pretty = String(p?.pretty ?? '').trim();
-                return pretty ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ ${pretty}` : `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ #${String(sheetProposalId).slice(0, 8)}`;
-              })()
-            : 'тАФ'}
-      </Text>
-
-      <Pressable onPress={closeSheet} style={s.sheetCloseBtn}>
-        <Text style={s.sheetCloseText}>╨б╨▓╨╡╤А╨╜╤Г╤В╤М</Text>
-      </Pressable>
-    </View>
+      const comment = (note || '').trim() || '╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛ ╨┤╨╕╤А╨╡╨║╤В╨╛╤А╨╛╨╝';
 
-    {/* ===== REQUEST (╨┐╤А╨╛╤А╨░╨▒) ===== */}
-    {sheetKind === 'request' && sheetRequest ? (
-      <View style={{ flex: 1, minHeight: 0 }}>
-        {/* NOTE */}
-        {(() => {
-          const headerNote = sheetRequest.items.find(x => x.note)?.note || null;
-          if (!headerNote) return null;
-
-          const lines = headerNote
-            .split(';')
-            .map(x => x.trim())
-            .filter(Boolean)
-            .slice(0, 4);
-
-          if (!lines.length) return null;
-
-          return (
-            <View style={s.reqNoteBox}>
-              {lines.map((line, idx) => (
-                <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
-                  {line}
-                </Text>
-              ))}
-            </View>
-          );
-        })()}
-
-        <FlatList
-          data={sheetRequest.items}
-          keyExtractor={(it, idx) => (it.request_item_id ? `mri:${it.request_item_id}` : `mri:${idx}`)}
-          contentContainerStyle={{ paddingBottom: 12 }}
-          keyboardShouldPersistTaps="handled"
-          nestedScrollEnabled
-          scrollEnabled
-          showsVerticalScrollIndicator={false}
-          renderItem={({ item: it }) => (
-            <View style={s.mobCard}>
-              <View style={s.mobMain}>
-                <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>
-  <Text style={[s.mobTitle, { marginRight: 8 }]} numberOfLines={3}>
-    {it.name_human}
-  </Text>
-
-  {it.item_kind ? (
-    <View style={[s.kindPill, { marginTop: 4 }]}>
-      <Text style={s.kindPillText}>
-        {it.item_kind === 'material' ? '╨Ь╨░╤В╨╡╤А╨╕╨░╨╗'
-          : it.item_kind === 'work' ? '╨а╨░╨▒╨╛╤В╨░'
-          : it.item_kind === 'service' ? '╨г╤Б╨╗╤Г╨│╨░'
-          : it.item_kind}
-      </Text>
-    </View>
-  ) : null}
-</View>
+      const payload = ids.map((rid) => ({
+        request_item_id: rid,
+        decision: 'rejected',
+        comment,
+      }));
 
+      const res = await supabase.rpc('director_decide_proposal_items', {
+        p_proposal_id: pidStr,
+        p_decisions: payload,
+        p_finalize: true,
+      });
 
-                <Text style={s.mobMeta} numberOfLines={2}>
-                  {`${it.qty} ${it.uom || ''}`.trim()}
-                  {it.app_code ? ` ┬╖ ${it.app_code}` : ''}
-                </Text>
-              </View>
+      if (res.error) throw res.error;
 
-              <RejectItemButton
-  disabled={!it.request_item_id || actingId === it.request_item_id}
-  loading={actingId === it.request_item_id}
-  onPress={async () => {
-    if (!it.request_item_id) return;
-    setActingId(it.request_item_id);
-    try {
-      const { error } = await supabase.rpc('reject_request_item', {
-        request_item_id: it.request_item_id,
-        reason: null,
-      });
-      if (error) throw error;
+      setItemsByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
+      setLoadedByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
+      setPdfHtmlByProp(m => { const c = { ...m }; delete c[pidStr]; return c; });
 
-      setRows(prev => prev.filter(r => r.request_item_id !== it.request_item_id));
-      setSheetRequest(prev => prev
-        ? ({ ...prev, items: prev.items.filter(x => x.request_item_id !== it.request_item_id) })
-        : prev
-      );
+      await fetchProps();
+      closeSheet();
     } catch (e: any) {
-      Alert.alert('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨┐╨╛╨╖╨╕╤Ж╨╕╤О');
+      notifyError('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨▓╨╡╤А╨╜╤Г╤В╤М ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡');
     } finally {
-      setActingId(null);
+      setPropReturnId(null);
     }
-  }}
-/>
-            </View>
-          )}
-        />
-{/* ===== REQUEST ACTIONS (PROD) ===== */}
-<View style={s.reqActionsBottom}>
-  {/* тЬЕ Delete тАФ LEFT */}
-  <View style={s.actionBtnSquare}>
-    <DeleteAllButton
-      disabled={screenLock || reqDeleteId === sheetRequest.request_id || reqSendId === sheetRequest.request_id}
-      loading={reqDeleteId === sheetRequest.request_id}
-      accessibilityLabel="╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г"
-      onPress={() => {
-        const doIt = async () => {
-          setReqDeleteId(sheetRequest.request_id);
-          try {
-            const reqId = toFilterId(sheetRequest.request_id);
-            if (reqId == null) throw new Error("request_id ╨┐╤Г╤Б╤В╨╛╨╣");
-
-            const { error } = await supabase.rpc("reject_request_all", {
-              p_request_id: String(reqId),
-              p_reason: null,
-            });
-            if (error) throw error;
-
-            setRows(prev => prev.filter(r => r.request_id !== sheetRequest.request_id));
-            closeSheet();
-          } catch (e: any) {
-            Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨▓╤Б╨╡ ╨┐╨╛╨╖╨╕╤Ж╨╕╨╕");
-          } finally {
-            setReqDeleteId(null);
+  }
+
+  return (
+    <View style={[s.container, { backgroundColor: UI.bg }]}>
+      <DirectorDashboard
+        HEADER_MAX={HEADER_MAX}
+        HEADER_MIN={HEADER_MIN}
+        onScroll={Animated.event([{ nativeEvent: { contentOffset: { y: scrollY } } }], { useNativeDriver: false })}
+        headerHeight={headerHeight}
+        headerShadow={headerShadow}
+        titleSize={titleSize}
+        subOpacity={subOpacity}
+
+        dirTab={dirTab}
+        setDirTab={setDirTab}
+        tab={tab}
+        setTab={setTab}
+        closeSheet={closeSheet}
+
+        groups={groups as any}
+        propsHeads={propsHeads as any}
+        loadingRows={loadingRows}
+        loadingProps={loadingProps}
+
+        foremanRequestsCount={foremanRequestsCount}
+        foremanPositionsCount={foremanPositionsCount}
+        buyerPropsCount={buyerPropsCount}
+        buyerPositionsCount={buyerPositionsCount}
+
+        labelForRequest={(rid: any) => labelForRequest(rid)}
+        fmtDateOnly={fmtDateOnly}
+        submittedAtByReq={submittedAtByReq}
+
+        openRequestSheet={openRequestSheet as any}
+        ProposalRow={ProposalRow as any}
+        screenLock={screenLock}
+
+        ensureSignedIn={ensureSignedIn}
+        fetchRows={fetchRows as any}
+        fetchProps={fetchProps as any}
+        rtToast={rtToast}
+
+        finLoading={finLoading}
+        finRows={finRows as any}
+        finRep={finRep as any}
+        finSpendRows={finSpendRows as any}
+        money={money}
+        FIN_DUE_DAYS_DEFAULT={FIN_DUE_DAYS_DEFAULT}
+        FIN_CRITICAL_DAYS={FIN_CRITICAL_DAYS}
+        fetchFinance={fetchFinance as any}
+        finFrom={finFrom}
+        finTo={finTo}
+
+        openFinancePage={(page: any) => openFinancePage(page)}
+        openReports={() => void openReports()}
+        reportsPeriodShort={repPeriodShort}
+      />
+
+      {(() => {
+        const periodShort =
+          finFrom || finTo
+            ? `${finFrom ? fmtDateOnly(finFrom) : "тАФ"} тЖТ ${finTo ? fmtDateOnly(finTo) : "тАФ"}`
+            : "╨Т╨╡╤Б╤М ╨┐╨╡╤А╨╕╨╛╨┤";
+
+        const title =
+          finPage === "debt" ? "╨Ф╨╛╨╗╨│╨╕ ╨╕ ╤А╨╕╤Б╨║╨╕"
+            : finPage === "spend" ? "╨а╨░╤Б╤Е╨╛╨┤╤Л (╨┐╨╡╤А╨╕╨╛╨┤)"
+              : finPage === "kind" ? (finKindName ? `${finKindName}: ╨┐╨╛╤Б╤В╨░╨▓╤Й╨╕╨║╨╕` : "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║╨╕")
+                : finPage === "supplier" ? String((finSupplier as any)?.supplier ?? "╨Я╨╛╤Б╤В╨░╨▓╤Й╨╕╨║")
+                  : "╨д╨╕╨╜╨░╨╜╤Б╤Л";
+
+        const supNameForKey = String((finSupplier as any)?.supplier ?? "").trim();
+        const topPdfKey =
+          finPage === "supplier" ? `pdf:director:supplier:${supNameForKey}` : "pdf:director:finance";
+        const supplierPdfBusy = !!supNameForKey && busy.isBusy(`pdf:director:supplier:${supNameForKey}`);
+
+
+        const onCloseTop = () => {
+          if (finPage !== "home") {
+            popFin();
+            return;
           }
+          closeFinance();
         };
 
-        if (Platform.OS === "web") {
-          // @ts-ignore
-          const ok = window.confirm("╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г?\n\n╨Ю╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨Т╨б╨о ╨╖╨░╤П╨▓╨║╤Г ╨▓╨╝╨╡╤Б╤В╨╡ ╤Б╨╛ ╨▓╤Б╨╡╨╝╨╕ ╨┐╨╛╨╖╨╕╤Ж╨╕╤П╨╝╨╕?");
-          if (!ok) return;
-          void doIt();
-          return;
-        }
-
-        Alert.alert(
-          "╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г?",
-          "╨Т╤Л ╤Г╨▓╨╡╤А╨╡╨╜╤Л, ╤З╤В╨╛ ╤Е╨╛╤В╨╕╤В╨╡ ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨Т╨б╨о ╨╖╨░╤П╨▓╨║╤Г ╨▓╨╝╨╡╤Б╤В╨╡ ╤Б╨╛ ╨▓╤Б╨╡╨╝╨╕ ╨┐╨╛╨╖╨╕╤Ж╨╕╤П╨╝╨╕?",
-          [
-            { text: "╨Ю╤В╨╝╨╡╨╜╨░", style: "cancel" },
-            { text: "╨Ф╨░, ╤Г╨┤╨░╨╗╨╕╤В╤М", style: "destructive", onPress: () => void doIt() },
-          ],
+        return (
+          <DirectorFinanceCardModal
+            visible={finOpen}
+            onClose={onCloseTop}
+            title={title}
+            periodShort={periodShort}
+            loading={finLoading || busy.isBusy(topPdfKey)}
+            onOpenPeriod={() => setFinPeriodOpen(true)}
+            onRefresh={() => void fetchFinance()}
+            onPdf={finPage === "supplier" ? onSupplierPdf : onFinancePdf}
+            overlay={
+              finPeriodOpen ? (
+                <PeriodPickerSheet
+                  visible={finPeriodOpen}
+                  onClose={() => setFinPeriodOpen(false)}
+                  initialFrom={finFrom || ""}
+                  initialTo={finTo || ""}
+                  onApply={(from: string, to: string) => {
+                    setFinFrom(from || null);
+                    setFinTo(to || null);
+                    setFinPeriodOpen(false);
+                    void fetchFinance();
+                  }}
+                  onClear={() => {
+                    setFinFrom(null);
+                    setFinTo(null);
+                    setFinPeriodOpen(false);
+                    void fetchFinance();
+                  }}
+                  ui={{
+                    cardBg: UI.cardBg,
+                    text: UI.text,
+                    sub: UI.sub,
+                    border: "rgba(255,255,255,0.14)",
+                    accentBlue: "#3B82F6",
+                    approve: "#22C55E",
+                  }}
+                />
+              ) : null
+            }
+          >
+            {finPage === "home" ? (
+              <View>
+                <Pressable onPress={() => pushFin("debt")} style={[s.mobCard, { marginBottom: 10 }]}>
+                  <Text style={{ color: UI.text, fontWeight: "900" }}>╨Ю╨▒╤П╨╖╨░╤В╨╡╨╗╤М╤Б╤В╨▓╨░</Text>
+                </Pressable>
+
+                <Pressable onPress={() => pushFin("spend")} style={[s.mobCard, { marginBottom: 10 }]}>
+                  <Text style={{ color: UI.text, fontWeight: "900" }}>╨а╨░╤Б╤Е╨╛╨┤╤Л</Text>
+                </Pressable>
+              </View>
+            ) : finPage === "debt" ? (
+              <DirectorFinanceDebtModal
+                loading={finLoading}
+                rep={{
+                  debtAmount: Number(finRep?.summary?.toPay ?? 0),
+                  debtCount: (finRep?.report?.suppliers ?? []).reduce(
+                    (acc: number, s: any) => acc + Number(s?.count ?? 0),
+                    0,
+                  ),
+                  overdueAmount: (finRep?.report?.suppliers ?? [])
+                    .filter((s: any) => Number(s?.overdueCount ?? 0) > 0)
+                    .reduce((acc: number, s: any) => acc + Number(s?.toPay ?? 0), 0),
+                  overdueCount: Number(finRep?.summary?.overdueCount ?? 0),
+                  criticalAmount: (finRep?.report?.suppliers ?? [])
+                    .filter((s: any) => Number(s?.criticalCount ?? 0) > 0)
+                    .reduce((acc: number, s: any) => acc + Number(s?.toPay ?? 0), 0),
+                  criticalCount: (finRep?.report?.suppliers ?? []).reduce(
+                    (acc: number, s: any) => acc + Number(s?.criticalCount ?? 0),
+                    0,
+                  ),
+                  suppliers: finRep?.report?.suppliers ?? [],
+                  leader: (finRep?.report?.suppliers ?? [])[0] ?? null,
+                }}
+                money={money}
+                FIN_CRITICAL_DAYS={FIN_CRITICAL_DAYS}
+                openSupplier={(srow: any) => openSupplier(srow)}
+              />
+            ) : finPage === "spend" ? (
+              <DirectorFinanceSpendModal
+                visible={true as any}
+                loading={finLoading}
+                sum={finRep?.summary}
+                spendRows={finSpendRows}
+                money={money}
+                onOpenKind={(kindName, list) => openFinKind(kindName, list)}
+                onOpenSupplier={(supplierName: string) => openSupplier({ supplier: supplierName } as any)}
+              />
+            ) : finPage === "kind" ? (
+              <DirectorFinanceKindSuppliersModal
+                loading={finLoading}
+                kindName={finKindName}
+                list={finKindList}
+                money={money}
+                onOpenSupplier={(payload: any) => openSupplier(payload)}
+              />
+            ) : finPage === "supplier" ? (
+              <DirectorFinanceSupplierModal
+                loading={finLoading || supplierPdfBusy}
+                onPdf={onSupplierPdf}
+                supplier={finSupplier}
+                money={money}
+                fmtDateOnly={fmtDateOnly}
+              />
+            ) : null}
+          </DirectorFinanceCardModal>
         );
-      }}
-    />
-  </View>
-
-  <View style={s.sp8} />
-
-  {/* PDF тАФ CENTER */}
-  {(() => {
-    const rid = String(sheetRequest.request_id ?? "").trim();
-    const pdfKey = `pdf:req:${rid}`;
-    const pdfBusy = busy.isBusy(pdfKey);
-
-    return (
-      <Pressable
-        disabled={!rid || pdfBusy || screenLock}
-        onPress={async () => {
-          if (!rid || pdfBusy || screenLock) return;
-          try {
-            await openRequestPdf(sheetRequest);
-          } catch (e: any) {
-            if (String(e?.message ?? "").toLowerCase().includes("busy")) return;
-            Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "PDF ╨╜╨╡ ╤Б╤Д╨╛╤А╨╝╨╕╤А╨╛╨▓╨░╨╜");
-          }
-        }}
-        style={[
-          s.actionBtnWide,
-          { backgroundColor: UI.btnNeutral, opacity: (!rid || pdfBusy || screenLock) ? 0.6 : 1 },
-        ]}
-      >
-        <Text style={s.actionText}>{pdfBusy ? "PDFтАж" : "PDF"}</Text>
-      </Pressable>
-    );
-  })()}
-
-  <View style={s.sp8} />
-
-  {/* Excel тАФ CENTER */}
-  <Pressable
-    disabled={screenLock}
-    onPress={() => {
-      if (screenLock) return;
-      exportRequestExcel(sheetRequest);
-    }}
-    style={[
-      s.actionBtnWide,
-      { backgroundColor: UI.btnNeutral, opacity: screenLock ? 0.6 : 1 },
-    ]}
-  >
-    <Text style={s.actionText}>Excel</Text>
-  </Pressable>
-
-  <View style={s.sp8} />
-
-  {/* тЬЕ Approve/Send тАФ RIGHT */}
-  {(() => {
-    const disabled =
-      screenLock ||
-      reqDeleteId === sheetRequest.request_id ||
-      reqSendId === sheetRequest.request_id ||
-      (sheetRequest.items?.length ?? 0) === 0;
-
-    return (
-      <View style={s.actionBtnSquare}>
-        <SendPrimaryButton
-          variant="green"
-          disabled={disabled}
-          loading={reqSendId === sheetRequest.request_id}
-          onPress={async () => {
-            if (disabled) return;
-
-            setReqSendId(sheetRequest.request_id);
-            try {
-              const reqId = toFilterId(sheetRequest.request_id);
-              if (reqId == null) throw new Error("request_id ╨┐╤Г╤Б╤В╨╛╨╣");
-
-              const reqIdStr = String(reqId);
+      })()}
+      {(() => {
+        const kpi: RepKpi | null = (repData as any)?.kpi ?? null;
+        const rows: RepRow[] = Array.isArray((repData as any)?.rows) ? (repData as any).rows : [];
+        const who: RepWho[] = Array.isArray((repData as any)?.discipline_who) ? (repData as any).discipline_who : [];
+
+        const pct = (a: number, b: number) => {
+          const aa = Number(a || 0);
+          const bb = Number(b || 0);
+          if (!bb) return "0%";
+          return `${Math.round((aa / bb) * 100)}%`;
+        };
 
-              const updItems = await supabase
-                .from("request_items")
-                .update({ status: "╨Ъ ╨╖╨░╨║╤Г╨┐╨║╨╡" })
-                .eq("request_id", reqIdStr)
-                .neq("status", "╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛");
-              if (updItems.error) throw updItems.error;
-
-              const updReq = await supabase
-                .from("requests")
-                .update({ status: "╨Ъ ╨╖╨░╨║╤Г╨┐╨║╨╡" })
-                .eq("id", reqIdStr);
-              if (updReq.error) throw updReq.error;
-
-              setRows(prev => prev.filter(r => r.request_id !== sheetRequest.request_id));
-              await fetchProps();
-
-              closeSheet();
-              showSuccess(`╨Ч╨░╤П╨▓╨║╨░ ${labelForRequest(sheetRequest.request_id)} ╤Г╤В╨▓╨╡╤А╨╢╨┤╨╡╨╜╨░ ╨╕ ╨╛╤В╨┐╤А╨░╨▓╨╗╨╡╨╜╨░ ╤Б╨╜╨░╨▒╨╢╨╡╨╜╤Ж╤Г`);
-            } catch (e: any) {
-              Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╤Г╤В╨▓╨╡╤А╨┤╨╕╤В╤М ╨╕ ╨╛╤В╨┐╤А╨░╨▓╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г");
-            } finally {
-              setReqSendId(null);
+        const issuesTotal = Number(kpi?.issues_total ?? 0);
+        const issuesNoObj = Number(kpi?.issues_without_object ?? 0);
+        const itemsTotal = Number(kpi?.items_total ?? 0);
+        const itemsNoReq = Number(kpi?.items_without_request ?? 0);
+
+        return (
+          <DirectorFinanceCardModal
+            visible={repOpen}
+            onClose={closeReports}
+            title="╨д╨░╨║╤В ╨▓╤Л╨┤╨░╤З╨╕ (╤Б╨║╨╗╨░╨┤)"
+            periodShort={repPeriodShort}
+            loading={repLoading}
+            onOpenPeriod={() => setRepPeriodOpen(true)}
+            onRefresh={async () => {
+              await fetchReportOptions();
+              await applyObjectFilter(repObjectName);
+            }}
+            onPdf={() => notifyInfo("PDF", "╨Я╨╛╨┤╨║╨╗╤О╤З╨╕╨╝ ╨┐╨╛╤Б╨╗╨╡ UI (╨┤╨░╨╜╨╜╤Л╨╡ ╤Г╨╢╨╡ ╨│╨╛╤В╨╛╨▓╤Л).")}
+            overlay={
+              repPeriodOpen ? (
+                <PeriodPickerSheet
+                  visible={repPeriodOpen}
+                  onClose={() => setRepPeriodOpen(false)}
+                  initialFrom={repFrom || ""}
+                  initialTo={repTo || ""}
+                  onApply={(from: string, to: string) => void applyReportPeriod(from || null, to || null)}
+                  onClear={() => {
+                    const to = isoDate(new Date());
+                    const from = isoDate(minusDays(30));
+                    void applyReportPeriod(from, to);
+                  }}
+                  ui={{
+                    cardBg: UI.cardBg,
+                    text: UI.text,
+                    sub: UI.sub,
+                    border: "rgba(255,255,255,0.14)",
+                    accentBlue: "#3B82F6",
+                    approve: "#22C55E",
+                  }}
+                />
+              ) : repObjOpen ? (
+                <RNModal
+                  isVisible={repObjOpen}
+                  onBackdropPress={() => setRepObjOpen(false)}
+                  onBackButtonPress={() => setRepObjOpen(false)}
+                  backdropOpacity={0.55}
+                  useNativeDriver
+                  useNativeDriverForBackdrop
+                  hideModalContentWhileAnimating
+                  style={{ margin: 0, justifyContent: "flex-end" }}
+                >
+                  <View style={s.sheet}>
+                    <View style={s.sheetHandle} />
+
+                    <View style={{ flexDirection: "row", justifyContent: "space-between", paddingHorizontal: 14, paddingBottom: 10 }}>
+                      <Text style={{ color: UI.text, fontWeight: "900", fontSize: 16 }}>
+                        {`╨Ю╨▒╤К╨╡╨║╤В╤Л (${repOptObjects?.length ?? 0})`}
+                      </Text>
+
+                      <Pressable onPress={() => setRepObjOpen(false)}>
+                        <Text style={{ color: UI.sub, fontWeight: "900" }}>╨Ч╨░╨║╤А╤Л╤В╤М</Text>
+                      </Pressable>
+                    </View>
+
+                    <FlatList
+                      data={repOptObjects || []}
+                      keyExtractor={(x, i) => `${x}:${i}`}
+                      keyboardShouldPersistTaps="handled"
+                      style={{ maxHeight: 420 }}
+                      renderItem={({ item }) => (
+                        <Pressable
+                          onPress={async () => {
+                            setRepObjOpen(false);
+                            await applyObjectFilter(item);
+                          }}
+                          style={[s.mobCard, { marginHorizontal: 12, marginBottom: 10 }]}
+                        >
+                          <Text style={{ color: UI.text, fontWeight: "900" }} numberOfLines={2}>
+                            {item}
+                          </Text>
+                        </Pressable>
+                      )}
+                    />
+                  </View>
+                </RNModal>
+              ) : null
             }
-          }}
-        />
-      </View>
-    );
-  })()}
-</View>
-      </View>
-    ) : null}
-
-   {/* ===== PROPOSAL (╤Б╨╜╨░╨▒╨╢╨╡╨╜╨╡╤Ж) ===== */}
-{sheetKind === 'proposal' && sheetProposalId ? (
-  <View style={{ flex: 1, minHeight: 0 }}>
-    {(() => {
-      const pidStr = String(sheetProposalId);
-const key = pidStr;
-const loaded = !!loadedByProp[key];
-const items = itemsByProp[key] || [];
-
-const isEmptyProposal = loaded && (items?.length ?? 0) === 0;
-const approveDisabled =
-  screenLock ||
-  propApproveId === pidStr ||
-  propReturnId === pidStr ||
-  !loaded ||
-  isEmptyProposal;
-
-      const pretty = String(propsHeads.find(x => String(x.id) === pidStr)?.pretty ?? '').trim();
-
-      const totalSum = (items || []).reduce((acc, it) => {
-        const pr = Number((it as any).price ?? 0);
-        const q = Number((it as any).total_qty ?? 0);
-        return acc + pr * q;
-      }, 0);
-
-      
-      if (!loaded) return <Text style={{ opacity: 0.7, color: UI.sub }}>╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╤Б╨╛╤Б╤В╨░╨▓тАж</Text>;
-if (!items.length) {
-  return (
-    <Text style={{ opacity: 0.75, color: UI.sub }}>
-      ╨б╨╛╤Б╤В╨░╨▓ ╨┐╤Г╤Б╤В тАФ ╤Г╤В╨▓╨╡╤А╨┤╨╕╤В╤М ╨╜╨╡╨╗╤М╨╖╤П
-    </Text>
-  );
-}
-return (
-  <>
-   {/* ===== REQUEST CONTEXT (╨┤╨╗╤П ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П) ===== */}
-{(() => {
-  // тЬЕ 0) ╨б╨░╨╝╤Л╨╣ ╨╗╤Г╤З╤И╨╕╨╣ ╨╕╤Б╤В╨╛╤З╨╜╨╕╨║ тАФ request_items.note (╨║╨░╨║ ╤Г ╨┐╤А╨╛╤А╨░╨▒╨░)
-  const firstReqItemId =
-    (itemsByProp[pidStr] || items || [])
-      .map(x => String(x?.request_item_id ?? "").trim())
-      .find(Boolean) || "";
-
-  const headerNote = firstReqItemId ? String(reqItemNoteByIdRef.current?.[firstReqItemId] ?? "").trim() : "";
-
-  if (headerNote) {
-    const lines = headerNote
-      .split(";")
-      .map(x => x.trim())
-      .filter(Boolean)
-      .slice(0, 4);
-
-    if (lines.length) {
-      return (
-        <View style={s.reqNoteBox}>
-          {lines.map((t, idx) => (
-            <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
-              {t}
-            </Text>
-          ))}
-        </View>
-      );
-    }
-  }
+          >
+            <View style={{ marginBottom: 10 }}>
+              <Text style={{ color: UI.sub, fontWeight: "900", marginBottom: 6 }}>
+                ╨Ю╨▒╤К╨╡╨║╤В
+              </Text>
 
-  // тЬЕ 1) ╨Т╤В╨╛╤А╨╛╨╣ ╨▓╨░╤А╨╕╨░╨╜╤В тАФ requests.note/comment (╨╡╤Б╨╗╨╕ ╨▓╨┤╤А╤Г╨│ ╨╡╤Б╤В╤М)
-  const reqIds = propReqIdsByPropRef.current?.[pidStr] || [];
-  if (!reqIds.length) return null;
-
-  const firstReqId = reqIds[0];
-  const meta = reqMetaByIdRef.current?.[firstReqId];
-
-  const human =
-    String(meta?.note ?? "").trim() ||
-    String(meta?.comment ?? "").trim();
-
-  if (human) {
-    const lines = human
-      .split(";")
-      .map(x => x.trim())
-      .filter(Boolean)
-      .slice(0, 4);
-
-    if (lines.length) {
-      return (
-        <View style={s.reqNoteBox}>
-          {lines.map((t, idx) => (
-            <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
-              {t}
-            </Text>
-          ))}
-        </View>
-      );
-    }
-  }
+              <View style={{ flexDirection: "row", flexWrap: "wrap" }}>
 
-  // тЬЕ 2) Fallback тАФ ╨║╨╛╨┤╤Л (╨║╨░╨║ ╨▒╤Л╨╗╨╛)
-  const obj =
-    String(meta?.object_name ?? "").trim() ||
-    String(meta?.object ?? "").trim() ||
-    (meta?.site_address_snapshot ? String(meta.site_address_snapshot).trim() : "");
+                <Pressable
+                  onPress={() => void applyObjectFilter(null)}
+                  style={[s.tab, !repObjectName && s.tabActive, { marginRight: 8, marginBottom: 8 }]}
+                >
+                  <Text style={{ color: !repObjectName ? UI.text : UI.sub, fontWeight: "900" }}>
+                    ╨Т╤Б╨╡
+                  </Text>
+                </Pressable>
+
+                <Pressable
+                  onPress={() => setRepObjOpen(true)}
+                  style={[s.tab, repObjectName && s.tabActive, { marginRight: 8, marginBottom: 8 }]}
+                >
+                  <Text style={{ color: repObjectName ? UI.text : UI.sub, fontWeight: "900" }}>
+                    {`╨Ю╨▒╤К╨╡╨║╤В╤Л ┬╖ ${(repOptObjects?.length ?? 0)}`}
+                  </Text>
+                </Pressable>
+
+                {repObjectName ? (
+                  <Pressable
+                    onPress={() => setRepObjOpen(true)}
+                    style={[s.tab, s.tabActive, { marginRight: 8, marginBottom: 8 }]}
+                  >
+                    <Text numberOfLines={1} style={{ color: UI.text, fontWeight: "900", maxWidth: 220 }}>
+                      {repObjectName}
+                    </Text>
+                  </Pressable>
+                ) : null}
+
+                {repOptLoading ? (
+                  <Text style={{ color: UI.sub, fontWeight: "800", marginLeft: 4, marginTop: 8 }}>тАж</Text>
+                ) : null}
+              </View>
 
-  const lines: string[] = [];
-  if (obj) lines.push(`╨Ю╨▒╤К╨╡╨║╤В: ${obj}`);
-  if (meta?.level_code) lines.push(`╨н╤В╨░╨╢/╤Г╤А╨╛╨▓╨╡╨╜╤М: ${meta.level_code}`);
-  if (meta?.system_code) lines.push(`╨б╨╕╤Б╤В╨╡╨╝╨░: ${meta.system_code}`);
-  if (meta?.zone_code) lines.push(`╨Ч╨╛╨╜╨░: ${meta.zone_code}`);
+            </View>
 
-  if (!lines.length) return null;
+            {/* KPI */}
+            <View style={{ marginBottom: 10 }}>
+              <View style={{ flexDirection: "row", gap: 8 }}>
+                <View style={[s.kpiPillHalf, { flex: 1 }]}>
+                  <Text style={s.kpiLabel}>╨Ф╨╛╨║╤Г╨╝╨╡╨╜╤В╨╛╨▓</Text>
+                  <Text style={s.kpiValue}>{repLoading ? "тАж" : String(issuesTotal)}</Text>
+                </View>
 
-  return (
-    <View style={s.reqNoteBox}>
-      {lines.slice(0, 4).map((t, idx) => (
-        <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
-          {t}
-        </Text>
-      ))}
-    </View>
-  );
-})()}
-{(() => {
-  const pidStr = String(sheetProposalId);
-  const files = propAttByProp[pidStr] || [];
-  const busyAtt = !!propAttBusyByProp[pidStr];
+                <View style={[s.kpiPillHalf, { flex: 1 }]}>
+                  <Text style={s.kpiLabel}>╨Я╨╛╨╖╨╕╤Ж╨╕╨╣</Text>
+                  <Text style={s.kpiValue}>{repLoading ? "тАж" : String(itemsTotal)}</Text>
+                </View>
+              </View>
 
-  return (
-    <View style={{ marginTop: 6, marginBottom: 12 }}>
-      <View style={{ flexDirection: "row", alignItems: "center", justifyContent: "space-between" }}>
-        <Text style={{ color: UI.text, fontWeight: "900" }}>
-          ╨Т╨╗╨╛╨╢╨╡╨╜╨╕╤П: {files.length}
-        </Text>
-
-        <Pressable
-          disabled={busyAtt}
-          onPress={() => void loadProposalAttachments(pidStr)}
-          style={{
-            paddingVertical: 6,
-            paddingHorizontal: 10,
-            borderRadius: 999,
-            borderWidth: 1,
-            borderColor: "rgba(255,255,255,0.18)",
-            backgroundColor: "rgba(255,255,255,0.06)",
-            opacity: busyAtt ? 0.6 : 1,
-          }}
-        >
-          <Text style={{ color: UI.text, fontWeight: "900", fontSize: 12 }}>
-            {busyAtt ? "тАж" : "╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М"}
-          </Text>
-        </Pressable>
-      </View>
+              <View style={{ height: 8 }} />
 
-      {busyAtt ? (
-        <Text style={{ color: UI.sub, fontWeight: "800", marginTop: 8 }}>
-          ╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╤ПтАж
-        </Text>
-      ) : files.length === 0 ? (
-        <Text style={{ color: UI.sub, fontWeight: "800", marginTop: 8 }}>
-          ╨Э╨╡╤В ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╨╣ (╨╗╨╕╨▒╨╛ ╨╜╨╡ ╨┐╤А╨╕╨║╤А╨╡╨┐╨╗╨╡╨╜╤Л, ╨╗╨╕╨▒╨╛ RLS ╨╜╨╡ ╨┐╤Г╤Б╨║╨░╨╡╤В).
-        </Text>
-      ) : (
-        <View style={{ flexDirection: "row", flexWrap: "wrap", marginTop: 8 }}>
-          {files.map((f, idx) => (
-  <Pressable key={`${f.id}:${idx}`}
-  onPress={() => {
-    const url = String(f.url || "").trim();
-    if (!url) {
-      Alert.alert("╨Т╨╗╨╛╨╢╨╡╨╜╨╕╨╡", "URL ╨┐╤Г╤Б╤В╨╛╨╣");
-      return;
-    }
-    void openSignedUrlUniversal(url, String(f.file_name ?? "file"));
-  }}
-  style={{
-    paddingVertical: 8,
-    paddingHorizontal: 12,
-    borderRadius: 999,
-    borderWidth: 1,
-    borderColor: "rgba(255,255,255,0.18)",
-    backgroundColor: "rgba(255,255,255,0.06)",
-    marginRight: 8,
-    marginBottom: 8,
-  }}
->
-  <Text style={{ color: UI.text, fontWeight: "900" }} numberOfLines={1}>
-    {f.group_key ? `${f.group_key}: ` : ""}{f.file_name}
-  </Text>
-</Pressable>
-
-          ))}
-        </View>
-      )}
-    </View>
-  );
-})()}
-          <FlatList
-            data={items}
-            keyExtractor={(it, idx) => `pi:${key}:${it.id}:${idx}`}
-            contentContainerStyle={{ paddingBottom: 12 }}
-            keyboardShouldPersistTaps="handled"
-            nestedScrollEnabled
-            scrollEnabled
-            showsVerticalScrollIndicator={false}
-            renderItem={({ item: it }) => (
-              <View style={s.mobCard}>
-                <View style={s.mobMain}>
-                  <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>
-  <Text style={[s.mobTitle, { marginRight: 8 }]} numberOfLines={3}>
-    {it.name_human}
-  </Text>
-
-  {it.item_kind ? (
-    <View style={[s.kindPill, { marginTop: 4 }]}>
-      <Text style={s.kindPillText}>
-        {it.item_kind === 'material' ? '╨Ь╨░╤В╨╡╤А╨╕╨░╨╗'
-          : it.item_kind === 'work' ? '╨а╨░╨▒╨╛╤В╨░'
-          : it.item_kind === 'service' ? '╨г╤Б╨╗╤Г╨│╨░'
-          : it.item_kind}
-      </Text>
-    </View>
-  ) : null}
-</View>
-                  <Text style={s.mobMeta}>
-                    {`${it.total_qty} ${it.uom || ''}`.trim()}
-                    {it.price != null ? ` ┬╖ ╤Ж╨╡╨╜╨░ ${it.price}` : ''}
-                    {it.price != null ? ` ┬╖ ╤Б╤Г╨╝╨╝╨░ ${Math.round(Number(it.price) * Number(it.total_qty || 0))}` : ''}
-                    {it.app_code ? ` ┬╖ ${it.app_code}` : ''}
+              <View style={{ flexDirection: "row", gap: 8 }}>
+                <View style={[s.kpiPillHalf, { flex: 1 }]}>
+                  <Text style={s.kpiLabel}>╨С╨╡╨╖ ╨╛╨▒╤К╨╡╨║╤В╨░</Text>
+                  <Text style={s.kpiValue}>
+                    {repLoading ? "тАж" : `${issuesNoObj} ┬╖ ${pct(issuesNoObj, issuesTotal)}`}
                   </Text>
                 </View>
-<View style={{ marginLeft: 10 }}>
-  <RejectItemButton
-    disabled={decidingId === pidStr || actingPropItemId === Number(it.id)}
-    loading={actingPropItemId === Number(it.id)}
-    onPress={async () => {
-      try {
-        setDecidingId(pidStr);
-        setActingPropItemId(Number(it.id));
-
-        // тЬЕ ╨С╨╡╤А╤С╨╝ request_item_id ╨╢╨╡╨╗╨╡╨╖╨╜╨╛ ╨╕╨╖ ╨С╨Ф ╨┐╨╛ proposal_items.id
-        const q = await supabase
-          .from('proposal_items')
-          .select('request_item_id')
-          .eq('proposal_id', pidStr)
-          .eq('id', it.id) // it.id = proposal_items.id
-          .maybeSingle();
-
-        if (q.error) throw q.error;
-
-        const rid = String(q.data?.request_item_id || '').trim();
-        if (!rid) {
-          Alert.alert('╨Ю╤И╨╕╨▒╨║╨░', '╨Т ╤Б╤В╤А╨╛╨║╨╡ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П ╨╜╨╡╤В request_item_id (╨▓ ╨▒╨░╨╖╨╡).');
-          return;
-        }
 
-        const beforeCount = (itemsByProp[pidStr] || items || []).length;
-        const isLast = beforeCount <= 1;
-
-        const payload = [{
-          request_item_id: rid,
-          decision: 'rejected',
-          comment: '╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛ ╨┤╨╕╤А╨╡╨║╤В╨╛╤А╨╛╨╝',
-        }];
-
-        const res = await supabase.rpc('director_decide_proposal_items', {
-          p_proposal_id: pidStr,
-          p_decisions: payload,
-          p_finalize: isLast,
-        });
-
-        if (res.error) throw res.error;
-
-        // ╨╗╨╛╨║╨░╨╗╤М╨╜╨╛ ╤Г╨▒╨╕╤А╨░╨╡╨╝ ╤Б╤В╤А╨╛╨║╤Г
-        setItemsByProp(prev => {
-          const before = prev[pidStr] || [];
-          const nextItems = before.filter(x => Number(x.id) !== Number(it.id));
-          return { ...prev, [pidStr]: nextItems };
-        });
-
-        if (isLast) {
-          await fetchProps();
-          closeSheet();
-        }
-      } catch (e: any) {
-        Alert.alert('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨┐╨╛╨╖╨╕╤Ж╨╕╤О');
-      } finally {
-        setActingPropItemId(null);
-        setDecidingId(null);
-      }
-    }}
-  />
-</View>
+                <View style={[s.kpiPillHalf, { flex: 1 }]}>
+                  <Text style={s.kpiLabel}>╨С╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕</Text>
+                  <Text style={s.kpiValue}>
+                    {repLoading ? "тАж" : `${itemsNoReq} ┬╖ ${pct(itemsNoReq, itemsTotal)}`}
+                  </Text>
+                </View>
               </View>
-            )}
-          ListFooterComponent={() => (
-    <View style={{ paddingTop: 10, paddingBottom: 6, alignItems: 'flex-end' }}>
-      <View
-        style={{
-          paddingVertical: 6,
-          paddingHorizontal: 12,
-          borderRadius: 999,
-          backgroundColor: 'rgba(255,255,255,0.06)',
-          borderWidth: 1,
-          borderColor: 'rgba(255,255,255,0.12)',
-        }}
-      >
-        <Text style={{ fontWeight: '900', color: UI.text, fontSize: 14 }}>
-          ╨Ш╨в╨Ю╨У╨Ю: {Math.round(totalSum)}
-        </Text>
-      </View>
-    </View>
-  )}
-/>
-{/* ===== PROPOSAL ACTIONS (PROD) ===== */}
-<View style={s.reqActionsBottom}>
-  {/* тЬЕ Return/Delete тАФ LEFT */}
-  <View style={s.actionBtnSquare}>
-    <DeleteAllButton
-      disabled={screenLock || propReturnId === pidStr || propApproveId === pidStr}
-      loading={propReturnId === pidStr}
-      accessibilityLabel="╨Т╨╡╤А╨╜╤Г╤В╤М/╨Ю╤В╨║╨╗╨╛╨╜╨╕╤В╤М"
-      onPress={() => {
-        if (screenLock) return;
-        onDirectorReturn(pidStr);
-      }}
-    />
-  </View>
-
-  <View style={s.sp8} />
-
-  {/* PDF тАФ CENTER */}
-  {(() => {
-    const pdfKey = `pdfshare:prop:${pidStr}`;
-    const pdfBusy = busy.isBusy(pdfKey);
-
-    return (
-      <Pressable
-        disabled={pdfBusy || screenLock}
-        style={[
-          s.actionBtnWide,
-          { backgroundColor: UI.btnNeutral, opacity: (pdfBusy || screenLock) ? 0.6 : 1 },
-        ]}
-        onPress={async () => {
-          if (pdfBusy || screenLock) return;
-          if (pdfTapLockRef.current[pdfKey]) return;
-          pdfTapLockRef.current[pdfKey] = true;
-
-          try {
-            await runPdfTop({
-              busy,
-              supabase,
-              key: pdfKey,
-              label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Д╨░╨╣╨╗тАж",
-              mode: "share",
-              fileName: `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡_${pidStr}`,
-              getRemoteUrl: async () => {
-                const { exportProposalPdf } = await import("../../src/lib/rik_api");
-                return await exportProposalPdf(pidStr as any, "share");
-              },
-            });
-          } catch (e: any) {
-            if (String(e?.message ?? "").toLowerCase().includes("busy")) return;
-            Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨┐╤А╨░╨▓╨╕╤В╤М PDF");
-          } finally {
-            setTimeout(() => { pdfTapLockRef.current[pdfKey] = false; }, 450);
-          }
-        }}
-      >
-        <Text style={s.actionText}>{pdfBusy ? "PDFтАж" : "PDF"}</Text>
-      </Pressable>
-    );
-  })()}
-
-  <View style={s.sp8} />
-
-  {/* Excel тАФ CENTER */}
-  <Pressable
-    disabled={screenLock}
-    style={[
-      s.actionBtnWide,
-      { backgroundColor: UI.btnNeutral, opacity: screenLock ? 0.6 : 1 },
-    ]}
-    onPress={async () => {
-      if (screenLock) return;
+            </View>
 
-      try {
-        if (Platform.OS !== "web") {
-          Alert.alert("Excel", "Excel ╤Н╨║╤Б╨┐╨╛╤А╤В ╤Б╨╡╨╣╤З╨░╤Б ╤А╨╡╨░╨╗╨╕╨╖╨╛╨▓╨░╨╜ ╤В╨╛╨╗╤М╨║╨╛ ╨┤╨╗╤П Web-╨▓╨╡╤А╤Б╨╕╨╕.");
-          return;
-        }
-        if (!items.length) {
-          Alert.alert("Excel", "╨Э╨╡╤В ╤Б╤В╤А╨╛╨║ ╨┤╨╗╤П ╨▓╤Л╨│╤А╤Г╨╖╨║╨╕.");
-          return;
-        }
+            {/* Tabs */}
+            <View style={{ flexDirection: "row", marginBottom: 10 }}>
+              {(["materials", "discipline"] as RepTab[]).map((t) => {
+                const active = repTab === t;
+                return (
+                  <Pressable
+                    key={t}
+                    onPress={() => setRepTab(t)}
+                    style={[s.tab, active && s.tabActive, { marginRight: 8 }]}
+                  >
+                    <Text style={{ color: active ? UI.text : UI.sub, fontWeight: "900" }}>
+                      {t === "materials" ? "╨Ь╨░╤В╨╡╤А╨╕╨░╨╗╤Л" : "╨Ф╨╕╤Б╤Ж╨╕╨┐╨╗╨╕╨╜╨░"}
+                    </Text>
+                  </Pressable>
+                );
+              })}
+            </View>
 
-        const safe = (v: any) => (v == null ? "" : String(v).replace(/[\r\n]+/g, " ").trim());
-        const title = (pretty || `PROPOSAL-${pidStr.slice(0, 8)}`).replace(/[^\w╨Р-╨п╨░-╤П0-9]/g, "_");
-        const sheetName = title.slice(0, 31) || "╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡";
+            {/* Content */}
+            {repTab === "materials" ? (
+              <FlatList
+                data={rows}
+                keyExtractor={(x, idx) => `${x.rik_code}:${x.uom}:${idx}`}
+                removeClippedSubviews={false}
+                keyboardShouldPersistTaps="handled"
+                showsVerticalScrollIndicator={false}
+                renderItem={({ item }) => {
+                  const qAll = Number(item.qty_total || 0);
+                  const qNoReq = Number(item.qty_without_request || 0);
+                  const docs = Number(item.docs_cnt || 0);
+                  const docsNoReq = Number(item.docs_without_request || 0);
+
+                  return (
+                    <View style={[s.mobCard, { marginBottom: 10 }]}>
+                      <View style={s.mobMain}>
+                        <Text style={s.mobTitle} numberOfLines={2}>
+                          {item.rik_code}
+                        </Text>
+                        <Text style={s.mobMeta} numberOfLines={2}>
+                          {`╨Т╤Л╨┤╨░╨╜╨╛: ${qAll} ${item.uom} ┬╖ ╨┤╨╛╨║ ${docs}`}
+                          {qNoReq > 0 ? ` ┬╖ ╨▒╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕: ${qNoReq} (${docsNoReq} ╨┤╨╛╨║)` : ""}
+                        </Text>
+                      </View>
+                    </View>
+                  );
+                }}
+                ListEmptyComponent={
+                  !repLoading ? (
+                    <Text style={{ opacity: 0.7, color: UI.sub, paddingVertical: 8 }}>
+                      ╨Э╨╡╤В ╨▓╤Л╨┤╨░╤З ╨╖╨░ ╨▓╤Л╨▒╤А╨░╨╜╨╜╤Л╨╣ ╨┐╨╡╤А╨╕╨╛╨┤.
+                    </Text>
+                  ) : null
+                }
+              />
+            ) : (
+              <FlatList
+                data={who}
+                keyExtractor={(x, idx) => `${x.who}:${idx}`}
+                removeClippedSubviews={false}
+                keyboardShouldPersistTaps="handled"
+                showsVerticalScrollIndicator={false}
+                renderItem={({ item }) => (
+                  <View style={[s.mobCard, { marginBottom: 10 }]}>
+                    <View style={s.mobMain}>
+                      <Text style={s.mobTitle} numberOfLines={1}>{item.who}</Text>
+                      <Text style={s.mobMeta} numberOfLines={1}>
+                        {`╨Я╨╛╨╖╨╕╤Ж╨╕╨╣ ╨▒╨╡╨╖ ╨╖╨░╤П╨▓╨║╨╕: ${String(item.items_cnt ?? 0)}`}
+                      </Text>
+                    </View>
+                  </View>
+                )}
+                ListEmptyComponent={
+                  !repLoading ? (
+                    <Text style={{ opacity: 0.7, color: UI.sub, paddingVertical: 8 }}>
+                      ╨Э╨╡╤В ╨┤╨░╨╜╨╜╤Л╤Е ╨┐╨╛ ╨┤╨╕╤Б╤Ж╨╕╨┐╨╗╨╕╨╜╨╡ ╨╖╨░ ╨┐╨╡╤А╨╕╨╛╨┤.
+                    </Text>
+                  ) : null
+                }
+              />
+            )}
 
-        const data: any[][] = [["тДЦ", "╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡", "╨Ъ╨╛╨╗-╨▓╨╛", "╨Х╨┤. ╨╕╨╖╨╝.", "╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡"]];
-        items.forEach((it, idx) =>
-          data.push([idx + 1, safe(it.name_human), safe(it.total_qty), safe(it.uom), safe(it.app_code)])
+            {/* Bottom actions (Excel placeholder) */}
+            <View style={{ marginTop: 10, flexDirection: "row", gap: 8 }}>
+              <Pressable
+                onPress={() => notifyInfo("Excel", "╨Я╨╛╨┤╨║╨╗╤О╤З╨╕╨╝ ╨┐╨╛╤Б╨╗╨╡ UI (╨┤╨░╨╜╨╜╤Л╨╡ ╤Г╨╢╨╡ ╨│╨╛╤В╨╛╨▓╤Л).")}
+                style={[s.openBtn, { paddingVertical: 10, paddingHorizontal: 14, backgroundColor: UI.btnNeutral }]}
+              >
+                <Text style={[s.openBtnText, { fontSize: 12 }]}>Excel</Text>
+              </Pressable>
+
+              <Pressable
+                onPress={() => void applyObjectFilter(null)}
+                style={[s.openBtn, { paddingVertical: 10, paddingHorizontal: 14, backgroundColor: "rgba(255,255,255,0.06)" }]}
+              >
+                <Text style={[s.openBtnText, { fontSize: 12 }]}>╨Т╤Б╨╡ ╨╛╨▒╤К╨╡╨║╤В╤Л</Text>
+              </Pressable>
+            </View>
+          </DirectorFinanceCardModal>
         );
+      })()}
+
+      <RNModal
+        isVisible={isSheetOpen}
+        onBackdropPress={closeSheet}
+        onBackButtonPress={closeSheet}
+        backdropOpacity={0.55}
+        useNativeDriver
+        useNativeDriverForBackdrop
+        hideModalContentWhileAnimating
+        style={{ margin: 0, justifyContent: 'flex-end' }}
+      >
 
-        const wb = XLSX.utils.book_new();
-        const ws = XLSX.utils.aoa_to_sheet(data);
-        XLSX.utils.book_append_sheet(wb, ws, sheetName);
-
-        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
-        const blob = new Blob([wbout], {
-          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
-        });
-
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement("a");
-        a.href = url;
-        a.download = `${sheetName}.xlsx`;
-        document.body.appendChild(a);
-        a.click();
-        document.body.removeChild(a);
-        URL.revokeObjectURL(url);
-      } catch (e: any) {
-        Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╤Б╤Д╨╛╤А╨╝╨╕╤А╨╛╨▓╨░╤В╤М Excel");
-      }
-    }}
-  >
-    <Text style={s.actionText}>Excel</Text>
-  </Pressable>
-
-  <View style={s.sp8} />
-
-  {/* тЬЕ Approve тАФ RIGHT */}
-  <View style={s.actionBtnSquare}>
-    <SendPrimaryButton
-      variant="green"
-      disabled={approveDisabled}
-      loading={propApproveId === pidStr}
-      onPress={async () => {
-        if (approveDisabled) return;
-
-        try {
-          setPropApproveId(pidStr);
+        <View style={s.sheet}>
+          <View style={s.sheetHandle} />
+
+          {/* TOP BAR */}
+          <View style={s.sheetTopBar}>
+            <Text style={s.sheetTitle} numberOfLines={1}>
+              {sheetKind === 'request' && sheetRequest
+                ? `╨Ч╨░╤П╨▓╨║╨░ ${labelForRequest(sheetRequest.request_id)}`
+                : sheetKind === 'proposal' && sheetProposalId
+                  ? (() => {
+                    const p = propsHeads.find(x => String(x.id) === String(sheetProposalId));
+                    const pretty = String(p?.pretty ?? '').trim();
+                    return pretty ? `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ ${pretty}` : `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡ #${String(sheetProposalId).slice(0, 8)}`;
+                  })()
+                  : 'тАФ'}
+            </Text>
 
-          const { error } = await supabase.rpc("director_approve_min_auto", {
-            p_proposal_id: pidStr,
-            p_comment: null,
-          });
-          if (error) throw error;
+            <Pressable onPress={closeSheet} style={s.sheetCloseBtn}>
+              <Text style={s.sheetCloseText}>╨б╨▓╨╡╤А╨╜╤Г╤В╤М</Text>
+            </Pressable>
+          </View>
 
-          const rInc = await supabase.rpc("ensure_purchase_and_incoming_strict", {
-            p_proposal_id: pidStr,
-          });
-          if ((rInc as any)?.error) throw (rInc as any).error;
+          {/* ===== REQUEST (╨┐╤А╨╛╤А╨░╨▒) ===== */}
+          {sheetKind === 'request' && sheetRequest ? (
+            <View style={{ flex: 1, minHeight: 0 }}>
+              {/* NOTE */}
+              {(() => {
+                const headerNote = sheetRequest.items.find(x => x.note)?.note || null;
+                if (!headerNote) return null;
+
+                const lines = headerNote
+                  .split(';')
+                  .map(x => x.trim())
+                  .filter(Boolean)
+                  .slice(0, 4);
+
+                if (!lines.length) return null;
+
+                return (
+                  <View style={s.reqNoteBox}>
+                    {lines.map((line, idx) => (
+                      <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
+                        {line}
+                      </Text>
+                    ))}
+                  </View>
+                );
+              })()}
+
+              <FlatList
+                data={sheetRequest.items}
+                keyExtractor={(it, idx) => (it.request_item_id ? `mri:${it.request_item_id}` : `mri:${idx}`)}
+                contentContainerStyle={{ paddingBottom: 12 }}
+                keyboardShouldPersistTaps="handled"
+                nestedScrollEnabled
+                scrollEnabled
+                showsVerticalScrollIndicator={false}
+                renderItem={({ item: it }) => (
+                  <View style={s.mobCard}>
+                    <View style={s.mobMain}>
+                      <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>
+                        <Text style={[s.mobTitle, { marginRight: 8 }]} numberOfLines={3}>
+                          {it.name_human}
+                        </Text>
+
+                        {it.item_kind ? (
+                          <View style={[s.kindPill, { marginTop: 4 }]}>
+                            <Text style={s.kindPillText}>
+                              {it.item_kind === 'material' ? '╨Ь╨░╤В╨╡╤А╨╕╨░╨╗'
+                                : it.item_kind === 'work' ? '╨а╨░╨▒╨╛╤В╨░'
+                                  : it.item_kind === 'service' ? '╨г╤Б╨╗╤Г╨│╨░'
+                                    : it.item_kind}
+                            </Text>
+                          </View>
+                        ) : null}
+                      </View>
+
+
+                      <Text style={s.mobMeta} numberOfLines={2}>
+                        {`${it.qty} ${it.uom || ''}`.trim()}
+                        {it.app_code ? ` ┬╖ ${it.app_code}` : ''}
+                      </Text>
+                    </View>
+
+                    <RejectItemButton
+                      disabled={!it.request_item_id || actingId === it.request_item_id}
+                      loading={actingId === it.request_item_id}
+                      onPress={async () => {
+                        if (!it.request_item_id) return;
+                        setActingId(it.request_item_id);
+                        try {
+                          const { error } = await supabase.rpc('reject_request_item', {
+                            request_item_id: it.request_item_id,
+                            reason: null,
+                          });
+                          if (error) throw error;
+
+                          setRows(prev => prev.filter(r => r.request_item_id !== it.request_item_id));
+                          setSheetRequest(prev => prev
+                            ? ({ ...prev, items: prev.items.filter(x => x.request_item_id !== it.request_item_id) })
+                            : prev
+                          );
+                        } catch (e: any) {
+                          notifyError('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨┐╨╛╨╖╨╕╤Ж╨╕╤О');
+                        } finally {
+                          setActingId(null);
+                        }
+                      }}
+                    />
+                  </View>
+                )}
+              />
+              {/* ===== REQUEST ACTIONS (PROD) ===== */}
+              <View style={s.reqActionsBottom}>
+                {/* тЬЕ Delete тАФ LEFT */}
+                <View style={s.actionBtnSquare}>
+                  <DeleteAllButton
+                    disabled={screenLock || reqDeleteId === sheetRequest.request_id || reqSendId === sheetRequest.request_id}
+                    loading={reqDeleteId === sheetRequest.request_id}
+                    accessibilityLabel="╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г"
+                    onPress={() => {
+                      const doIt = async () => {
+                        setReqDeleteId(sheetRequest.request_id);
+                        try {
+                          const reqId = toFilterId(sheetRequest.request_id);
+                          if (reqId == null) throw new Error("request_id ╨┐╤Г╤Б╤В╨╛╨╣");
+
+                          const { error } = await supabase.rpc("reject_request_all", {
+                            p_request_id: String(reqId),
+                            p_reason: null,
+                          });
+                          if (error) throw error;
+
+                          setRows(prev => prev.filter(r => r.request_id !== sheetRequest.request_id));
+                          closeSheet();
+                        } catch (e: any) {
+                          notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                        } finally {
+                          setReqDeleteId(null);
+                        }
+                      };
+
+                      if (Platform.OS === "web") {
+                        // @ts-ignore
+                        const ok = window.confirm("╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г?\n\n╨Ю╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨Т╨б╨о ╨╖╨░╤П╨▓╨║╤Г ╨▓╨╝╨╡╤Б╤В╨╡ ╤Б╨╛ ╨▓╤Б╨╡╨╝╨╕ ╨┐╨╛╨╖╨╕╤Ж╨╕╤П╨╝╨╕?");
+                        if (!ok) return;
+                        void doIt();
+                        return;
+                      }
+
+                      Alert.alert(
+                        "╨г╨┤╨░╨╗╨╕╤В╤М ╨╖╨░╤П╨▓╨║╤Г?",
+                        "╨Т╤Л ╤Г╨▓╨╡╤А╨╡╨╜╤Л, ╤З╤В╨╛ ╤Е╨╛╤В╨╕╤В╨╡ ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨Т╨б╨о ╨╖╨░╤П╨▓╨║╤Г ╨▓╨╝╨╡╤Б╤В╨╡ ╤Б╨╛ ╨▓╤Б╨╡╨╝╨╕ ╨┐╨╛╨╖╨╕╤Ж╨╕╤П╨╝╨╕?",
+                        [
+                          { text: "╨Ю╤В╨╝╨╡╨╜╨░", style: "cancel" },
+                          { text: "╨Ф╨░, ╤Г╨┤╨░╨╗╨╕╤В╤М", style: "destructive", onPress: () => void doIt() },
+                        ],
+                      );
+                    }}
+                  />
+                </View>
 
-          try {
-            const purchaseId = String((rInc as any)?.data?.purchase_id ?? "").trim();
-            if (purchaseId) {
-              const rW = await supabase.rpc("work_seed_from_purchase" as any, { p_purchase_id: purchaseId } as any);
-              if (rW.error) console.warn("[work_seed_from_purchase] error:", rW.error.message);
-            }
-          } catch {}
-
-          const { error: accErr } = await supabase.rpc("proposal_send_to_accountant_min", {
-            p_proposal_id: pidStr,
-            p_invoice_number: null,
-            p_invoice_date: null,
-            p_invoice_amount: null,
-            p_invoice_currency: "KGS",
-          });
-          if (accErr) throw accErr;
+                <View style={s.sp8} />
+
+                {/* PDF тАФ CENTER */}
+                {(() => {
+                  const rid = String(sheetRequest.request_id ?? "").trim();
+                  const pdfKey = `pdf:req:${rid}`;
+                  const pdfBusy = busy.isBusy(pdfKey);
+
+                  return (
+                    <Pressable
+                      disabled={!rid || pdfBusy || screenLock}
+                      onPress={async () => {
+                        if (!rid || pdfBusy || screenLock) return;
+                        try {
+                          await openRequestPdf(sheetRequest);
+                        } catch (e: any) {
+                          if (String(e?.message ?? "").toLowerCase().includes("busy")) return;
+                          notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                        }
+                      }}
+                      style={[
+                        s.actionBtnWide,
+                        { backgroundColor: UI.btnNeutral, opacity: (!rid || pdfBusy || screenLock) ? 0.6 : 1 },
+                      ]}
+                    >
+                      <Text style={s.actionText}>{pdfBusy ? "PDFтАж" : "PDF"}</Text>
+                    </Pressable>
+                  );
+                })()}
+
+                <View style={s.sp8} />
+
+                {/* Excel тАФ CENTER */}
+                <Pressable
+                  disabled={screenLock}
+                  onPress={() => {
+                    if (screenLock) return;
+                    exportRequestExcel(sheetRequest);
+                  }}
+                  style={[
+                    s.actionBtnWide,
+                    { backgroundColor: UI.btnNeutral, opacity: screenLock ? 0.6 : 1 },
+                  ]}
+                >
+                  <Text style={s.actionText}>Excel</Text>
+                </Pressable>
+
+                <View style={s.sp8} />
+
+                {/* тЬЕ Approve/Send тАФ RIGHT */}
+                {(() => {
+                  const disabled =
+                    screenLock ||
+                    reqDeleteId === sheetRequest.request_id ||
+                    reqSendId === sheetRequest.request_id ||
+                    (sheetRequest.items?.length ?? 0) === 0;
+
+                  return (
+                    <View style={s.actionBtnSquare}>
+                      <SendPrimaryButton
+                        variant="green"
+                        disabled={disabled}
+                        loading={reqSendId === sheetRequest.request_id}
+                        onPress={async () => {
+                          if (disabled) return;
+
+                          setReqSendId(sheetRequest.request_id);
+                          try {
+                            const reqId = toFilterId(sheetRequest.request_id);
+                            if (reqId == null) throw new Error("request_id ╨┐╤Г╤Б╤В╨╛╨╣");
+
+                            const reqIdStr = String(reqId);
+
+                            const updItems = await supabase
+                              .from("request_items")
+                              .update({ status: "╨Ъ ╨╖╨░╨║╤Г╨┐╨║╨╡" })
+                              .eq("request_id", reqIdStr)
+                              .neq("status", "╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛");
+                            if (updItems.error) throw updItems.error;
+
+                            const updReq = await supabase
+                              .from("requests")
+                              .update({ status: "╨Ъ ╨╖╨░╨║╤Г╨┐╨║╨╡" })
+                              .eq("id", reqIdStr);
+                            if (updReq.error) throw updReq.error;
+
+                            setRows(prev => prev.filter(r => r.request_id !== sheetRequest.request_id));
+                            await fetchProps();
+
+                            closeSheet();
+                            showSuccess(`╨Ч╨░╤П╨▓╨║╨░ ${labelForRequest(sheetRequest.request_id)} ╤Г╤В╨▓╨╡╤А╨╢╨┤╨╡╨╜╨░ ╨╕ ╨╛╤В╨┐╤А╨░╨▓╨╗╨╡╨╜╨░ ╤Б╨╜╨░╨▒╨╢╨╡╨╜╤Ж╤Г`);
+                          } catch (e: any) {
+                            notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                          } finally {
+                            setReqSendId(null);
+                          }
+                        }}
+                      />
+                    </View>
+                  );
+                })()}
+              </View>
+            </View>
+          ) : null}
+
+          {/* ===== PROPOSAL (╤Б╨╜╨░╨▒╨╢╨╡╨╜╨╡╤Ж) ===== */}
+          {sheetKind === 'proposal' && sheetProposalId ? (
+            <View style={{ flex: 1, minHeight: 0 }}>
+              {(() => {
+                const pidStr = String(sheetProposalId);
+                const key = pidStr;
+                const loaded = !!loadedByProp[key];
+                const items = itemsByProp[key] || [];
+
+                const isEmptyProposal = loaded && (items?.length ?? 0) === 0;
+                const approveDisabled =
+                  screenLock ||
+                  propApproveId === pidStr ||
+                  propReturnId === pidStr ||
+                  !loaded ||
+                  isEmptyProposal;
+
+                const pretty = String(propsHeads.find(x => String(x.id) === pidStr)?.pretty ?? '').trim();
+
+                const totalSum = (items || []).reduce((acc, it) => {
+                  const pr = Number((it as any).price ?? 0);
+                  const q = Number((it as any).total_qty ?? 0);
+                  return acc + pr * q;
+                }, 0);
+
+
+                if (!loaded) return <Text style={{ opacity: 0.7, color: UI.sub }}>╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╤Б╨╛╤Б╤В╨░╨▓тАж</Text>;
+                if (!items.length) {
+                  return (
+                    <Text style={{ opacity: 0.75, color: UI.sub }}>
+                      ╨б╨╛╤Б╤В╨░╨▓ ╨┐╤Г╤Б╤В тАФ ╤Г╤В╨▓╨╡╤А╨┤╨╕╤В╤М ╨╜╨╡╨╗╤М╨╖╤П
+                    </Text>
+                  );
+                }
+                return (
+                  <>
+                    {/* ===== REQUEST CONTEXT (╨┤╨╗╤П ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П) ===== */}
+                    {(() => {
+                      // тЬЕ 0) ╨б╨░╨╝╤Л╨╣ ╨╗╤Г╤З╤И╨╕╨╣ ╨╕╤Б╤В╨╛╤З╨╜╨╕╨║ тАФ request_items.note (╨║╨░╨║ ╤Г ╨┐╤А╨╛╤А╨░╨▒╨░)
+                      const firstReqItemId =
+                        (itemsByProp[pidStr] || items || [])
+                          .map(x => String(x?.request_item_id ?? "").trim())
+                          .find(Boolean) || "";
+
+                      const headerNote = firstReqItemId ? String(reqItemNoteByIdRef.current?.[firstReqItemId] ?? "").trim() : "";
+
+                      if (headerNote) {
+                        const lines = headerNote
+                          .split(";")
+                          .map(x => x.trim())
+                          .filter(Boolean)
+                          .slice(0, 4);
+
+                        if (lines.length) {
+                          return (
+                            <View style={s.reqNoteBox}>
+                              {lines.map((t, idx) => (
+                                <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
+                                  {t}
+                                </Text>
+                              ))}
+                            </View>
+                          );
+                        }
+                      }
+
+                      // тЬЕ 1) ╨Т╤В╨╛╤А╨╛╨╣ ╨▓╨░╤А╨╕╨░╨╜╤В тАФ requests.note/comment (╨╡╤Б╨╗╨╕ ╨▓╨┤╤А╤Г╨│ ╨╡╤Б╤В╤М)
+                      const reqIds = propReqIdsByPropRef.current?.[pidStr] || [];
+                      if (!reqIds.length) return null;
+
+                      const firstReqId = reqIds[0];
+                      const meta = reqMetaByIdRef.current?.[firstReqId];
+
+                      const human =
+                        String(meta?.note ?? "").trim() ||
+                        String(meta?.comment ?? "").trim();
+
+                      if (human) {
+                        const lines = human
+                          .split(";")
+                          .map(x => x.trim())
+                          .filter(Boolean)
+                          .slice(0, 4);
+
+                        if (lines.length) {
+                          return (
+                            <View style={s.reqNoteBox}>
+                              {lines.map((t, idx) => (
+                                <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
+                                  {t}
+                                </Text>
+                              ))}
+                            </View>
+                          );
+                        }
+                      }
+
+                      // тЬЕ 2) Fallback тАФ ╨║╨╛╨┤╤Л (╨║╨░╨║ ╨▒╤Л╨╗╨╛)
+                      const obj =
+                        String(meta?.object_name ?? "").trim() ||
+                        String(meta?.object ?? "").trim() ||
+                        (meta?.site_address_snapshot ? String(meta.site_address_snapshot).trim() : "");
+
+                      const lines: string[] = [];
+                      if (obj) lines.push(`╨Ю╨▒╤К╨╡╨║╤В: ${obj}`);
+                      if (meta?.level_code) lines.push(`╨н╤В╨░╨╢/╤Г╤А╨╛╨▓╨╡╨╜╤М: ${meta.level_code}`);
+                      if (meta?.system_code) lines.push(`╨б╨╕╤Б╤В╨╡╨╝╨░: ${meta.system_code}`);
+                      if (meta?.zone_code) lines.push(`╨Ч╨╛╨╜╨░: ${meta.zone_code}`);
+
+                      if (!lines.length) return null;
+
+                      return (
+                        <View style={s.reqNoteBox}>
+                          {lines.slice(0, 4).map((t, idx) => (
+                            <Text key={idx} style={s.reqNoteLine} numberOfLines={1}>
+                              {t}
+                            </Text>
+                          ))}
+                        </View>
+                      );
+                    })()}
+                    {(() => {
+                      const pidStr = String(sheetProposalId);
+                      const files = propAttByProp[pidStr] || [];
+                      const busyAtt = !!propAttBusyByProp[pidStr];
+
+                      return (
+                        <View style={{ marginTop: 6, marginBottom: 12 }}>
+                          <View style={{ flexDirection: "row", alignItems: "center", justifyContent: "space-between" }}>
+                            <Text style={{ color: UI.text, fontWeight: "900" }}>
+                              ╨Т╨╗╨╛╨╢╨╡╨╜╨╕╤П: {files.length}
+                            </Text>
+
+                            <Pressable
+                              disabled={busyAtt}
+                              onPress={() => void loadProposalAttachments(pidStr)}
+                              style={{
+                                paddingVertical: 6,
+                                paddingHorizontal: 10,
+                                borderRadius: 999,
+                                borderWidth: 1,
+                                borderColor: "rgba(255,255,255,0.18)",
+                                backgroundColor: "rgba(255,255,255,0.06)",
+                                opacity: busyAtt ? 0.6 : 1,
+                              }}
+                            >
+                              <Text style={{ color: UI.text, fontWeight: "900", fontSize: 12 }}>
+                                {busyAtt ? "тАж" : "╨Ю╨▒╨╜╨╛╨▓╨╕╤В╤М"}
+                              </Text>
+                            </Pressable>
+                          </View>
+
+                          {busyAtt ? (
+                            <Text style={{ color: UI.sub, fontWeight: "800", marginTop: 8 }}>
+                              ╨Ч╨░╨│╤А╤Г╨╢╨░╤О ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╤ПтАж
+                            </Text>
+                          ) : files.length === 0 ? (
+                            <Text style={{ color: UI.sub, fontWeight: "800", marginTop: 8 }}>
+                              ╨Э╨╡╤В ╨▓╨╗╨╛╨╢╨╡╨╜╨╕╨╣ (╨╗╨╕╨▒╨╛ ╨╜╨╡ ╨┐╤А╨╕╨║╤А╨╡╨┐╨╗╨╡╨╜╤Л, ╨╗╨╕╨▒╨╛ RLS ╨╜╨╡ ╨┐╤Г╤Б╨║╨░╨╡╤В).
+                            </Text>
+                          ) : (
+                            <View style={{ flexDirection: "row", flexWrap: "wrap", marginTop: 8 }}>
+                              {files.map((f, idx) => (
+                                <Pressable key={`${f.id}:${idx}`}
+                                  onPress={() => {
+                                    const url = String(f.url || "").trim();
+                                    if (!url) {
+                                      notifyInfo("╨Т╨╗╨╛╨╢╨╡╨╜╨╕╨╡", "URL ╨┐╤Г╤Б╤В╨╛╨╣");
+                                      return;
+                                    }
+                                    void openSignedUrlUniversal(url, String(f.file_name ?? "file"));
+                                  }}
+                                  style={{
+                                    paddingVertical: 8,
+                                    paddingHorizontal: 12,
+                                    borderRadius: 999,
+                                    borderWidth: 1,
+                                    borderColor: "rgba(255,255,255,0.18)",
+                                    backgroundColor: "rgba(255,255,255,0.06)",
+                                    marginRight: 8,
+                                    marginBottom: 8,
+                                  }}
+                                >
+                                  <Text style={{ color: UI.text, fontWeight: "900" }} numberOfLines={1}>
+                                    {f.group_key ? `${f.group_key}: ` : ""}{f.file_name}
+                                  </Text>
+                                </Pressable>
+
+                              ))}
+                            </View>
+                          )}
+                        </View>
+                      );
+                    })()}
+                    <FlatList
+                      data={items}
+                      keyExtractor={(it, idx) => `pi:${key}:${it.id}:${idx}`}
+                      contentContainerStyle={{ paddingBottom: 12 }}
+                      keyboardShouldPersistTaps="handled"
+                      nestedScrollEnabled
+                      scrollEnabled
+                      showsVerticalScrollIndicator={false}
+                      renderItem={({ item: it }) => (
+                        <View style={s.mobCard}>
+                          <View style={s.mobMain}>
+                            <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>
+                              <Text style={[s.mobTitle, { marginRight: 8 }]} numberOfLines={3}>
+                                {it.name_human}
+                              </Text>
+
+                              {it.item_kind ? (
+                                <View style={[s.kindPill, { marginTop: 4 }]}>
+                                  <Text style={s.kindPillText}>
+                                    {it.item_kind === 'material' ? '╨Ь╨░╤В╨╡╤А╨╕╨░╨╗'
+                                      : it.item_kind === 'work' ? '╨а╨░╨▒╨╛╤В╨░'
+                                        : it.item_kind === 'service' ? '╨г╤Б╨╗╤Г╨│╨░'
+                                          : it.item_kind}
+                                  </Text>
+                                </View>
+                              ) : null}
+                            </View>
+                            <Text style={s.mobMeta}>
+                              {`${it.total_qty} ${it.uom || ''}`.trim()}
+                              {it.price != null ? ` ┬╖ ╤Ж╨╡╨╜╨░ ${it.price}` : ''}
+                              {it.price != null ? ` ┬╖ ╤Б╤Г╨╝╨╝╨░ ${Math.round(Number(it.price) * Number(it.total_qty || 0))}` : ''}
+                              {it.app_code ? ` ┬╖ ${it.app_code}` : ''}
+                            </Text>
+                          </View>
+                          <View style={{ marginLeft: 10 }}>
+                            <RejectItemButton
+                              disabled={decidingId === pidStr || actingPropItemId === Number(it.id)}
+                              loading={actingPropItemId === Number(it.id)}
+                              onPress={async () => {
+                                try {
+                                  setDecidingId(pidStr);
+                                  setActingPropItemId(Number(it.id));
+
+                                  // тЬЕ ╨С╨╡╤А╤С╨╝ request_item_id ╨╢╨╡╨╗╨╡╨╖╨╜╨╛ ╨╕╨╖ ╨С╨Ф ╨┐╨╛ proposal_items.id
+                                  const q = await supabase
+                                    .from('proposal_items')
+                                    .select('request_item_id')
+                                    .eq('proposal_id', pidStr)
+                                    .eq('id', it.id) // it.id = proposal_items.id
+                                    .maybeSingle();
+
+                                  if (q.error) throw q.error;
+
+                                  const rid = String(q.data?.request_item_id || '').trim();
+                                  if (!rid) {
+                                    notifyError('╨Ю╤И╨╕╨▒╨║╨░', '╨Т ╤Б╤В╤А╨╛╨║╨╡ ╨┐╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤П ╨╜╨╡╤В request_item_id (╨▓ ╨▒╨░╨╖╨╡).');
+                                    return;
+                                  }
+
+                                  const beforeCount = (itemsByProp[pidStr] || items || []).length;
+                                  const isLast = beforeCount <= 1;
+
+                                  const payload = [{
+                                    request_item_id: rid,
+                                    decision: 'rejected',
+                                    comment: '╨Ю╤В╨║╨╗╨╛╨╜╨╡╨╜╨╛ ╨┤╨╕╤А╨╡╨║╤В╨╛╤А╨╛╨╝',
+                                  }];
+
+                                  const res = await supabase.rpc('director_decide_proposal_items', {
+                                    p_proposal_id: pidStr,
+                                    p_decisions: payload,
+                                    p_finalize: isLast,
+                                  });
+
+                                  if (res.error) throw res.error;
+
+                                  // ╨╗╨╛╨║╨░╨╗╤М╨╜╨╛ ╤Г╨▒╨╕╤А╨░╨╡╨╝ ╤Б╤В╤А╨╛╨║╤Г
+                                  setItemsByProp(prev => {
+                                    const before = prev[pidStr] || [];
+                                    const nextItems = before.filter(x => Number(x.id) !== Number(it.id));
+                                    return { ...prev, [pidStr]: nextItems };
+                                  });
+
+                                  if (isLast) {
+                                    await fetchProps();
+                                    closeSheet();
+                                  }
+                                } catch (e: any) {
+                                  notifyError('╨Ю╤И╨╕╨▒╨║╨░', e?.message ?? '╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╛╤В╨║╨╗╨╛╨╜╨╕╤В╤М ╨┐╨╛╨╖╨╕╤Ж╨╕╤О');
+                                } finally {
+                                  setActingPropItemId(null);
+                                  setDecidingId(null);
+                                }
+                              }}
+                            />
+                          </View>
+                        </View>
+                      )}
+                      ListFooterComponent={() => (
+                        <View style={{ paddingTop: 10, paddingBottom: 6, alignItems: 'flex-end' }}>
+                          <View
+                            style={{
+                              paddingVertical: 6,
+                              paddingHorizontal: 12,
+                              borderRadius: 999,
+                              backgroundColor: 'rgba(255,255,255,0.06)',
+                              borderWidth: 1,
+                              borderColor: 'rgba(255,255,255,0.12)',
+                            }}
+                          >
+                            <Text style={{ fontWeight: '900', color: UI.text, fontSize: 14 }}>
+                              ╨Ш╨в╨Ю╨У╨Ю: {Math.round(totalSum)}
+                            </Text>
+                          </View>
+                        </View>
+                      )}
+                    />
+                    {/* ===== PROPOSAL ACTIONS (PROD) ===== */}
+                    <View style={s.reqActionsBottom}>
+                      {/* тЬЕ Return/Delete тАФ LEFT */}
+                      <View style={s.actionBtnSquare}>
+                        <DeleteAllButton
+                          disabled={screenLock || propReturnId === pidStr || propApproveId === pidStr}
+                          loading={propReturnId === pidStr}
+                          accessibilityLabel="╨Т╨╡╤А╨╜╤Г╤В╤М/╨Ю╤В╨║╨╗╨╛╨╜╨╕╤В╤М"
+                          onPress={() => {
+                            if (screenLock) return;
+                            onDirectorReturn(pidStr);
+                          }}
+                        />
+                      </View>
+
+                      <View style={s.sp8} />
+
+                      {/* PDF тАФ CENTER */}
+                      {(() => {
+                        const pdfKey = `pdfshare:prop:${pidStr}`;
+                        const pdfBusy = busy.isBusy(pdfKey);
+
+                        return (
+                          <Pressable
+                            disabled={pdfBusy || screenLock}
+                            style={[
+                              s.actionBtnWide,
+                              { backgroundColor: UI.btnNeutral, opacity: (pdfBusy || screenLock) ? 0.6 : 1 },
+                            ]}
+                            onPress={async () => {
+                              if (pdfBusy || screenLock) return;
+                              if (pdfTapLockRef.current[pdfKey]) return;
+                              pdfTapLockRef.current[pdfKey] = true;
+
+                              try {
+                                await runPdfTop({
+                                  busy,
+                                  supabase,
+                                  key: pdfKey,
+                                  label: "╨У╨╛╤В╨╛╨▓╨╗╤О ╤Д╨░╨╣╨╗тАж",
+                                  mode: "share",
+                                  fileName: `╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡_${pidStr}`,
+                                  getRemoteUrl: async () => {
+                                    const { exportProposalPdf } = await import("../../src/lib/rik_api");
+                                    return await exportProposalPdf(pidStr as any, "share");
+                                  },
+                                });
+                              } catch (e: any) {
+                                if (String(e?.message ?? "").toLowerCase().includes("busy")) return;
+                                notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                              } finally {
+                                setTimeout(() => { pdfTapLockRef.current[pdfKey] = false; }, 450);
+                              }
+                            }}
+                          >
+                            <Text style={s.actionText}>{pdfBusy ? "PDFтАж" : "PDF"}</Text>
+                          </Pressable>
+                        );
+                      })()}
+
+                      <View style={s.sp8} />
+
+                      {/* Excel тАФ CENTER */}
+                      <Pressable
+                        disabled={screenLock}
+                        style={[
+                          s.actionBtnWide,
+                          { backgroundColor: UI.btnNeutral, opacity: screenLock ? 0.6 : 1 },
+                        ]}
+                        onPress={async () => {
+                          if (screenLock) return;
+
+                          try {
+                            if (Platform.OS !== "web") {
+                              notifyInfo("Excel", "Excel ╤Н╨║╤Б╨┐╨╛╤А╤В ╤Б╨╡╨╣╤З╨░╤Б ╤А╨╡╨░╨╗╨╕╨╖╨╛╨▓╨░╨╜ ╤В╨╛╨╗╤М╨║╨╛ ╨┤╨╗╤П Web-╨▓╨╡╤А╤Б╨╕╨╕.");
+                              return;
+                            }
+                            if (!items.length) {
+                              notifyInfo("Excel", "╨Э╨╡╤В ╤Б╤В╤А╨╛╨║ ╨┤╨╗╤П ╨▓╤Л╨│╤А╤Г╨╖╨║╨╕.");
+                              return;
+                            }
+
+                            const safe = (v: any) => (v == null ? "" : String(v).replace(/[\r\n]+/g, " ").trim());
+                            const title = (pretty || `PROPOSAL-${pidStr.slice(0, 8)}`).replace(/[^\w╨Р-╨п╨░-╤П0-9]/g, "_");
+                            const sheetName = title.slice(0, 31) || "╨Я╤А╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╨╡";
+
+                            const data: any[][] = [["тДЦ", "╨Э╨░╨╕╨╝╨╡╨╜╨╛╨▓╨░╨╜╨╕╨╡", "╨Ъ╨╛╨╗-╨▓╨╛", "╨Х╨┤. ╨╕╨╖╨╝.", "╨Я╤А╨╕╨╝╨╡╨╜╨╡╨╜╨╕╨╡"]];
+                            items.forEach((it, idx) =>
+                              data.push([idx + 1, safe(it.name_human), safe(it.total_qty), safe(it.uom), safe(it.app_code)])
+                            );
+
+                            const wb = XLSX.utils.book_new();
+                            const ws = XLSX.utils.aoa_to_sheet(data);
+                            XLSX.utils.book_append_sheet(wb, ws, sheetName);
+
+                            const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
+                            const blob = new Blob([wbout], {
+                              type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
+                            });
+
+                            const url = URL.createObjectURL(blob);
+                            const a = document.createElement("a");
+                            a.href = url;
+                            a.download = `${sheetName}.xlsx`;
+                            document.body.appendChild(a);
+                            a.click();
+                            document.body.removeChild(a);
+                            URL.revokeObjectURL(url);
+                          } catch (e: any) {
+                            notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                          }
+                        }}
+                      >
+                        <Text style={s.actionText}>Excel</Text>
+                      </Pressable>
+
+                      <View style={s.sp8} />
+
+                      {/* тЬЕ Approve тАФ RIGHT */}
+                      <View style={s.actionBtnSquare}>
+                        <SendPrimaryButton
+                          variant="green"
+                          disabled={approveDisabled}
+                          loading={propApproveId === pidStr}
+                          onPress={async () => {
+                            if (approveDisabled) return;
+
+                            try {
+                              setPropApproveId(pidStr);
+
+                              const { error } = await supabase.rpc("director_approve_min_auto", {
+                                p_proposal_id: pidStr,
+                                p_comment: null,
+                              });
+                              if (error) throw error;
+
+                              const rInc = await supabase.rpc("ensure_purchase_and_incoming_strict", {
+                                p_proposal_id: pidStr,
+                              });
+                              if ((rInc as any)?.error) throw (rInc as any).error;
+
+                              try {
+                                const purchaseId = String((rInc as any)?.data?.purchase_id ?? "").trim();
+                                if (purchaseId) {
+                                  const rW = await supabase.rpc("work_seed_from_purchase" as any, { p_purchase_id: purchaseId } as any);
+                                  if (rW.error) console.warn("[work_seed_from_purchase] error:", rW.error.message);
+                                }
+                              } catch { }
+
+                              const { error: accErr } = await supabase.rpc("proposal_send_to_accountant_min", {
+                                p_proposal_id: pidStr,
+                                p_invoice_number: null,
+                                p_invoice_date: null,
+                                p_invoice_amount: null,
+                                p_invoice_currency: "KGS",
+                              });
+                              if (accErr) throw accErr;
+
+                              await fetchProps();
+                              closeSheet();
+                              showSuccess("╨г╤В╨▓╨╡╤А╨╢╨┤╨╡╨╜╨╛ тЖТ ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А тЖТ ╤Б╨║╨╗╨░╨┤/╨┐╨╛╨┤╤А╤П╨┤╤З╨╕╨║╨╕");
+                            } catch (e: any) {
+                              notifyError("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╨╖╨░╨│╤А╤Г╨╖╨╕╤В╤М ╨╛╤В╤З╤С╤В");
+                            } finally {
+                              setPropApproveId(null);
+                            }
+                          }}
+                        />
+                      </View>
+                    </View>
+                  </>
+                );
+              })()}
+            </View>
+          ) : null}
+        </View>
+      </RNModal>
 
-          await fetchProps();
-          closeSheet();
-          showSuccess("╨г╤В╨▓╨╡╤А╨╢╨┤╨╡╨╜╨╛ тЖТ ╨▒╤Г╤Е╨│╨░╨╗╤В╨╡╤А тЖТ ╤Б╨║╨╗╨░╨┤/╨┐╨╛╨┤╤А╤П╨┤╤З╨╕╨║╨╕");
-        } catch (e: any) {
-          Alert.alert("╨Ю╤И╨╕╨▒╨║╨░", e?.message ?? "╨Э╨╡ ╤Г╨┤╨░╨╗╨╛╤Б╤М ╤Г╤В╨▓╨╡╤А╨┤╨╕╤В╤М");
-        } finally {
-          setPropApproveId(null);
-        }
-      }}
-    />
-  </View>
-</View>
-  </>
-      );
-    })()}
-  </View>
-) : null}
- </View>
-</RNModal> 
-    
-</View>
-);
+    </View>
+  );
 }
